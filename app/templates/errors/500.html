{% extends "base_confluence.html" %}

{% block title %}Server Error - Enterprise Wiki{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white text-center">
                <h1 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-3"></i>500 - Internal Server Error
                </h1>
            </div>
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-server fa-5x text-danger"></i>
                </div>

                <h2 class="mb-3">Oops! Something went wrong on our end.</h2>

                <p class="text-muted mb-4">
                    We're sorry, but something unexpected happened and we couldn't complete your request.
                    Our team has been notified and is working to fix this issue.
                </p>

                <!-- What happened -->
                <div class="row justify-content-center mb-4">
                    <div class="col-md-10">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-info-circle me-2"></i>What just happened?
                                </h5>
                                <div class="row text-start">
                                    <div class="col-md-6">
                                        <ul class="list-unstyled mb-0">
                                            <li><i class="fas fa-check text-success me-2"></i>The error has been logged</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Our team has been notified</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Your data is safe</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <ul class="list-unstyled mb-0">
                                            <li><i class="fas fa-clock text-warning me-2"></i>We're working on a fix</li>
                                            <li><i class="fas fa-sync text-info me-2"></i>Try refreshing in a moment</li>
                                            <li><i class="fas fa-life-ring text-primary me-2"></i>Contact support if needed</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Updates -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-heartbeat me-2"></i>System Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="status-item">
                                    <i class="fas fa-database fa-2x text-warning mb-2"></i>
                                    <h6>Database</h6>
                                    <span class="badge bg-warning">Checking...</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="status-item">
                                    <i class="fas fa-server fa-2x text-success mb-2"></i>
                                    <h6>Server</h6>
                                    <span class="badge bg-success">Online</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="status-item">
                                    <i class="fas fa-network-wired fa-2x text-info mb-2"></i>
                                    <h6>Network</h6>
                                    <span class="badge bg-info">Stable</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="status-item">
                                    <i class="fas fa-hdd fa-2x text-success mb-2"></i>
                                    <h6>Storage</h6>
                                    <span class="badge bg-success">Healthy</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-center gap-2 flex-wrap">
                    <button onclick="location.reload()" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-2"></i>Try Again
                    </button>
                    <a href="{{ url_for('wiki.index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-home me-2"></i>Go Home
                    </a>
                    <a href="javascript:history.back()" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Go Back
                    </button>
                    <button onclick="reportIssue()" class="btn btn-outline-info">
                        <i class="fas fa-bug me-2"></i>Report Issue
                    </button>
                </div>

                <!-- Auto-refresh notification -->
                <div class="alert alert-info mt-4" role="alert">
                    <i class="fas fa-clock me-2"></i>
                    <strong>Auto-refresh:</strong> This page will automatically check for recovery in
                    <span id="countdown">30</span> seconds.
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="cancelAutoRefresh()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Error Report -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bug me-2"></i>Error Report
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">Help us fix this issue by providing more details:</p>
                <form onsubmit="submitErrorReport(event)">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">What were you trying to do?</label>
                            <textarea class="form-control" name="action" rows="3" placeholder="e.g., Creating a new page, uploading a file, etc."></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Any additional details?</label>
                            <textarea class="form-control" name="details" rows="3" placeholder="Any other information that might help us diagnose the issue..."></textarea>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>Submit Report
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Debug Information -->
        {% if config.DEBUG %}
        <div class="card mt-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-code me-2"></i>Debug Information (Development Mode)
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Development Mode:</strong> Detailed error information is shown below.
                    This will be hidden in production.
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h6>Request Information</h6>
                        <p class="mb-2"><strong>URL:</strong> {{ request.url }}</p>
                        <p class="mb-2"><strong>Method:</strong> {{ request.method }}</p>
                        <p class="mb-2"><strong>Timestamp:</strong> {{ moment().format('YYYY-MM-DD HH:mm:ss') }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>User Information</h6>
                        <p class="mb-2"><strong>IP:</strong> {{ request.remote_addr }}</p>
                        <p class="mb-2"><strong>User Agent:</strong> {{ request.user_agent }}</p>
                        <p class="mb-2"><strong>User:</strong> {{ current_user.username if current_user.is_authenticated else 'Anonymous' }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshTimer;
let countdown = 30;

// Start auto-refresh countdown
function startCountdown() {
    const countdownElement = document.getElementById('countdown');

    autoRefreshTimer = setInterval(() => {
        countdown--;
        countdownElement.textContent = countdown;

        if (countdown <= 0) {
            clearInterval(autoRefreshTimer);
            location.reload();
        }
    }, 1000);
}

// Cancel auto-refresh
function cancelAutoRefresh() {
    clearInterval(autoRefreshTimer);
    document.querySelector('.alert-info').style.display = 'none';
}

// Check system status
function checkSystemStatus() {
    fetch('/api/health')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'healthy') {
                showToast('System is recovering! Reloading...', 'success');
                setTimeout(() => location.reload(), 2000);
            }
        })
        .catch(error => {
            console.log('Health check failed:', error);
        });
}

// Report issue
function reportIssue() {
    const errorInfo = {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString(),
        userId: {{ current_user.id if current_user.is_authenticated else 'null' }}
    };

    const subject = encodeURIComponent('Server Error Report - Enterprise Wiki');
    const body = encodeURIComponent(
        `Hi Support Team,\n\nI encountered a server error.\n\n` +
        `Error URL: ${errorInfo.url}\n` +
        `Time: ${errorInfo.timestamp}\n` +
        `User: {{ current_user.username if current_user.is_authenticated else "Anonymous" }}\n` +
        `Browser: ${errorInfo.userAgent}\n\n` +
        `Please investigate this issue.\n\n` +
        `Thank you!`
    );

    window.location.href = `mailto:support@company.com?subject=${subject}&body=${body}`;
}

// Submit error report
function submitErrorReport(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const reportData = {
        action: formData.get('action'),
        details: formData.get('details'),
        url: window.location.href,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent
    };

    // Simulate sending report (in real app, this would be an actual API call)
    showToast('Thank you! Your error report has been submitted.', 'success');

    // Clear form
    event.target.reset();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    startCountdown();

    // Check system status every 10 seconds
    setInterval(checkSystemStatus, 10000);
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // R to retry/refresh
    if (e.key === 'r' && !e.ctrlKey && !e.metaKey) {
        location.reload();
    }

    // H for home
    if (e.key === 'h' && !e.ctrlKey && !e.metaKey) {
        window.location.href = '{{ url_for("wiki.index") }}';
    }

    // B for back
    if (e.key === 'b' && !e.ctrlKey && !e.metaKey) {
        history.back();
    }

    // E to report error
    if (e.key === 'e' && !e.ctrlKey && !e.metaKey) {
        reportIssue();
    }
});

// Easter egg: Try to fix with magic
let magicAttempts = 0;
document.addEventListener('keydown', function(e) {
    if (e.key === 'f' && e.ctrlKey && e.shiftKey) {
        magicAttempts++;

        if (magicAttempts === 3) {
            document.querySelector('.fa-server').classList.add('fa-magic');
            showToast('🪄 Attempting magical fix...', 'info');

            setTimeout(() => {
                showToast('Magic failed! Try a normal refresh instead.', 'warning');
                document.querySelector('.fa-server').classList.remove('fa-magic');
            }, 2000);
        }
    }
});

// Show random encouraging messages
const encouragingMessages = [
    "Don't worry, these things happen!",
    "Our team is on it!",
    "Technical difficulties are temporary!",
    "Stay positive, we'll fix this!",
    "Every error makes us stronger!"
];

function showEncouragingMessage() {
    const message = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
    showToast(message, 'info', 3000);
}

// Show encouraging message every 15 seconds
setInterval(showEncouragingMessage, 15000);
</script>

<style>
.card.border-danger {
    border-width: 2px;
}

.fa-server.fa-5x {
    animation: shake 2s infinite;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.status-item {
    transition: transform 0.2s ease;
}

.status-item:hover {
    transform: translateY(-2px);
}

#countdown {
    font-weight: bold;
    color: #007bff;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.fa-magic {
    animation: magic 1s infinite;
}

@keyframes magic {
    0%, 100% { color: #dc3545; }
    50% { color: #ffc107; }
}
</style>
{% endblock %}