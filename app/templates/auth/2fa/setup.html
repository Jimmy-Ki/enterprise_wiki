{% extends "base_confluence.html" %}

{% block title %}设置双因素认证 - {{ config.WIKI_TITLE }}{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <!-- Logo and Title -->
        <div class="auth-header text-center">
            <div class="auth-logo">
                <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
            </div>
            <h1 class="auth-title">设置双因素认证</h1>
            <p class="auth-subtitle">增强您的账户安全性</p>
        </div>

        <!-- Setup Instructions -->
        <div class="alert alert-info" role="alert">
            <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>设置步骤</h6>
            <ol class="mb-0">
                <li>下载 Microsoft Authenticator 或 Google Authenticator 应用</li>
                <li>扫描下方二维码或手动输入密钥</li>
                <li>输入应用显示的6位验证码</li>
                <li>保存备用恢复码以备不时之需</li>
            </ol>
            <div class="mt-2 pt-2 border-top">
                <small class="text-muted">
                    <i class="fas fa-lightbulb me-1"></i>
                    <strong>兼容性说明：</strong>本系统生成的密钥兼容所有主流认证器应用。如果扫码失败，请点击"重新生成密钥"按钮获取新的兼容密钥。
                </small>
            </div>
        </div>

        <!-- QR Code Display -->
        {% if qr_code %}
        <div class="text-center mb-4">
            <div class="qr-code-container d-inline-block p-3 bg-white rounded shadow-sm">
                <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code" class="img-fluid">
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="regenerateSecret()">
                    <i class="fas fa-sync-alt me-1"></i>重新生成密钥
                </button>
                <small class="d-block text-muted mt-1">如果扫码失败，请点击重新生成兼容的密钥</small>
            </div>
        </div>
        {% endif %}

        <!-- Secret Key -->
        {% if secret %}
        <div class="mb-4">
            <label class="form-label fw-bold">手动输入密钥（如果无法扫描二维码）：</label>
            <div class="input-group">
                <input type="text" class="form-control font-monospace" value="{{ secret }}" readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="copySecret()">
                    <i class="fas fa-copy"></i> 复制
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Verification Form -->
        <div class="auth-form">
            <form method="POST">
                {{ form.hidden_tag() }}

                <div class="mb-3">
                    <label for="verification_code" class="form-label fw-bold">验证码</label>
                    {{ form.verification_code(class="form-control form-control-lg text-center",
                           placeholder="000000",
                           pattern="[0-9]{6}",
                           maxlength="6",
                           autocomplete="one-time-code",
                           autofocus=True) }}
                    {% if form.verification_code.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.verification_code.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">请输入认证器应用中的6位数字</div>
                </div>

                <button type="submit" class="btn-wiki btn-primary w-100 mb-3">
                    <i class="fas fa-check me-2"></i>启用双因素认证
                </button>
            </form>
        </div>

        <!-- Links -->
        <div class="auth-links">
            <div class="text-center">
                <a href="{{ url_for('user.profile') }}" class="auth-link">
                    <i class="fas fa-arrow-left me-1"></i>返回个人资料
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copySecret() {
    // Try to get the current secret value (either from template or from dynamic updates)
    let secretInput = document.querySelector('input[value="{{ secret }}"]');
    if (!secretInput) {
        // Fallback: find the first input that looks like a secret
        secretInput = document.querySelector('input[readonly][class*="font-monospace"]');
    }

    if (!secretInput) {
        showToast('无法找到密钥', 'error');
        return;
    }

    secretInput.select();
    secretInput.setSelectionRange(0, 99999); // For mobile devices

    try {
        navigator.clipboard.writeText(secretInput.value).then(() => {
            // Show success message
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(() => {
            // Fallback for older browsers
            document.execCommand('copy');
            showToast('密钥已复制', 'success');
        });
    } catch (err) {
        showToast('复制失败', 'error');
    }

// Regenerate secret function
function regenerateSecret() {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;

    // Show loading state
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>生成中...';
    btn.disabled = true;

    fetch('/2fa/api/qrcode')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update QR code
                const qrImg = document.querySelector('.qr-code-container img');
                qrImg.src = `data:image/png;base64,${data.qr_code}`;

                // Update secret input
                const secretInput = document.querySelector('input[value="{{ secret }}"]');
                if (secretInput) {
                    secretInput.value = data.secret;
                }

                // Update copy button
                const copyBtn = document.querySelector('button[onclick="copySecret()"]');
                if (copyBtn) {
                    // Reset copy button state
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> 复制';
                    copyBtn.classList.remove('btn-success');
                    copyBtn.classList.add('btn-outline-secondary');
                }

                // Update page template variable reference for copySecret function
                window.currentSecret = data.secret;

                // Show success message
                showToast('新密钥已生成，请重新扫描二维码', 'success');
            } else {
                showToast('生成新密钥失败', 'error');
            }
        })
        .catch(error => {
            console.error('Error regenerating secret:', error);
            showToast('生成新密钥失败', 'error');
        })
        .finally(() => {
            // Restore button state
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
}

// Auto-focus verification code input
document.addEventListener('DOMContentLoaded', function() {
    const codeInput = document.getElementById('verification_code');
    const form = document.querySelector('form');

    if (codeInput && form) {
        codeInput.focus();

        // Handle form submission properly
        form.addEventListener('submit', function(e) {
            const code = codeInput.value.trim();

            // Validate that we have exactly 6 digits
            if (code.length !== 6 || !/^\d{6}$/.test(code)) {
                e.preventDefault();

                // Show error message
                codeInput.classList.add('is-invalid');

                // Create or update error message
                let errorDiv = codeInput.parentNode.querySelector('.invalid-feedback');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback d-block';
                    codeInput.parentNode.appendChild(errorDiv);
                }
                errorDiv.textContent = '请输入6位数字验证码';

                return false;
            }

            // Remove any existing error states
            codeInput.classList.remove('is-invalid');
            const errorDiv = codeInput.parentNode.querySelector('.invalid-feedback');
            if (errorDiv) {
                errorDiv.remove();
            }

            // Allow form to submit normally
            return true;
        });

        // Visual feedback when 6 digits are entered
        codeInput.addEventListener('input', function(e) {
            // Remove any existing error state
            e.target.classList.remove('is-invalid');
            const errorDiv = e.target.parentNode.querySelector('.invalid-feedback');
            if (errorDiv) {
                errorDiv.remove();
            }

            // Add visual feedback
            if (e.target.value.length === 6) {
                e.target.classList.add('is-valid');
                document.querySelector('button[type="submit"]').classList.add('btn-success');
                document.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-check me-2"></i>验证并启用双因素认证';
            } else {
                e.target.classList.remove('is-valid');
                document.querySelector('button[type="submit"]').classList.remove('btn-success');
                document.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-check me-2"></i>启用双因素认证';
            }
        });

        // Also handle paste events
        codeInput.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = (e.clipboardData || window.clipboardData).getData('text');
            const digits = pastedData.replace(/\D/g, '').slice(0, 6);

            if (digits.length === 6) {
                e.target.value = digits;
                e.target.classList.add('is-valid');
                document.querySelector('button[type="submit"]').classList.add('btn-success');
                document.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-check me-2"></i>验证并启用双因素认证';
            } else {
                e.target.value = digits;
            }
        });
    }
});
</script>
{% endblock %}