{% extends "base.html" %}

{% block title %}Register - Enterprise Wiki{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header text-center bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-user-plus me-2"></i>Create Account
                </h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.username.label(class="form-label") }}
                                {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else "")) }}
                                {% if form.username.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.username.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Username must be unique and contain only letters, numbers, dots, and underscores.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.name.label(class="form-label") }}
                                {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.email.label(class="form-label") }}
                        {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else "")) }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.email.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">A confirmation email will be sent to this address.</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.password.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else "")) }}
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                {% if form.password.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.password.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Password must be at least 8 characters long.</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.password2.label(class="form-label") }}
                                {{ form.password2(class="form-control" + (" is-invalid" if form.password2.errors else "")) }}
                                {% if form.password2.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.password2.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Password Strength Indicator -->
                    <div class="mb-3">
                        <label class="form-label">Password Strength</label>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="form-text text-muted" id="passwordStrengthText">Enter a password to see its strength</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                            <label class="form-check-label" for="agreeTerms">
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms of Service</a> and
                                <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy Policy</a>
                            </label>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success" id="registerBtn" disabled>
                            <i class="fas fa-user-plus me-2"></i>Create Account
                        </button>
                    </div>
                </form>

                <hr class="my-4">

                <div class="text-center">
                    <p class="mb-0">
                        Already have an account?
                        <a href="{{ url_for('auth.login') }}" class="text-decoration-none">
                            Login here
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Terms Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terms of Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>1. Acceptance of Terms</h6>
                <p>By accessing and using this Enterprise Wiki, you accept and agree to be bound by the terms and provision of this agreement.</p>

                <h6>2. Use License</h6>
                <p>Permission is granted to temporarily access the materials (information and software) on Enterprise Wiki for personal, non-commercial transitory viewing only.</p>

                <h6>3. Disclaimer</h6>
                <p>The materials on Enterprise Wiki are provided on an 'as is' basis. Enterprise Wiki makes no warranties, expressed or implied, and hereby disclaims and negates all other warranties including without limitation, implied warranties or conditions of merchantability, fitness for a particular purpose, or non-infringement of intellectual property or other violation of rights.</p>

                <h6>4. User Content</h6>
                <p>Users are responsible for the content they post. Enterprise Wiki reserves the right to remove any content that violates these terms.</p>

                <h6>5. Privacy</h6>
                <p>Your privacy is important to us. Please review our Privacy Policy, which also governs the Site and informs users of our data collection practices.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Privacy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Privacy Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Information We Collect</h6>
                <p>We collect information you provide directly to us, such as when you create an account, update your profile, or contact us.</p>

                <h6>How We Use Your Information</h6>
                <p>We use the information we collect to provide, maintain, and improve our services, process transactions, and communicate with you.</p>

                <h6>Information Sharing</h6>
                <p>We do not sell, trade, or otherwise transfer your personal information to third parties without your consent, except as described in this policy.</p>

                <h6>Data Security</h6>
                <p>We implement appropriate security measures to protect your personal information against unauthorized access, alteration, disclosure, or destruction.</p>

                <h6>Your Rights</h6>
                <p>You have the right to access, update, or delete your personal information at any time through your account settings.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const password2Input = document.getElementById('password2');
    const togglePassword = document.getElementById('togglePassword');
    const agreeTerms = document.getElementById('agreeTerms');
    const registerBtn = document.getElementById('registerBtn');
    const passwordStrength = document.getElementById('passwordStrength');
    const passwordStrengthText = document.getElementById('passwordStrengthText');

    // Toggle password visibility
    togglePassword.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        const icon = this.querySelector('i');
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    });

    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = '';

        if (password.length >= 8) strength += 20;
        if (password.length >= 12) strength += 10;
        if (/[a-z]/.test(password)) strength += 20;
        if (/[A-Z]/.test(password)) strength += 20;
        if (/[0-9]/.test(password)) strength += 15;
        if (/[^a-zA-Z0-9]/.test(password)) strength += 15;

        if (strength < 30) {
            feedback = 'Weak password';
            passwordStrength.className = 'progress-bar bg-danger';
        } else if (strength < 60) {
            feedback = 'Fair password';
            passwordStrength.className = 'progress-bar bg-warning';
        } else if (strength < 80) {
            feedback = 'Good password';
            passwordStrength.className = 'progress-bar bg-info';
        } else {
            feedback = 'Strong password';
            passwordStrength.className = 'progress-bar bg-success';
        }

        passwordStrength.style.width = strength + '%';
        passwordStrengthText.textContent = feedback;
    }

    passwordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        validateForm();
    });

    password2Input.addEventListener('input', validateForm);
    agreeTerms.addEventListener('change', validateForm);

    function validateForm() {
        const password = passwordInput.value;
        const password2 = password2Input.value;
        const termsAgreed = agreeTerms.checked;

        const isValid = password.length >= 8 &&
                       password === password2 &&
                       termsAgreed &&
                       document.getElementById('username').value &&
                       document.getElementById('email').value &&
                       document.getElementById('name').value;

        registerBtn.disabled = !isValid;
    }

    // Form validation on submit
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const password = passwordInput.value;
        const password2 = password2Input.value;

        if (password !== password2) {
            e.preventDefault();
            showToast('Passwords do not match', 'danger');
            return;
        }

        if (password.length < 8) {
            e.preventDefault();
            showToast('Password must be at least 8 characters long', 'danger');
            return;
        }

        if (!agreeTerms.checked) {
            e.preventDefault();
            showToast('You must agree to the terms and conditions', 'danger');
            return;
        }
    });
});
</script>
{% endblock %}