{% extends "admin/admin_base_unified.html" %}

{% block title %}用户管理 - 管理控制台{% endblock %}

{% set page_title = "用户管理" %}
{% set page_subtitle = "管理系统用户账户和权限设置" %}
{% set page_icon = "fas fa-users" %}

{% block admin_content %}
<!-- 筛选和操作工具栏 -->
<div class="admin-card">
    <div class="admin-card-body">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                <div>
                    <label style="display: block; font-size: 12px; color: var(--admin-text-secondary); margin-bottom: 4px;">角色筛选</label>
                    <select class="admin-form-select" style="width: 150px;"
                            onchange="window.location.href='{{ url_for('admin.users') }}?role=' + this.value">
                        <option value="">所有角色</option>
                        {% for role in roles %}
                        <option value="{{ role.name }}" {{ 'selected' if role_filter == role.name }}>{{ role.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label style="display: block; font-size: 12px; color: var(--admin-text-secondary); margin-bottom: 4px;">状态筛选</label>
                    <select class="admin-form-select" style="width: 150px;"
                            onchange="window.location.href='{{ url_for('admin.users') }}?status=' + this.value">
                        <option value="">所有状态</option>
                        <option value="active" {{ 'selected' if status_filter == 'active' }}>活跃用户</option>
                        <option value="inactive" {{ 'selected' if status_filter == 'inactive' }}>非活跃用户</option>
                        <option value="unconfirmed" {{ 'selected' if status_filter == 'unconfirmed' }}>未确认用户</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="text-align: right;">
                    <div style="font-size: 12px; color: var(--admin-text-secondary);">用户总数</div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--admin-text);">{{ users.total }}</div>
                </div>
                <a href="{{ url_for('admin.create_user') }}" class="admin-btn primary">
                    <i class="fas fa-user-plus"></i>
                    创建用户
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 用户列表 -->
<div class="admin-card">
    <div class="admin-card-header">
        <h5 class="admin-card-title">
            <i class="fas fa-list"></i>
            用户列表
        </h5>
    </div>
    <div class="admin-card-body" style="padding: 0;">
        {% if users.items %}
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>用户信息</th>
                        <th>角色</th>
                        <th>状态</th>
                        <th>注册时间</th>
                        <th>最后活动</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users.items %}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <img src="{{ user.gravatar(40) }}" alt="Avatar"
                                     style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 500; color: var(--admin-text);">{{ user.username }}</div>
                                    <div style="font-size: 13px; color: var(--admin-text-secondary);">{{ user.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if user.role %}
                            <span class="admin-badge info">{{ user.role.name }}</span>
                            {% else %}
                            <span style="color: var(--admin-text-secondary); font-size: 13px;">未分配</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_active %}
                                {% if user.confirmed %}
                                <span class="admin-badge success">活跃</span>
                                {% else %}
                                <span class="admin-badge warning">未确认</span>
                                {% endif %}
                            {% else %}
                            <span class="admin-badge danger">禁用</span>
                            {% endif %}
                        </td>
                        <td style="font-size: 14px;">{{ user.member_since.strftime('%Y-%m-%d') }}</td>
                        <td style="font-size: 14px;">
                            {{ user.last_seen.strftime('%Y-%m-%d %H:%M') if user.last_seen else '从未登录' }}
                        </td>
                        <td>
                            <div class="admin-actions">
                                <a href="{{ url_for('admin.user_detail', user_id=user.id) }}"
                                   class="admin-btn sm" title="查看详情">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('admin.edit_user', user_id=user.id) }}"
                                   class="admin-btn sm" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% if user.id != current_user.id %}
                                <form method="POST" action="{{ url_for('admin.toggle_user_status', user_id=user.id) }}"
                                      style="display: inline;">
                                    <button type="submit" class="admin-btn sm {{ 'warning' if user.is_active else 'success' }}"
                                            title="{{ '禁用' if user.is_active else '启用' }}"
                                            onclick="return confirm('确定要{{ '禁用' if user.is_active else '启用' }}这个用户吗？')">
                                        <i class="fas {{ 'fa-ban' if user.is_active else 'fa-check' }}"></i>
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}"
                                      style="display: inline;">
                                    <button type="submit" class="admin-btn sm danger" title="删除"
                                            onclick="return confirm('确定要删除这个用户吗？此操作不可恢复！')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-users"></i>
            <h5>暂无用户数据</h5>
            <p>系统中还没有注册用户</p>
            <a href="{{ url_for('admin.create_user') }}" class="admin-btn primary">
                <i class="fas fa-user-plus me-2"></i>创建第一个用户
            </a>
        </div>
        {% endif %}
    </div>

    <!-- 分页 -->
    {% if users.pages > 1 %}
    <div class="admin-pagination">
        {% if users.has_prev %}
        <a href="{{ url_for('admin.users', page=users.prev_num, role=role_filter, status=status_filter) }}">
            <i class="fas fa-chevron-left"></i>
        </a>
        {% endif %}

        {% for page_num in users.iter_pages() %}
            {% if page_num %}
                {% if page_num != users.page %}
                <a href="{{ url_for('admin.users', page=page_num, role=role_filter, status=status_filter) }}">{{ page_num }}</a>
                {% else %}
                <span class="active">{{ page_num }}</span>
                {% endif %}
            {% else %}
            <span class="disabled">...</span>
            {% endif %}
        {% endfor %}

        {% if users.has_next %}
        <a href="{{ url_for('admin.users', page=users.next_num, role=role_filter, status=status_filter) }}">
            <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- 用户统计信息 -->
{% if users.items %}
<div class="admin-card">
    <div class="admin-card-header">
        <h5 class="admin-card-title">
            <i class="fas fa-chart-bar"></i>
            用户统计信息
        </h5>
    </div>
    <div class="admin-card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px;">
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 600; color: var(--admin-primary);">{{ users.total }}</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary);">总用户数</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 600; color: var(--admin-success);">
                    {{ users.items | selectattr('is_active') | list | length }}
                </div>
                <div style="font-size: 14px; color: var(--admin-text-secondary);">活跃用户</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 600; color: var(--admin-warning);">
                    {{ users.items | selectattr('is_active') | rejectattr('is_active') | list | length }}
                </div>
                <div style="font-size: 14px; color: var(--admin-text-secondary);">非活跃用户</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 600; color: var(--admin-info);">{{ roles | length }}</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary);">角色数量</div>
            </div>
        </div>
    </div>
</div>

<!-- 批量操作 -->
<div class="admin-card">
    <div class="admin-card-header">
        <h5 class="admin-card-title">
            <i class="fas fa-tools"></i>
            批量操作
        </h5>
    </div>
    <div class="admin-card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div>
                <h6 style="font-size: 14px; color: var(--admin-text); margin-bottom: 12px;">导出用户数据</h6>
                <div style="display: flex; gap: 8px;">
                    <button class="admin-btn sm" onclick="alert('CSV导出功能开发中...')">
                        <i class="fas fa-file-csv"></i>
                        导出 CSV
                    </button>
                    <button class="admin-btn sm" onclick="alert('Excel导出功能开发中...')">
                        <i class="fas fa-file-excel"></i>
                        导出 Excel
                    </button>
                </div>
            </div>
            <div>
                <h6 style="font-size: 14px; color: var(--admin-text); margin-bottom: 12px;">用户管理</h6>
                <div style="display: flex; gap: 8px;">
                    <button class="admin-btn sm warning" onclick="confirmCleanup()">
                        <i class="fas fa-broom"></i>
                        清理未确认用户
                    </button>
                    <button class="admin-btn sm info" onclick="alert('邮件发送功能开发中...')">
                        <i class="fas fa-envelope"></i>
                        发送提醒邮件
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function confirmCleanup() {
    if (confirm('确定要清理所有未确认的用户吗？此操作不可恢复！')) {
        alert('清理功能开发中...');
    }
}

// 添加表格行点击效果
document.querySelectorAll('tbody tr').forEach(row => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', function(e) {
        // 如果点击的是操作按钮或链接，不触发行点击
        if (e.target.closest('a, button, form')) {
            return;
        }

        const detailLink = this.querySelector('a[href*="user_detail"]');
        if (detailLink) {
            window.location.href = detailLink.href;
        }
    });
});
</script>
{% endblock %}