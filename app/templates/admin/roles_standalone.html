{% extends "admin/admin_base_standalone.html" %}

{% block title %}角色管理 - 管理控制台{% endblock %}

{% set page_title = "角色管理" %}
{% set page_subtitle = "管理系统角色和权限设置" %}
{% set page_icon = "fas fa-user-shield" %}

{% block admin_content %}
<!-- 操作工具栏 -->
<div class="admin-card">
    <div class="admin-card-body">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div>
                    <div style="font-size: 12px; color: var(--admin-text-secondary);">角色总数</div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--admin-text);">{{ roles | length }}</div>
                </div>
            </div>
            <a href="{{ url_for('admin.create_role') }}" class="admin-btn primary">
                <i class="fas fa-plus"></i>
                创建角色
            </a>
        </div>
    </div>
</div>

<!-- 角色列表 -->
{% if roles %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
    {% for role in roles %}
    <div class="admin-card">
        <div class="admin-card-header">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <h5 class="admin-card-title" style="margin: 0;">
                    <i class="fas fa-user-tag"></i>
                    {{ role.name }}
                </h5>
                {% if role.default %}
                <span class="admin-badge info">默认角色</span>
                {% endif %}
                {% if role.name == 'Administrator' %}
                <span class="admin-badge danger">管理员</span>
                {% endif %}
            </div>
        </div>
        <div class="admin-card-body">
            <div style="margin-bottom: 20px;">
                <h6 style="font-size: 14px; color: var(--admin-text); margin-bottom: 12px;">
                    权限列表
                </h6>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    {% if role.has_permission(Permission.FOLLOW) %}
                    <span class="admin-badge success">关注用户</span>
                    {% endif %}
                    {% if role.has_permission(Permission.COMMENT) %}
                    <span class="admin-badge success">发表评论</span>
                    {% endif %}
                    {% if role.has_permission(Permission.WRITE) %}
                    <span class="admin-badge success">创建内容</span>
                    {% endif %}
                    {% if role.has_permission(Permission.MODERATE) %}
                    <span class="admin-badge warning">内容审核</span>
                    {% endif %}
                    {% if role.has_permission(Permission.VIEW_PRIVATE) %}
                    <span class="admin-badge info">查看私密</span>
                    {% endif %}
                    {% if role.has_permission(Permission.EDIT_ALL) %}
                    <span class="admin-badge warning">编辑所有</span>
                    {% endif %}
                    {% if role.has_permission(Permission.DELETE_ALL) %}
                    <span class="admin-badge danger">删除所有</span>
                    {% endif %}
                    {% if role.has_permission(Permission.ADMIN) %}
                    <span class="admin-badge danger">系统管理</span>
                    {% endif %}
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                <div>
                    <div style="font-size: 12px; color: var(--admin-text-secondary); margin-bottom: 4px;">用户数量</div>
                    <div style="font-size: 16px; font-weight: 600; color: var(--admin-text);">
                        {{ role.users.count() }}
                    </div>
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--admin-text-secondary); margin-bottom: 4px;">角色标识</div>
                    <div style="font-size: 14px; color: var(--admin-text);">
                        ID: {{ role.id }}
                    </div>
                </div>
            </div>

            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--admin-border);">
                <div style="font-size: 13px; color: var(--admin-text-secondary);">
                    <i class="fas fa-users"></i>
                    {{ role.users.count() }} 个用户使用此角色
                </div>
                <div class="admin-actions">
                    <a href="{{ url_for('admin.edit_role', role_id=role.id) }}" class="admin-btn sm">
                        <i class="fas fa-edit"></i>
                        编辑
                    </a>
                    {% if not role.default and role.name != 'Administrator' and role.users.count() == 0 %}
                    <form method="POST" action="{{ url_for('admin.delete_role', role_id=role.id) }}" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="admin-btn sm danger" onclick="return confirm('确定要删除角色 {{ role.name }} 吗？')">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </form>
                    {% else %}
                    <span class="admin-badge neutral" style="opacity: 0.5; cursor: not-allowed;">
                        <i class="fas fa-ban"></i>
                        禁用删除
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="admin-empty-state">
    <i class="fas fa-user-shield"></i>
    <h5>暂无角色数据</h5>
    <p>系统中还没有创建任何角色</p>
    <a href="{{ url_for('admin.create_role') }}" class="admin-btn primary">
        <i class="fas fa-plus me-2"></i>创建第一个角色
    </a>
</div>
{% endif %}

<!-- 角色统计信息 -->
{% if roles %}
<div class="admin-card">
    <div class="admin-card-header">
        <h5 class="admin-card-title">
            <i class="fas fa-chart-bar"></i>
            角色统计信息
        </h5>
    </div>
    <div class="admin-card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px;">
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 600; color: var(--admin-primary);">{{ roles | length }}</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary); margin-top: 8px;">总角色数</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 600; color: var(--admin-success);">
                    {{ roles | selectattr('default') | list | length }}
                </div>
                <div style="font-size: 14px; color: var(--admin-text-secondary); margin-top: 8px;">默认角色</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 600; color: var(--admin-warning);">
                    {{ roles | rejectattr('default') | list | length }}
                </div>
                <div style="font-size: 14px; color: var(--admin-text-secondary); margin-top: 8px;">自定义角色</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 600; color: var(--admin-info);">
                    {% set user_count = 0 %}
                    {% for role in roles %}
                        {% set user_count = user_count + role.users.count() %}
                    {% endfor %}
                    {{ user_count }}
                </div>
                <div style="font-size: 14px; color: var(--admin-text-secondary); margin-top: 8px;">用户分配</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 权限说明 -->
<div class="admin-card">
    <div class="admin-card-header">
        <h5 class="admin-card-title">
            <i class="fas fa-info-circle"></i>
            权限说明
        </h5>
    </div>
    <div class="admin-card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div>
                <h6 style="font-size: 14px; font-weight: 600; color: var(--admin-text); margin-bottom: 12px;">
                    <i class="fas fa-user" style="color: var(--admin-success);"></i>
                    基础权限
                </h6>
                <div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px; color: var(--admin-text-secondary);">
                    <div><strong>关注用户：</strong>可以关注其他用户的活动</div>
                    <div><strong>发表评论：</strong>可以对页面进行评论</div>
                    <div><strong>创建内容：</strong>可以创建和编辑自己的页面</div>
                </div>
            </div>
            <div>
                <h6 style="font-size: 14px; font-weight: 600; color: var(--admin-text); margin-bottom: 12px;">
                    <i class="fas fa-shield-alt" style="color: var(--admin-warning);"></i>
                    管理权限
                </h6>
                <div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px; color: var(--admin-text-secondary);">
                    <div><strong>内容审核：</strong>可以管理和审核所有评论</div>
                    <div><strong>查看私密：</strong>可以查看私密页面和内容</div>
                    <div><strong>编辑所有：</strong>可以编辑系统中任何页面</div>
                    <div><strong>删除所有：</strong>可以删除系统中任何内容</div>
                </div>
            </div>
            <div>
                <h6 style="font-size: 14px; font-weight: 600; color: var(--admin-text); margin-bottom: 12px;">
                    <i class="fas fa-crown" style="color: var(--admin-danger);"></i>
                    系统权限
                </h6>
                <div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px; color: var(--admin-text-secondary);">
                    <div><strong>系统管理：</strong>拥有所有系统管理权限</div>
                    <div><strong>默认角色：</strong>新用户注册时自动分配</div>
                    <div><strong>管理员角色：</strong>系统最高权限角色</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 添加表格行点击效果
document.querySelectorAll('tbody tr').forEach(row => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', function(e) {
        // 如果点击的是操作按钮或链接，不触发行点击
        if (e.target.closest('a, button, form')) {
            return;
        }

        const editLink = this.querySelector('a[href*="edit_role"]');
        if (editLink) {
            window.location.href = editLink.href;
        }
    });
});
</script>
{% endblock %}