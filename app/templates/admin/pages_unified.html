{% extends "admin/admin_base_unified.html" %}

{% block title %}页面管理 - 管理控制台{% endblock %}

{% set page_title = "页面管理" %}
{% set page_subtitle = "管理Wiki页面内容和发布状态" %}
{% set page_icon = "fas fa-file-alt" %}

{% block admin_content %}
<!-- 筛选和操作工具栏 -->
<div class="admin-card">
    <div class="admin-card-body">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                <div>
                    <label style="display: block; font-size: 12px; color: var(--admin-text-secondary); margin-bottom: 4px;">状态筛选</label>
                    <select class="admin-form-select" style="width: 150px;"
                            onchange="window.location.href='{{ url_for('admin.pages') }}?status=' + this.value">
                        <option value="">所有状态</option>
                        <option value="published" {{ 'selected' if status_filter == 'published' }}>已发布</option>
                        <option value="draft" {{ 'selected' if status_filter == 'draft' }}>草稿</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-size: 12px; color: var(--admin-text-secondary); margin-bottom: 4px;">作者筛选</label>
                    <select class="admin-form-select" style="width: 150px;"
                            onchange="window.location.href='{{ url_for('admin.pages') }}?author=' + this.value">
                        <option value="">所有作者</option>
                        {% for author in authors %}
                        <option value="{{ author.id }}" {{ 'selected' if author_filter == author.id|string }}>{{ author.username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="text-align: right;">
                    <div style="font-size: 12px; color: var(--admin-text-secondary);">页面总数</div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--admin-text);">{{ pages.total }}</div>
                </div>
                <a href="{{ url_for('wiki.create_page') }}" class="admin-btn primary">
                    <i class="fas fa-plus"></i>
                    创建页面
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 页面列表 -->
<div class="admin-card">
    <div class="admin-card-header">
        <h5 class="admin-card-title">
            <i class="fas fa-list"></i>
            页面列表
        </h5>
    </div>
    <div class="admin-card-body" style="padding: 0;">
        {% if pages.items %}
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>页面标题</th>
                        <th>作者</th>
                        <th>分类</th>
                        <th>状态</th>
                        <th>浏览量</th>
                        <th>创建时间</th>
                        <th>最后更新</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for page in pages.items %}
                    <tr>
                        <td>
                            <div>
                                <div style="font-weight: 500; margin-bottom: 4px;">
                                    <a href="{{ url_for('wiki.view_page', slug=page.slug) }}"
                                       class="text-decoration-none" target="_blank">
                                        {{ page.title }}
                                    </a>
                                </div>
                                <div style="font-size: 12px; color: var(--admin-text-secondary);">
                                    {{ page.content[:100] | striptags }}{% if page.content|length > 100 %}...{% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <img src="{{ page.author.gravatar(24) }}" alt="Avatar"
                                     style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px;">
                                <span style="font-size: 14px;">{{ page.author.username if page.author else '未知' }}</span>
                            </div>
                        </td>
                        <td>
                            {% if page.category %}
                            <span class="admin-badge info">{{ page.category.name }}</span>
                            {% else %}
                            <span style="color: var(--admin-text-secondary); font-size: 13px;">未分类</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if page.is_published %}
                            <span class="admin-badge success">已发布</span>
                            {% else %}
                            <span class="admin-badge warning">草稿</span>
                            {% endif %}
                        </td>
                        <td style="font-size: 14px;">{{ page.view_count or 0 }}</td>
                        <td style="font-size: 14px;">{{ page.created_at.strftime('%Y-%m-%d') }}</td>
                        <td style="font-size: 14px;">{{ page.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div class="admin-actions">
                                <a href="{{ url_for('wiki.view_page', slug=page.slug) }}"
                                   class="admin-btn sm" title="查看页面" target="_blank">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('wiki.edit_page', page_id=page.id) }}"
                                   class="admin-btn sm" title="编辑页面">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="POST" action="{{ url_for('admin.toggle_page_status', page_id=page.id) }}"
                                      style="display: inline;">
                                    <button type="submit" class="admin-btn sm {{ 'warning' if page.is_published else 'success' }}"
                                            title="{{ '设为草稿' if page.is_published else '发布页面' }}">
                                        <i class="fas {{ 'fa-eye-slash' if page.is_published else 'fa-eye' }}"></i>
                                    </button>
                                </form>
                                <a href="{{ url_for('wiki.page_history', slug=page.slug) }}"
                                   class="admin-btn sm" title="查看历史">
                                    <i class="fas fa-history"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
            <i class="fas fa-file-alt"></i>
            <h5>暂无页面数据</h5>
            <p>系统中还没有创建任何页面</p>
            <a href="{{ url_for('wiki.create_page') }}" class="admin-btn primary">
                <i class="fas fa-plus me-2"></i>创建第一个页面
            </a>
        </div>
        {% endif %}
    </div>

    <!-- 分页 -->
    {% if pages.pages > 1 %}
    <div class="admin-pagination">
        {% if pages.has_prev %}
        <a href="{{ url_for('admin.pages', page=pages.prev_num, status=status_filter, author=author_filter) }}">
            <i class="fas fa-chevron-left"></i>
        </a>
        {% endif %}

        {% for page_num in pages.iter_pages() %}
            {% if page_num %}
                {% if page_num != pages.page %}
                <a href="{{ url_for('admin.pages', page=page_num, status=status_filter, author=author_filter) }}">{{ page_num }}</a>
                {% else %}
                <span class="active">{{ page_num }}</span>
                {% endif %}
            {% else %}
            <span class="disabled">...</span>
            {% endif %}
        {% endfor %}

        {% if pages.has_next %}
        <a href="{{ url_for('admin.pages', page=pages.next_num, status=status_filter, author=author_filter) }}">
            <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- 页面统计信息 -->
{% if pages.items %}
<div class="row">
    <div class="col-md-3">
        <div class="admin-card">
            <div class="admin-card-body" style="text-align: center;">
                <div style="font-size: 28px; font-weight: 600; color: var(--admin-primary);">{{ pages.total }}</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary); margin-top: 8px;">总页面数</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="admin-card">
            <div class="admin-card-body" style="text-align: center;">
                <div style="font-size: 28px; font-weight: 600; color: var(--admin-success);">
                    {{ pages.items | selectattr('is_published') | list | length }}
                </div>
                <div style="font-size: 14px; color: var(--admin-text-secondary); margin-top: 8px;">已发布页面</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="admin-card">
            <div class="admin-card-body" style="text-align: center;">
                <div style="font-size: 28px; font-weight: 600; color: var(--admin-warning);">
                    {{ pages.items | rejectattr('is_published') | list | length }}
                </div>
                <div style="font-size: 14px; color: var(--admin-text-secondary); margin-top: 8px;">草稿页面</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="admin-card">
            <div class="admin-card-body" style="text-align: center;">
                <div style="font-size: 28px; font-weight: 600; color: var(--admin-info);">{{ authors | length }}</div>
                <div style="font-size: 14px; color: var(--admin-text-secondary); margin-top: 8px;">内容作者</div>
            </div>
        </div>
    </div>
</div>

<!-- 批量操作 -->
<div class="admin-card">
    <div class="admin-card-header">
        <h5 class="admin-card-title">
            <i class="fas fa-tools"></i>
            批量操作
        </h5>
    </div>
    <div class="admin-card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div>
                <h6 style="font-size: 14px; color: var(--admin-text); margin-bottom: 12px;">页面操作</h6>
                <div style="display: flex; gap: 8px;">
                    <button class="admin-btn sm" onclick="confirmBatchPublish()">
                        <i class="fas fa-check"></i>
                        批量发布
                    </button>
                    <button class="admin-btn sm warning" onclick="confirmBatchDraft()">
                        <i class="fas fa-eye-slash"></i>
                        批量设为草稿
                    </button>
                </div>
            </div>
            <div>
                <h6 style="font-size: 14px; color: var(--admin-text); margin-bottom: 12px;">导出功能</h6>
                <div style="display: flex; gap: 8px;">
                    <button class="admin-btn sm" onclick="alert('PDF导出功能开发中...')">
                        <i class="fas fa-file-pdf"></i>
                        导出 PDF
                    </button>
                    <button class="admin-btn sm" onclick="alert('备份功能开发中...')">
                        <i class="fas fa-archive"></i>
                        备份内容
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function confirmBatchPublish() {
    if (confirm('确定要发布所有选中的草稿页面吗？')) {
        alert('批量发布功能开发中...');
    }
}

function confirmBatchDraft() {
    if (confirm('确定要将所有已发布页面设为草稿吗？')) {
        alert('批量操作功能开发中...');
    }
}

// 添加表格行点击效果
document.querySelectorAll('tbody tr').forEach(row => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', function(e) {
        // 如果点击的是操作按钮或链接，不触发行点击
        if (e.target.closest('a, button, form')) {
            return;
        }

        const viewLink = this.querySelector('a[href*="view_page"]');
        if (viewLink) {
            window.open(viewLink.href, '_blank');
        }
    });
});
</script>
{% endblock %}