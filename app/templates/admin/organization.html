{% extends "base_confluence.html" %}

{% block title %}组织架构管理{% endblock %}

{% block extra_css %}
<style>
    .organization-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: calc(100vh - 60px);
    }

    .org-header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .org-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .org-description {
        color: #666;
        font-size: 14px;
    }

    .org-stats {
        display: flex;
        gap: 20px;
        margin-top: 15px;
    }

    .stat-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        min-width: 120px;
    }

    .stat-number {
        font-size: 24px;
        font-weight: 600;
        color: var(--primary-color);
    }

    .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }

    .org-tree-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        min-height: 600px;
        position: relative;
    }

    #orgTree {
        width: 100%;
        height: 600px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: #fafafa;
    }

    .node-info-panel {
        position: absolute;
        right: 20px;
        top: 20px;
        width: 300px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
        z-index: 1000;
    }

    .node-info-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e0e0e0;
    }

    .node-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 24px;
        color: #666;
    }

    .node-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .node-basic-info h3 {
        margin: 0 0 5px 0;
        font-size: 18px;
        color: #333;
    }

    .node-basic-info .username {
        color: #666;
        font-size: 14px;
        margin-bottom: 5px;
    }

    .node-basic-info .role {
        color: var(--primary-color);
        font-size: 12px;
        font-weight: 500;
    }

    .info-section {
        margin-bottom: 20px;
    }

    .info-section h4 {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        color: #666;
    }

    .info-value {
        color: #333;
        font-weight: 500;
    }

    .close-panel {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #f5f5f5;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: #666;
    }

    .close-panel:hover {
        background: #e0e0e0;
    }

    .toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .toolbar button {
        padding: 8px 16px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }

    .toolbar button:hover {
        background: #f8f9fa;
        border-color: var(--primary-color);
    }

    .toolbar button.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .zoom-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 5px;
        background: white;
        padding: 5px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .zoom-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .zoom-btn:hover {
        background: #f0f0f0;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .error-message {
        text-align: center;
        padding: 40px;
        color: #dc3545;
    }

    .org-subnav {
        display: flex;
        background: white;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 0;
        overflow: hidden;
    }

    .subnav-link {
        flex: 1;
        padding: 16px 20px;
        text-decoration: none;
        color: #666;
        font-weight: 500;
        text-align: center;
        border-right: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .subnav-link:last-child {
        border-right: none;
    }

    .subnav-link:hover {
        background: #f8f9fa;
        color: var(--primary-color);
        text-decoration: none;
    }

    .subnav-link.active {
        background: var(--primary-color);
        color: white;
    }

    .subnav-link i {
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="organization-container">
    <div class="org-header">
        <h1 class="org-title">组织架构管理</h1>
        <p class="org-description">查看和管理公司的组织架构，包括部门、项目和工作区的人员分配</p>

        <div class="org-stats">
            <div class="stat-item">
                <div class="stat-number" id="totalDepts">0</div>
                <div class="stat-label">部门总数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalEmployees">0</div>
                <div class="stat-label">员工总数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalProjects">0</div>
                <div class="stat-label">项目总数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalWorkspaces">0</div>
                <div class="stat-label">工作区总数</div>
            </div>
        </div>
    </div>

    <div class="org-subnav">
        <a href="{{ url_for('organization.admin_organization') }}" class="subnav-link active">
            <i class="fas fa-sitemap"></i>
            组织架构总览
        </a>
        <a href="{{ url_for('organization.admin_departments') }}" class="subnav-link">
            <i class="fas fa-building"></i>
            部门管理
        </a>
        <a href="{{ url_for('organization.admin_projects') }}" class="subnav-link">
            <i class="fas fa-project-diagram"></i>
            项目管理
        </a>
        <a href="{{ url_for('organization.admin_workspaces') }}" class="subnav-link">
            <i class="fas fa-th-large"></i>
            工作区管理
        </a>
        <a href="{{ url_for('organization.admin_permissions') }}" class="subnav-link">
            <i class="fas fa-shield-alt"></i>
            权限管理
        </a>
    </div>

    <div class="toolbar">
        <button class="active" id="viewDept">部门视图</button>
        <button id="viewProject">项目视图</button>
        <button id="viewHierarchy">层级视图</button>
        <button id="expandAll">展开全部</button>
        <button id="collapseAll">折叠全部</button>
        <button id="refreshData">刷新数据</button>
    </div>

    <div class="org-tree-container">
        <div id="orgTree">
            <div class="loading">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>正在加载组织架构...</p>
            </div>
        </div>

        <div class="node-info-panel" id="nodeInfoPanel">
            <button class="close-panel" onclick="closeNodeInfo()">×</button>
            <div class="node-info-header">
                <div class="node-avatar" id="nodeAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="node-basic-info">
                    <h3 id="nodeName">--</h3>
                    <div class="username" id="nodeUsername">--</div>
                    <div class="role" id="nodeRole">--</div>
                </div>
            </div>

            <div class="info-section">
                <h4>部门信息</h4>
                <div class="info-item">
                    <span class="info-label">部门代码</span>
                    <span class="info-value" id="deptCode">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">成员数量</span>
                    <span class="info-value" id="memberCount">--</span>
                </div>
                <div class="info-item">
                    <span class="info-label">创建时间</span>
                    <span class="info-value" id="createdAt">--</span>
                </div>
            </div>

            <div class="info-section">
                <h4>所属部门</h4>
                <div id="userDepts">
                    <div class="info-item">
                        <span class="info-label">--</span>
                        <span class="info-value">--</span>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h4>参与项目</h4>
                <div id="userProjects">
                    <div class="info-item">
                        <span class="info-label">--</span>
                        <span class="info-value">--</span>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h4>领导链</h4>
                <div id="leaderChain">
                    <div class="info-item">
                        <span class="info-label">--</span>
                        <span class="info-value">--</span>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h4>下属人员</h4>
                <div id="subordinates">
                    <div class="info-item">
                        <span class="info-label">--</span>
                        <span class="info-value">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()" title="放大">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="zoom-btn" onclick="zoomOut()" title="缩小">
                <i class="fas fa-search-minus"></i>
            </button>
            <button class="zoom-btn" onclick="zoomFit()" title="适应屏幕">
                <i class="fas fa-compress"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- D3.js for tree visualization -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
    let organizationData = [];
    let currentView = 'department';
    let svg, g, tree, root, zoom;

    // 初始化组织架构图
    function initOrganizationTree() {
        const container = document.getElementById('orgTree');
        const width = container.clientWidth;
        const height = 600;

        // 清空容器
        container.innerHTML = '';

        // 创建SVG
        svg = d3.select('#orgTree')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // 创建缩放行为
        zoom = d3.zoom()
            .scaleExtent([0.5, 3])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // 创建主容器组
        g = svg.append('g')
            .attr('transform', `translate(${width/2}, 50)`);

        // 加载数据
        loadOrganizationData();
    }

    // 加载组织架构数据
    async function loadOrganizationData() {
        try {
            const response = await fetch('/api/organization/tree');
            const result = await response.json();

            if (result.success) {
                organizationData = result.data;
                updateStatistics();
                renderTree();
            } else {
                showError('加载数据失败: ' + result.error);
            }
        } catch (error) {
            console.error('加载组织数据失败:', error);
            showError('网络请求失败，请检查网络连接');
        }
    }

    // 更新统计信息
    function updateStatistics() {
        let totalDepts = 0;
        let totalEmployees = 0;

        function countNodes(nodes) {
            nodes.forEach(node => {
                if (node.type !== 'team') {
                    totalDepts++;
                }
                if (node.member_count) {
                    totalEmployees += node.member_count;
                }
                if (node.children && node.children.length > 0) {
                    countNodes(node.children);
                }
            });
        }

        countNodes(organizationData);

        document.getElementById('totalDepts').textContent = totalDepts;
        document.getElementById('totalEmployees').textContent = totalEmployees;
        document.getElementById('totalProjects').textContent = '12'; // 模拟数据
        document.getElementById('totalWorkspaces').textContent = '8'; // 模拟数据
    }

    // 渲染树形图
    function renderTree() {
        if (!organizationData || organizationData.length === 0) {
            showError('暂无组织架构数据');
            return;
        }

        // 清空现有内容
        g.selectAll('*').remove();

        // 创建层次布局
        tree = d3.tree()
            .size([800, 400])
            .separation((a, b) => {
                return (a.parent == b.parent ? 1 : 2) / a.depth;
            });

        // 创建根节点
        root = d3.hierarchy({
            name: '公司',
            children: organizationData,
            type: 'company'
        });

        // 计算布局
        tree(root);

        // 绘制连接线
        const links = g.selectAll('.link')
            .data(root.links())
            .enter().append('path')
            .attr('class', 'link')
            .attr('d', d3.linkVertical()
                .x(d => d.x)
                .y(d => d.y))
            .style('fill', 'none')
            .style('stroke', '#ccc')
            .style('stroke-width', '2px');

        // 绘制节点
        const nodes = g.selectAll('.node')
            .data(root.descendants())
            .enter().append('g')
            .attr('class', 'node')
            .attr('transform', d => `translate(${d.x}, ${d.y})`)
            .style('cursor', 'pointer')
            .on('click', (event, d) => {
                event.stopPropagation();
                showNodeInfo(d.data);
            })
            .on('mouseover', (event, d) => {
                d3.select(event.currentTarget).select('circle')
                    .style('stroke-width', '3px');
            })
            .on('mouseout', (event, d) => {
                d3.select(event.currentTarget).select('circle')
                    .style('stroke-width', '2px');
            });

        // 添加节点圆圈
        nodes.append('circle')
            .attr('r', d => {
                if (d.data.type === 'company') return 25;
                if (d.data.type === 'team') return 15;
                return 20;
            })
            .style('fill', d => {
                if (d.data.type === 'company') return '#007bff';
                if (d.data.type === 'team') return '#28a745';
                return '#6c757d';
            })
            .style('stroke', '#fff')
            .style('stroke-width', '2px');

        // 添加节点文字
        nodes.append('text')
            .attr('dy', '.35em')
            .attr('x', d => {
                if (d.data.type === 'company') return 35;
                if (d.data.type === 'team') return 25;
                return 30;
            })
            .style('text-anchor', 'start')
            .style('font-size', '12px')
            .style('fill', '#333')
            .text(d => d.data.name);

        // 添加成员数量标签
        nodes.filter(d => d.data.member_count)
            .append('text')
            .attr('dy', '1.5em')
            .attr('x', d => {
                if (d.data.type === 'company') return 35;
                if (d.data.type === 'team') return 25;
                return 30;
            })
            .style('text-anchor', 'start')
            .style('font-size', '10px')
            .style('fill', '#666')
            .text(d => `(${d.data.member_count}人)`);
    }

    // 显示节点详细信息
    function showNodeInfo(nodeData) {
        const panel = document.getElementById('nodeInfoPanel');

        // 填充基本信息
        document.getElementById('nodeName').textContent = nodeData.name || '--';
        document.getElementById('nodeUsername').textContent = nodeData.username || '--';
        document.getElementById('nodeRole').textContent = nodeData.role || '--';

        // 填充部门信息
        if (nodeData.code) {
            document.getElementById('deptCode').textContent = nodeData.code;
            document.getElementById('memberCount').textContent = nodeData.member_count || 0;
            document.getElementById('createdAt').textContent = nodeData.created_at || '--';
        } else {
            document.querySelector('.info-section:first-of-type').style.display = 'none';
        }

        // 显示面板
        panel.style.display = 'block';
    }

    // 关闭节点信息面板
    function closeNodeInfo() {
        document.getElementById('nodeInfoPanel').style.display = 'none';
    }

    // 缩放控制
    function zoomIn() {
        svg.transition().duration(300).call(zoom.scaleBy, 1.2);
    }

    function zoomOut() {
        svg.transition().duration(300).call(zoom.scaleBy, 0.8);
    }

    function zoomFit() {
        svg.transition().duration(300).call(zoom.transform, d3.zoomIdentity);
    }

    // 展开所有节点
    function expandAll() {
        // 这里可以添加展开所有节点的逻辑
        renderTree();
    }

    // 折叠所有节点
    function collapseAll() {
        // 这里可以添加折叠所有节点的逻辑
        renderTree();
    }

    // 刷新数据
    function refreshData() {
        document.getElementById('orgTree').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin fa-2x"></i><p>正在刷新数据...</p></div>';
        loadOrganizationData();
    }

    // 显示错误信息
    function showError(message) {
        document.getElementById('orgTree').innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <p>${message}</p>
                <button onclick="refreshData()" class="btn btn-primary">重试</button>
            </div>
        `;
    }

    // 工具栏切换
    document.getElementById('viewDept').addEventListener('click', function() {
        document.querySelectorAll('.toolbar button').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        currentView = 'department';
        refreshData();
    });

    document.getElementById('viewProject').addEventListener('click', function() {
        document.querySelectorAll('.toolbar button').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        currentView = 'project';
        // 这里可以加载项目视图数据
        alert('项目视图功能开发中...');
    });

    document.getElementById('viewHierarchy').addEventListener('click', function() {
        document.querySelectorAll('.toolbar button').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        currentView = 'hierarchy';
        // 这里可以加载层级视图数据
        alert('层级视图功能开发中...');
    });

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        initOrganizationTree();
    });

    // 窗口大小改变时重新渲染
    window.addEventListener('resize', function() {
        if (svg) {
            initOrganizationTree();
        }
    });
</script>
{% endblock %}