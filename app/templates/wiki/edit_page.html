{% extends "base.html" %}

{% block title %}{{ page.title if page else 'New Page' }} - Edit - Enterprise Wiki{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-edit me-2"></i>
                {{ page.title if page else 'Create New Page' }}
            </h2>
            <div>
                <a href="{{ url_for('wiki.view_page', slug=page.slug) if page else url_for('wiki.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>Cancel
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Editor Main -->
    <div class="col-lg-8">
        <form method="POST" name="page_form">
            {{ form.hidden_tag() }}

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Page Content
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control form-control-lg" + (" is-invalid" if form.title.errors else "")) }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {{ form.category_id.label(class="form-label") }}
                            {{ form.category_id(class="form-select" + (" is-invalid" if form.category_id.errors else "")) }}
                            {% if form.category_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category_id.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.summary.label(class="form-label") }}
                        {{ form.summary(class="form-control" + (" is-invalid" if form.summary.errors else "")) }}
                        {% if form.summary.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.summary.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Brief description of the page (optional, max 500 characters)</small>
                    </div>

                    <div class="mb-3">
                        {{ form.content.label(class="form-label") }}
                        {{ form.content(class="markdown-editor", rows=20) }}
                        {% if form.content.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.content.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    {% if is_edit and page %}
                    <div class="mb-3">
                        {{ form.change_summary.label(class="form-label") }}
                        {{ form.change_summary(class="form-control", placeholder="Describe what you changed in this edit...") }}
                        <small class="form-text text-muted">This will be shown in the page history</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Publishing Options -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Publishing Options
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.is_published(class="form-check-input") }}
                                {{ form.is_published.label(class="form-check-label") }}
                            </div>
                            <small class="form-text text-muted">Published pages are visible to other users</small>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.is_public(class="form-check-input") }}
                                {{ form.is_public.label(class="form-check-label") }}
                            </div>
                            <small class="form-text text-muted">Public pages can be viewed without logging in</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="card mt-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-primary btn-lg me-2">
                                <i class="fas fa-save me-2"></i>Save Page
                            </button>
                            <button type="submit" name="save_draft" value="true" class="btn btn-outline-secondary">
                                <i class="fas fa-save me-2"></i>Save Draft
                            </button>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <a href="{{ url_for('wiki.view_page', slug=page.slug) if page else url_for('wiki.index') }}" class="btn btn-outline-danger">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Markdown Help -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>Markdown Quick Reference
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tr>
                            <td><code># Heading 1</code></td>
                            <td>Large heading</td>
                        </tr>
                        <tr>
                            <td><code>## Heading 2</code></td>
                            <td>Medium heading</td>
                        </tr>
                        <tr>
                            <td><code>**bold**</code></td>
                            <td><strong>bold text</strong></td>
                        </tr>
                        <tr>
                            <td><code>*italic*</code></td>
                            <td><em>italic text</em></td>
                        </tr>
                        <tr>
                            <td><code>[link](url)</code></td>
                            <td><a href="#">link</a></td>
                        </tr>
                        <tr>
                            <td><code>![alt](image-url)</code></td>
                            <td>image</td>
                        </tr>
                        <tr>
                            <td><code>`code`</code></td>
                            <td><code>inline code</code></td>
                        </tr>
                        <tr>
                            <td><code>- list item</code></td>
                            <td>bullet list</td>
                        </tr>
                        <tr>
                            <td><code>1. numbered item</code></td>
                            <td>numbered list</td>
                        </tr>
                        <tr>
                            <td><code>> quote</code></td>
                            <td>blockquote</td>
                        </tr>
                    </table>
                </div>
                <div class="text-center mt-2">
                    <a href="https://www.markdownguide.org/cheat-sheet/" target="_blank" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-external-link-alt me-1"></i>Full Guide
                    </a>
                </div>
            </div>
        </div>

        <!-- File Upload -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-upload me-2"></i>Upload Files
                </h6>
            </div>
            <div class="card-body">
                <div class="file-upload-area" id="fileUploadArea">
                    <input type="file" id="fileInput" multiple>
                    <label for="fileInput" class="file-upload-label">
                        <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                        <p class="mb-0">Click to upload or drag and drop</p>
                        <small class="text-muted">PNG, JPG, PDF, DOC, XLS up to 16MB</small>
                    </label>
                </div>
                <div id="uploadProgress" class="mt-2" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div id="uploadedFiles" class="mt-3">
                    <!-- Uploaded files will appear here -->
                </div>
            </div>
        </div>

        <!-- Preview Mode Toggle -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-eye me-2"></i>Preview Options
                </h6>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="autoPreview" checked>
                    <label class="form-check-label" for="autoPreview">
                        Auto-preview (as you type)
                    </label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="syncScroll" checked>
                    <label class="form-check-label" for="syncScroll">
                        Synchronized scrolling
                    </label>
                </div>
            </div>
        </div>

        <!-- Page Info -->
        {% if page %}
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Page Information
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Created:</strong><br>
                    <small>{{ page.created_at.strftime('%Y-%m-%d %H:%M') }} by {{ page.author.username if page.author else 'Unknown' }}</small>
                </div>
                <div class="mb-2">
                    <strong>Last Modified:</strong><br>
                    <small>{{ page.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
                <div class="mb-2">
                    <strong>View Count:</strong><br>
                    <small>{{ page.view_count }} views</small>
                </div>
                <div>
                    <strong>Revisions:</strong><br>
                    <small>{{ page.versions.count() }} versions</small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Markdown Editor
    const contentTextarea = document.querySelector('textarea[name="content"]');
    if (contentTextarea) {
        new MarkdownEditor(contentTextarea, {
            toolbar: true,
            fullscreen: true,
            autoSave: true,
            autoSaveDelay: 3000
        });
    }

    // File upload functionality
    setupFileUpload();

    // Auto-save functionality
    setupAutoSave();

    // Preview synchronization
    setupPreviewSync();

    // Keyboard shortcuts
    setupKeyboardShortcuts();
});

function setupFileUpload() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadedFiles = document.getElementById('uploadedFiles');

    // Drag and drop
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    // File input change
    fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        for (let file of files) {
            uploadFile(file);
        }
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('page_id', {{ page.id if page else '""' }});
        formData.append('csrf_token', document.querySelector('meta[name="csrf-token"]').getAttribute('content'));

        uploadProgress.style.display = 'block';
        const progressBar = uploadProgress.querySelector('.progress-bar');

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true);

        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
            }
        });

        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    addUploadedFile(response.attachment);
                    showToast('File uploaded successfully!', 'success');
                } else {
                    showToast(response.error || 'Upload failed', 'danger');
                }
            } else {
                showToast('Upload failed', 'danger');
            }
            uploadProgress.style.display = 'none';
            progressBar.style.width = '0%';
            fileInput.value = '';
        });

        xhr.addEventListener('error', function() {
            showToast('Upload failed', 'danger');
            uploadProgress.style.display = 'none';
            progressBar.style.width = '0%';
        });

        xhr.send(formData);
    }

    function addUploadedFile(attachment) {
        const fileHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <strong>${attachment.original_filename}</strong> uploaded successfully
                (${attachment.size})
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        uploadedFiles.insertAdjacentHTML('afterbegin', fileHtml);
    }
}

function setupAutoSave() {
    const content = document.getElementById('content');
    const title = document.getElementById('title');
    let autoSaveTimer;

    function saveDraft() {
        const draft = {
            title: title.value,
            content: content.value,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('page_draft_' + window.location.pathname, JSON.stringify(draft));

        // Show save indicator
        const saveIndicator = document.createElement('div');
        saveIndicator.className = 'position-fixed bottom-0 end-0 p-3';
        saveIndicator.style.zIndex = '1050';
        saveIndicator.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-body">
                    Draft auto-saved
                </div>
            </div>
        `;
        document.body.appendChild(saveIndicator);
        setTimeout(() => saveIndicator.remove(), 2000);
    }

    function triggerAutoSave() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(saveDraft, 2000);
    }

    content.addEventListener('input', triggerAutoSave);
    title.addEventListener('input', triggerAutoSave);

    // Restore draft if exists
    const draft = localStorage.getItem('page_draft_' + window.location.pathname);
    if (draft && !content.value.trim()) {
        const draftData = JSON.parse(draft);
        if (confirm('Restore unsaved draft from ' + new Date(draftData.timestamp).toLocaleString() + '?')) {
            title.value = draftData.title;
            content.value = draftData.content;
        }
    }
}

function setupPreviewSync() {
    const autoPreview = document.getElementById('autoPreview');
    const syncScroll = document.getElementById('syncScroll');

    if (autoPreview && autoPreview.checked) {
        // Auto-preview is handled by the markdown editor
    }
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    document.querySelector('form[type="submit"]').click();
                    break;
                case 'p':
                    e.preventDefault();
                    window.open('/preview', '_blank');
                    break;
            }
        }
    });
}

// Form validation before submit
document.querySelector('form').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();

    if (!title) {
        e.preventDefault();
        showToast('Please enter a page title', 'warning');
        document.getElementById('title').focus();
        return;
    }

    if (!content) {
        e.preventDefault();
        showToast('Please enter page content', 'warning');
        document.getElementById('content').focus();
        return;
    }

    // Clear draft on successful save
    localStorage.removeItem('page_draft_' + window.location.pathname);
});
</script>
{% endblock %}