{% extends "base.html" %}

{% block title %}{{ page.title }} - Enterprise Wiki{% endblock %}

{% block content %}
<div class="wiki-container">
    <!-- Header -->
    <header class="wiki-header">
        <div class="wiki-header-content">
            <div class="d-flex justify-content-between align-items-center">
                <div class="wiki-title-section">
                    <nav aria-label="breadcrumb" class="wiki-breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('wiki.index') }}">Home</a></li>
                            {% if page.category %}
                            <li class="breadcrumb-item"><a href="{{ url_for('wiki.category_view', category_id=page.category.id) }}">{{ page.category.name }}</a></li>
                            {% endif %}
                            {% for ancestor in page.get_ancestors() %}
                            <li class="breadcrumb-item"><a href="{{ url_for('wiki.view_page', slug=ancestor.slug) }}">{{ ancestor.title }}</a></li>
                            {% endfor %}
                            <li class="breadcrumb-item active">{{ page.title }}</li>
                        </ol>
                    </nav>
                    <h1 class="wiki-title" id="page-title">{{ page.title }}</h1>
                </div>
                <div class="wiki-actions">
                    {% if current_user.is_authenticated and page.can_edit(current_user) %}
                    <button class="btn btn-primary" id="edit-button" onclick="enableEditMode()">
                        <i class="fas fa-edit me-2"></i>Edit
                    </button>
                    {% endif %}
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('wiki.page_history', page_id=page.id) }}">
                                <i class="fas fa-history me-2"></i>View History
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="copyToClipboard(window.location.href)">
                                <i class="fas fa-link me-2"></i>Copy Link
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="exportPage()">
                                <i class="fas fa-download me-2"></i>Export
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="printPage()">
                                <i class="fas fa-print me-2"></i>Print
                            </a></li>
                            {% if current_user.is_authenticated and current_user.is_administrator() %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deletePage({{ page.id }})">
                                <i class="fas fa-trash me-2"></i>Delete Page
                            </a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="wiki-body">
        <!-- Left Sidebar -->
        <aside class="wiki-sidebar" id="wiki-sidebar">
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h6 class="mb-0">
                        <i class="fas fa-sitemap me-2"></i>Page Tree
                    </h6>
                </div>
                <div class="sidebar-content">
                    <div id="page-tree">
                        <!-- Page tree will be generated by JavaScript -->
                    </div>
                </div>
            </div>

            {% if page.content_html %}
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h6 class="mb-0">
                        <i class="fas fa-list me-2"></i>Table of Contents
                    </h6>
                </div>
                <div class="sidebar-content">
                    <nav id="toc">
                        <!-- Table of contents will be generated by JavaScript -->
                    </nav>
                </div>
            </div>
            {% endif %}

            <!-- Page Information -->
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Page Details
                    </h6>
                </div>
                <div class="sidebar-content">
                    <div class="page-meta-sidebar">
                        <div class="meta-item">
                            <small class="text-muted">Created</small>
                            <div class="meta-value">{{ page.created_at.strftime('%b %d, %Y') }}</div>
                        </div>
                        <div class="meta-item">
                            <small class="text-muted">Author</small>
                            <div class="meta-value">{{ page.author.username if page.author else 'Unknown' }}</div>
                        </div>
                        {% if page.updated_at != page.created_at %}
                        <div class="meta-item">
                            <small class="text-muted">Last Updated</small>
                            <div class="meta-value">{{ page.updated_at.strftime('%b %d, %Y') }}</div>
                        </div>
                        {% endif %}
                        <div class="meta-item">
                            <small class="text-muted">Views</small>
                            <div class="meta-value">{{ page.view_count }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="wiki-content" id="wiki-content">
            <!-- View Mode -->
            <div id="view-mode" class="view-mode">
                <div class="content-wrapper">
                    <!-- Page Status Badges -->
                    <div class="page-badges mb-3">
                        {% if page.is_published %}
                        <span class="badge bg-success me-2">Published</span>
                        {% else %}
                        <span class="badge bg-secondary me-2">Draft</span>
                        {% endif %}
                        {% if page.is_public %}
                        <span class="badge bg-info me-2">Public</span>
                        {% else %}
                        <span class="badge bg-warning me-2">Private</span>
                        {% endif %}
                        {% if page.category %}
                        <span class="badge bg-primary me-2">
                            <i class="fas fa-folder me-1"></i>{{ page.category.name }}
                        </span>
                        {% endif %}
                    </div>

                    <!-- Page Content -->
                    <div class="page-content" id="page-content-display">
                        {% if page.content_html %}
                        {{ page.content_html | safe }}
                        {% else %}
                        <div class="empty-state">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">This page doesn't have any content yet.</p>
                            {% if current_user.is_authenticated and page.can_edit(current_user) %}
                            <button class="btn btn-primary" onclick="enableEditMode()">
                                <i class="fas fa-plus me-2"></i>Add Content
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Page Summary -->
                    {% if page.summary %}
                    <div class="page-summary mt-4">
                        <div class="alert alert-light">
                            <h6><i class="fas fa-info-circle me-2"></i>Summary</h6>
                            <p class="mb-0">{{ page.summary }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Attachments Section -->
                {% if attachments %}
                <div class="attachments-section mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-paperclip me-2"></i>Attachments ({{ attachments|length }})
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for attachment in attachments %}
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    {% if attachment.is_image() %}
                                                    <img src="{{ url_for('static', filename='uploads/' + attachment.filename) }}"
                                                         alt="{{ attachment.original_filename }}"
                                                         class="img-thumbnail" style="max-width: 60px; max-height: 60px;">
                                                    {% else %}
                                                    <i class="fas fa-file fa-2x text-muted"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">{{ attachment.original_filename }}</h6>
                                                    <small class="text-muted">
                                                        {{ attachment.get_size_display() }}
                                                        • {{ attachment.uploaded_at.strftime('%Y-%m-%d') }}
                                                    </small>
                                                </div>
                                                <div>
                                                    <a href="{{ url_for('static', filename='uploads/' + attachment.filename) }}"
                                                       class="btn btn-outline-primary btn-sm" download>
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                </div>
                                            </div>
                                            {% if attachment.description %}
                                            <p class="mt-2 mb-0 small text-muted">{{ attachment.description }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Edit Mode (Initially Hidden) -->
            <div id="edit-mode" class="edit-mode" style="display: none;">
                <div class="editor-container">
                    <form id="edit-form" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- Title Edit -->
                        <div class="form-group mb-3">
                            <input type="text" class="form-control form-control-lg" id="edit-title"
                                   name="title" value="{{ page.title }}" placeholder="Page title">
                        </div>

                        <!-- Category Selection -->
                        <div class="form-group mb-3">
                            <select class="form-select" name="category_id" id="edit-category">
                                <option value="">No category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if page.category and page.category.id == category.id %}selected{% endif %}>
                                    {{ category.get_path() }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Markdown Editor -->
                        <div class="form-group">
                            <div class="markdown-editor-container">
                                <div class="editor-toolbar">
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('**', '**')" title="Bold">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('*', '*')" title="Italic">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('## ', '')" title="Heading">
                                            <i class="fas fa-heading"></i>
                                        </button>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('- ', '')" title="List">
                                            <i class="fas fa-list-ul"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('[', '](url)')" title="Link">
                                            <i class="fas fa-link"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('`', '`')" title="Code">
                                            <i class="fas fa-code"></i>
                                        </button>
                                    </div>
                                    <div class="btn-group btn-group-sm ms-auto">
                                        <button type="button" class="btn btn-outline-info" onclick="togglePreview()" id="preview-btn">
                                            <i class="fas fa-eye me-1"></i>Preview
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" onclick="toggleFullscreen()">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="editor-content">
                                    <textarea class="form-control markdown-editor" id="edit-content" name="content"
                                              rows="20" placeholder="Enter markdown content...">{{ page.content or '' }}</textarea>
                                    <div class="markdown-preview" id="edit-preview" style="display: none;">
                                        <div class="preview-content" id="preview-content-display"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Actions -->
                        <div class="editor-actions mt-3">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Save Changes
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="saveDraft()">
                                        <i class="fas fa-save me-2"></i>Save Draft
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" onclick="cancelEdit()">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </button>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Content is formatted with Markdown
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let isEditMode = false;
let originalTitle = '{{ page.title }}';
let originalContent = `{{ page.content or '' }}`;

document.addEventListener('DOMContentLoaded', function() {
    generatePageTree();
    generateTableOfContents();

    // Setup auto-save draft
    setupAutoSave();

    // Setup markdown preview
    setupMarkdownPreview();

    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'e':
                    e.preventDefault();
                    if (!isEditMode && {{ 'true' if current_user.is_authenticated and page.can_edit(current_user) else 'false' }}) {
                        enableEditMode();
                    }
                    break;
                case 's':
                    e.preventDefault();
                    if (isEditMode) {
                        document.getElementById('edit-form').dispatchEvent(new Event('submit'));
                    }
                    break;
            }
        }

        if (e.key === 'Escape' && isEditMode) {
            cancelEdit();
        }
    });
});

function generatePageTree() {
    const pageTree = document.getElementById('page-tree');
    if (!pageTree) return;

    // Get the root page (current page's top-level parent)
    const rootPage = {{ page.get_ancestors()[-1].id if page.get_ancestors() else page.id }};

    fetch(`/api/pages/hierarchy?root_id=${rootPage}&current_id={{ page.id }}`)
        .then(response => response.json())
        .then(data => {
            pageTree.innerHTML = renderPageTree(data.hierarchy, data.current_page_id);
        })
        .catch(error => {
            console.error('Error loading page tree:', error);
            pageTree.innerHTML = '<p class="text-muted">Unable to load page tree</p>';
        });
}

function renderPageTree(pages, currentId, level = 0) {
    let html = '';

    pages.forEach(page => {
        const isActive = page.id === currentId;
        const hasChildren = page.children && page.children.length > 0;
        const indent = level * 20;

        html += `
            <div class="page-tree-item" style="margin-left: ${indent}px;">
                <div class="page-tree-link ${isActive ? 'active' : ''}">
                    <a href="/wiki/${page.slug}" class="${isActive ? 'active-link' : ''}">
                        ${hasChildren ? '<i class="fas fa-chevron-right me-1"></i>' : '<i class="fas fa-file me-1"></i>'}
                        ${page.title}
                    </a>
                    ${hasChildren ? `<button class="toggle-children btn btn-sm p-0 ms-1" onclick="toggleChildren(this, ${page.id})">
                        <i class="fas fa-chevron-down"></i>
                    </button>` : ''}
                </div>
                ${hasChildren ? `<div class="page-tree-children" id="children-${page.id}">${renderPageTree(page.children, currentId, level + 1)}</div>` : ''}
            </div>
        `;
    });

    return html;
}

function toggleChildren(button, pageId) {
    const childrenDiv = document.getElementById(`children-${pageId}`);
    const icon = button.querySelector('i');

    if (childrenDiv.style.display === 'none') {
        childrenDiv.style.display = 'block';
        icon.className = 'fas fa-chevron-down';
    } else {
        childrenDiv.style.display = 'none';
        icon.className = 'fas fa-chevron-right';
    }
}

function generateTableOfContents() {
    const content = document.querySelector('.page-content');
    if (!content) return;

    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    if (headings.length === 0) return;

    const toc = document.getElementById('toc');
    let tocHtml = '<ul class="list-unstyled">';

    headings.forEach((heading, index) => {
        // Add ID to heading if it doesn't have one
        if (!heading.id) {
            heading.id = 'heading-' + index;
        }

        const level = parseInt(heading.tagName.charAt(1));
        const indent = (level - 1) * 15;

        tocHtml += `
            <li class="toc-item" style="margin-left: ${indent}px;">
                <a href="#${heading.id}" class="toc-link text-decoration-none">
                    ${heading.textContent}
                </a>
            </li>
        `;
    });

    tocHtml += '</ul>';
    toc.innerHTML = tocHtml;
}

function enableEditMode() {
    if (isEditMode) return;

    isEditMode = true;
    document.getElementById('view-mode').style.display = 'none';
    document.getElementById('edit-mode').style.display = 'block';
    document.getElementById('edit-button').style.display = 'none';

    // Focus on title field
    document.getElementById('edit-title').focus();
}

function cancelEdit() {
    if (!isEditMode) return;

    // Restore original content
    document.getElementById('edit-title').value = originalTitle;
    document.getElementById('edit-content').value = originalContent;

    // Switch back to view mode
    isEditMode = false;
    document.getElementById('view-mode').style.display = 'block';
    document.getElementById('edit-mode').style.display = 'none';
    document.getElementById('edit-button').style.display = 'inline-flex';
}

function setupMarkdownPreview() {
    const contentTextarea = document.getElementById('edit-content');
    const previewContent = document.getElementById('preview-content-display');

    if (!contentTextarea || !previewContent) return;

    contentTextarea.addEventListener('input', function() {
        updatePreview();
    });
}

function updatePreview() {
    const content = document.getElementById('edit-content').value;
    const previewContent = document.getElementById('preview-content-display');

    fetch('/wiki/preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: 'content=' + encodeURIComponent(content)
    })
    .then(response => response.text())
    .then(html => {
        previewContent.innerHTML = html;
    })
    .catch(error => {
        console.error('Error previewing markdown:', error);
        previewContent.innerHTML = '<p class="text-danger">Error previewing content</p>';
    });
}

function togglePreview() {
    const textarea = document.getElementById('edit-content');
    const preview = document.getElementById('edit-preview');
    const previewBtn = document.getElementById('preview-btn');

    if (preview.style.display === 'none') {
        preview.style.display = 'block';
        textarea.style.display = 'none';
        previewBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Edit';
        updatePreview();
    } else {
        preview.style.display = 'none';
        textarea.style.display = 'block';
        previewBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Preview';
    }
}

function toggleFullscreen() {
    const editorContainer = document.querySelector('.editor-container');
    if (!editorContainer.classList.contains('fullscreen')) {
        editorContainer.classList.add('fullscreen');
        editorContainer.style.position = 'fixed';
        editorContainer.style.top = '0';
        editorContainer.style.left = '0';
        editorContainer.style.width = '100vw';
        editorContainer.style.height = '100vh';
        editorContainer.style.zIndex = '9999';
        editorContainer.style.backgroundColor = 'white';
        editorContainer.style.padding = '20px';
        editorContainer.style.overflow = 'auto';
    } else {
        editorContainer.classList.remove('fullscreen');
        editorContainer.style = '';
    }
}

function insertMarkdown(before, after) {
    const textarea = document.getElementById('edit-content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end);

    const newText = text.substring(0, start) + before + selectedText + after + text.substring(end);
    textarea.value = newText;

    // Set cursor position
    const newCursorPos = start + before.length + selectedText.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
}

function setupAutoSave() {
    let saveTimeout;

    document.getElementById('edit-content').addEventListener('input', function() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveDraft(true);
        }, 30000); // Auto-save every 30 seconds
    });
}

function saveDraft(isAuto = false) {
    const formData = new FormData(document.getElementById('edit-form'));
    formData.append('save_draft', 'true');

    fetch('/wiki/edit/{{ page.id }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (!isAuto) {
                showNotification('Draft saved successfully', 'success');
            }
        } else {
            showNotification('Error saving draft: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving draft:', error);
        if (!isAuto) {
            showNotification('Error saving draft', 'error');
        }
    });
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} notification-toast`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
    `;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
    `;

    document.body.appendChild(notification);

    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Form submission
document.getElementById('edit-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('/wiki/edit/{{ page.id }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Page saved successfully', 'success');
            // Reload the page to show updated content
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('Error saving page: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving page:', error);
        showNotification('Error saving page', 'error');
    });
});

// Utility functions
function deletePage(pageId) {
    if (confirm('Are you sure you want to delete this page? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete/${pageId}`;

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;

        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function exportPage() {
    const title = '{{ page.title }}';
    const content = document.querySelector('.page-content').innerText;
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(`# ${title}\n\n${content}`));
    element.setAttribute('download', `${title}.md`);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

function printPage() {
    window.print();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('Link copied to clipboard', 'success');
    });
}
</script>

<style>
/* Wiki Container Styles */
.wiki-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

.wiki-header {
    background: #fff;
    border-bottom: 1px solid #dee2e6;
    padding: 1rem 0;
    flex-shrink: 0;
}

.wiki-header-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

.wiki-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0.5rem 0;
    color: #2c3e50;
}

.wiki-breadcrumb .breadcrumb {
    background: transparent;
    padding: 0;
    margin: 0;
}

.wiki-body {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* Sidebar Styles */
.wiki-sidebar {
    width: 300px;
    background: #f8f9fa;
    border-right: 1px solid #dee2e6;
    overflow-y: auto;
    flex-shrink: 0;
}

.sidebar-section {
    border-bottom: 1px solid #e9ecef;
}

.sidebar-header {
    padding: 1rem;
    background: #fff;
    border-bottom: 1px solid #e9ecef;
    font-weight: 600;
}

.sidebar-content {
    padding: 0.5rem 0;
}

/* Page Tree Styles */
.page-tree-item {
    position: relative;
}

.page-tree-link {
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    text-decoration: none;
    color: #495057;
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
}

.page-tree-link:hover {
    background: #e9ecef;
    color: #007bff;
}

.page-tree-link.active {
    background: #e3f2fd;
    border-left-color: #2196f3;
    color: #1976d2;
}

.page-tree-link a {
    color: inherit;
    text-decoration: none;
    flex: 1;
}

.page-tree-link a:hover {
    color: inherit;
}

.page-tree-link.active-link {
    font-weight: 600;
}

.toggle-children {
    opacity: 0.5;
    transition: opacity 0.2s ease;
}

.toggle-children:hover {
    opacity: 1;
}

.page-tree-children {
    background: #fff;
}

/* TOC Styles */
.toc-item {
    padding: 0.25rem 1rem;
}

.toc-link {
    color: #6c757d;
    font-size: 0.9rem;
    padding: 0.25rem 0;
    display: block;
    border-radius: 3px;
    transition: all 0.2s ease;
}

.toc-link:hover {
    color: #007bff;
    background-color: rgba(0,123,255,0.1);
}

/* Main Content Styles */
.wiki-content {
    flex: 1;
    overflow-y: auto;
    background: #fff;
}

.view-mode, .edit-mode {
    padding: 2rem;
    max-width: 800px;
    margin: 0 auto;
}

.content-wrapper {
    line-height: 1.6;
}

.page-content {
    font-size: 1rem;
    color: #2c3e50;
}

.page-content h1, .page-content h2, .page-content h3,
.page-content h4, .page-content h5, .page-content h6 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.page-content h1 {
    font-size: 2rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

.page-content h2 {
    font-size: 1.5rem;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 0.3rem;
}

.page-content h3 {
    font-size: 1.25rem;
}

.page-content p {
    margin-bottom: 1rem;
}

.page-content code {
    background: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.9rem;
    color: #e83e8c;
}

.page-content pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 5px;
    padding: 1rem;
    overflow-x: auto;
}

.page-content blockquote {
    border-left: 4px solid #007bff;
    padding-left: 1rem;
    margin: 1rem 0;
    color: #6c757d;
    font-style: italic;
}

.page-content ul, .page-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.page-content li {
    margin-bottom: 0.5rem;
}

.page-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
}

.page-content th, .page-content td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
    text-align: left;
}

.page-content th {
    background: #f8f9fa;
    font-weight: 600;
}

/* Page Meta Styles */
.page-meta-sidebar {
    padding: 0.5rem 1rem;
}

.meta-item {
    margin-bottom: 0.75rem;
}

.meta-item small {
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
}

.meta-value {
    font-weight: 500;
    color: #2c3e50;
}

/* Empty State Styles */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
}

/* Editor Styles */
.editor-container {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.editor-toolbar {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    padding: 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.editor-content {
    border: 1px solid #dee2e6;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
}

.markdown-editor {
    border: none;
    border-radius: 0;
    resize: vertical;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.5;
}

.markdown-editor:focus {
    box-shadow: none;
    border: none;
}

.markdown-preview {
    border-top: 1px solid #dee2e6;
    background: #fff;
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
}

.preview-content {
    padding: 1rem;
    line-height: 1.6;
}

.editor-actions {
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
    padding: 1rem;
    border-radius: 0 0 8px 8px;
}

/* Fullscreen Editor */
.editor-container.fullscreen .editor-content {
    height: calc(100vh - 200px);
}

.editor-container.fullscreen .markdown-editor,
.editor-container.fullscreen .markdown-preview {
    height: 100%;
}

/* Notification Toast Styles */
.notification-toast {
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: none;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .wiki-body {
        flex-direction: column;
    }

    .wiki-sidebar {
        width: 100%;
        order: 2;
        border-right: none;
        border-top: 1px solid #dee2e6;
    }

    .wiki-content {
        order: 1;
    }

    .view-mode, .edit-mode {
        padding: 1rem;
    }

    .wiki-title {
        font-size: 1.75rem;
    }
}

/* Print Styles */
@media print {
    .wiki-sidebar, .wiki-actions, .page-badges,
    .editor-actions, .notification-toast {
        display: none !important;
    }

    .wiki-container {
        height: auto;
    }

    .wiki-content {
        overflow: visible;
    }

    .page-content {
        font-size: 12pt;
        line-height: 1.4;
    }
}
</style>
{% endblock %}