{% extends "base.html" %}

{% block title %}{{ page.title }} - Enterprise Wiki{% endblock %}

{% block content %}
<div class="row">
    <!-- Breadcrumb -->
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('wiki.index') }}">Home</a></li>
                {% if page.category %}
                <li class="breadcrumb-item"><a href="{{ url_for('wiki.category_view', category_id=page.category.id) }}">{{ page.category.name }}</a></li>
                {% endif %}
                <li class="breadcrumb-item active">{{ page.title }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="mb-0">{{ page.title }}</h2>
                <div class="btn-group">
                    {% if current_user.is_authenticated and page.can_edit(current_user) %}
                    <a href="{{ url_for('wiki.edit_page', page_id=page.id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-edit me-1"></i>Edit
                    </a>
                    {% endif %}
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            {% if current_user.is_authenticated and current_user.is_administrator() %}
                            <li><a class="dropdown-item text-danger" href="#" onclick="deletePage({{ page.id }})">
                                <i class="fas fa-trash me-2"></i>Delete Page
                            </a></li>
                            {% endif %}
                            <li><a class="dropdown-item" href="{{ url_for('wiki.page_history', page_id=page.id) }}">
                                <i class="fas fa-history me-2"></i>View History
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="copyToClipboard(window.location.href)">
                                <i class="fas fa-link me-2"></i>Copy Link
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="exportPage()">
                                <i class="fas fa-download me-2"></i>Export
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="printPage()">
                                <i class="fas fa-print me-2"></i>Print
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Page Meta Information -->
                <div class="page-meta mb-3">
                    <small class="text-muted">
                        <i class="fas fa-user me-1"></i>
                        Created by <strong>{{ page.author.username if page.author else 'Unknown' }}</strong>
                        on {{ page.created_at.strftime('%B %d, %Y') }}
                        {% if page.last_editor and page.last_editor.id != page.author.id %}
                        • Last edited by <strong>{{ page.last_editor.username }}</strong>
                        on {{ page.updated_at.strftime('%B %d, %Y at %I:%M %p') }}
                        {% elif page.updated_at != page.created_at %}
                        • Last edited on {{ page.updated_at.strftime('%B %d, %Y at %I:%M %p') }}
                        {% endif %}
                        • <i class="fas fa-eye me-1"></i>{{ page.view_count }} views
                    </small>
                </div>

                <!-- Page Status Badges -->
                <div class="mb-3">
                    {% if page.is_published %}
                    <span class="badge bg-success me-2">Published</span>
                    {% else %}
                    <span class="badge bg-secondary me-2">Draft</span>
                    {% endif %}
                    {% if page.is_public %}
                    <span class="badge bg-info me-2">Public</span>
                    {% else %}
                    <span class="badge bg-warning me-2">Private</span>
                    {% endif %}
                    {% if page.category %}
                    <span class="badge bg-primary me-2">
                        <i class="fas fa-folder me-1"></i>{{ page.category.name }}
                    </span>
                    {% endif %}
                </div>

                <!-- Page Content -->
                <div class="page-content">
                    {% if page.content_html %}
                    {{ page.content_html | safe }}
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This page doesn't have any content yet.
                        {% if current_user.is_authenticated and page.can_edit(current_user) %}
                        <a href="{{ url_for('wiki.edit_page', page_id=page.id) }}">Add some content now</a>.
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Page Summary -->
                {% if page.summary %}
                <div class="alert alert-light mt-4">
                    <h6><i class="fas fa-info-circle me-2"></i>Summary</h6>
                    <p class="mb-0">{{ page.summary }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Page Footer -->
            <div class="card-footer">
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-fingerprint me-1"></i>
                            Page ID: {{ page.id }}
                            {% if page.slug %}
                            • Slug: {{ page.slug }}
                            {% endif %}
                        </small>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            Last modified: {{ page.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attachments Section -->
        {% if attachments %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-paperclip me-2"></i>Attachments ({{ attachments|length }})
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for attachment in attachments %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        {% if attachment.is_image() %}
                                        <img src="{{ url_for('static', filename='uploads/' + attachment.filename) }}"
                                             alt="{{ attachment.original_filename }}"
                                             class="img-thumbnail" style="max-width: 60px; max-height: 60px;">
                                        {% else %}
                                        <i class="fas fa-file fa-2x text-muted"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ attachment.original_filename }}</h6>
                                        <small class="text-muted">
                                            {{ attachment.get_size_display() }}
                                            • {{ attachment.uploaded_at.strftime('%Y-%m-%d') }}
                                        </small>
                                    </div>
                                    <div>
                                        <a href="{{ url_for('static', filename='uploads/' + attachment.filename) }}"
                                           class="btn btn-outline-primary btn-sm" download>
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </div>
                                </div>
                                {% if attachment.description %}
                                <p class="mt-2 mb-0 small text-muted">{{ attachment.description }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Table of Contents -->
        {% if page.content_html %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-list me-2"></i>Table of Contents
                </h6>
            </div>
            <div class="card-body">
                <nav id="toc">
                    <!-- Table of contents will be generated by JavaScript -->
                </nav>
            </div>
        </div>
        {% endif %}

        <!-- Recent Changes -->
        {% if versions %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recent Changes
                </h6>
            </div>
            <div class="card-body">
                {% for version in versions[:5] %}
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <small class="d-block">
                            <strong>{{ version.version_number }}.</strong>
                            {% if version.change_summary %}
                            {{ version.change_summary }}
                            {% else %}
                            Page updated
                            {% endif %}
                        </small>
                        <small class="text-muted d-block">
                            by {{ version.editor.username if version.editor else 'Unknown' }}
                            • {{ version.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </small>
                    </div>
                    <a href="{{ url_for('wiki.view_version', version_id=version.id) }}" class="btn btn-outline-secondary btn-sm">
                        View
                    </a>
                </div>
                {% if not loop.last %}<hr>{% endif %}
                {% endfor %}
                {% if versions|length > 5 %}
                <div class="text-center mt-2">
                    <a href="{{ url_for('wiki.page_history', page_id=page.id) }}" class="btn btn-outline-primary btn-sm">
                        View Full History
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Page Actions -->
        {% if current_user.is_authenticated %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-2"></i>Page Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if page.can_edit(current_user) %}
                    <a href="{{ url_for('wiki.edit_page', page_id=page.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i>Edit Page
                    </a>
                    {% endif %}
                    <a href="{{ url_for('wiki.page_history', page_id=page.id) }}" class="btn btn-outline-info">
                        <i class="fas fa-history me-2"></i>View History
                    </a>
                    {% if current_user.is_administrator() %}
                    <button class="btn btn-outline-warning" onclick="togglePageStatus({{ page.id }}, {{ page.is_published|lower }})">
                        <i class="fas fa-power-off me-2"></i>
                        {{ 'Unpublish' if page.is_published else 'Publish' }} Page
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Related Pages -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-link me-2"></i>Related Pages
                </h6>
            </div>
            <div class="card-body">
                <p class="text-muted mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Related pages will be shown here based on categories and content similarity.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generate table of contents
    generateTableOfContents();

    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

function generateTableOfContents() {
    const content = document.querySelector('.page-content');
    if (!content) return;

    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    if (headings.length === 0) return;

    const toc = document.getElementById('toc');
    let tocHtml = '<ul class="list-unstyled">';

    headings.forEach((heading, index) => {
        // Add ID to heading if it doesn't have one
        if (!heading.id) {
            heading.id = 'heading-' + index;
        }

        const level = parseInt(heading.tagName.charAt(1));
        const indent = (level - 1) * 15; // 15px indent per level

        tocHtml += `
            <li style="margin-left: ${indent}px;">
                <a href="#${heading.id}" class="text-decoration-none">
                    ${heading.textContent}
                </a>
            </li>
        `;
    });

    tocHtml += '</ul>';
    toc.innerHTML = tocHtml;
}

function deletePage(pageId) {
    if (confirm('Are you sure you want to delete this page? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete/${pageId}`;

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;

        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function togglePageStatus(pageId, isPublished) {
    const action = isPublished ? 'unpublish' : 'publish';
    if (confirm(`Are you sure you want to ${action} this page?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/pages/${pageId}/toggle_status`;

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;

        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function exportPage() {
    // Simple export to text file
    const title = '{{ page.title }}';
    const content = document.querySelector('.page-content').innerText;
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(`# ${title}\n\n${content}`));
    element.setAttribute('download', `${title}.md`);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

function printPage() {
    window.print();
}
</script>

<style>
@media print {
    .btn, .dropdown, .card-footer, .page-meta {
        display: none !important;
    }
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    .page-content {
        font-size: 12pt;
        line-height: 1.4;
    }
}

/* TOC styles */
#toc a {
    color: #6c757d;
    padding: 2px 0;
    display: block;
}

#toc a:hover {
    color: #007bff;
    background-color: rgba(0,123,255,0.1);
    border-radius: 3px;
}
</style>
{% endblock %}