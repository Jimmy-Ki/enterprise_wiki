{% extends "base_confluence.html" %}

{% block title %}创建新页面 - 企业知识库{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="page-title-section">
            <h1 class="page-title">
                <i class="fas fa-plus me-2"></i>创建新页面
            </h1>
            <p class="page-breadcrumb">
                <a href="{{ url_for('wiki.index') }}" class="breadcrumb-link">
                    <i class="fas fa-home me-1"></i>首页
                </a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">创建页面</span>
            </p>
        </div>
        <div class="page-actions">
            <a href="{{ url_for('wiki.index') }}" class="btn-wiki">
                <i class="fas fa-times me-2"></i>取消
            </a>
        </div>
    </div>
</div>

<div class="page-content">
    <form method="POST" name="page_form" id="createPageForm">
        {{ form.hidden_tag() }}

        <!-- Page Content Card -->
        <div class="content-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>页面内容
                    </h5>
                    <div class="editor-toolbar">
                        <button type="button" class="btn-wiki small" id="togglePreview">
                            <i class="fas fa-eye me-1"></i>预览
                        </button>
                        <button type="button" class="btn-wiki small" id="toggleFullscreen">
                            <i class="fas fa-expand me-1"></i>全屏
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Title Input -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="form-group">
                            {{ form.title.label(class="form-label required") }}
                            {{ form.title(class="form-control form-control-lg" + (" is-invalid" if form.title.errors else ""), placeholder="请输入页面标题...") }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form.category_id.label(class="form-label") }}
                            {{ form.category_id(class="form-select" + (" is-invalid" if form.category_id.errors else "")) }}
                            {% if form.category_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category_id.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Summary Input -->
                <div class="form-group mb-4">
                    {{ form.summary.label(class="form-label") }}
                    {{ form.summary(class="form-control" + (" is-invalid" if form.summary.errors else ""), placeholder="页面的简要描述（可选）...") }}
                    {% if form.summary.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.summary.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">页面的简要描述（可选，最多500个字符）</small>
                </div>

                <!-- Markdown Editor -->
                <div class="form-group">
                    {{ form.content.label(class="form-label required") }}
                    <div class="editor-container" id="markdownEditor">
                        <div class="editor-toolbar">
                            <div class="btn-group">
                                <button type="button" class="btn-wiki small" data-command="bold" title="Bold (Ctrl+B)">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="italic" title="Italic (Ctrl+I)">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="heading" title="Heading">
                                    <i class="fas fa-heading"></i>
                                </button>
                                <div class="divider"></div>
                                <button type="button" class="btn-wiki small" data-command="link" title="Link">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="image" title="Image">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="code" title="Code">
                                    <i class="fas fa-code"></i>
                                </button>
                                <div class="divider"></div>
                                <button type="button" class="btn-wiki small" data-command="ul" title="Unordered List">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="ol" title="Ordered List">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="quote" title="Quote">
                                    <i class="fas fa-quote-left"></i>
                                </button>
                                <div class="divider"></div>
                                <button type="button" class="btn-wiki small" data-command="preview" title="Toggle Preview">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="fullscreen" title="Fullscreen">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <div class="editor-pane">
                                {{ form.content(class="editor-input enhanced-editor", id="contentInput", rows=20, placeholder="Start writing your page content in Markdown...") }}
                            </div>
                            <div class="editor-pane editor-preview" id="previewPane">
                                <div class="preview-content" id="previewContent">
                                    <p class="text-muted">Preview will appear here as you type...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if form.content.errors %}
                        <div class="text-danger mt-1">
                            {% for error in form.content.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Publishing Options Card -->
        <div class="content-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Publishing Options
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            {{ form.is_published(class="form-check-input") }}
                            {{ form.is_published.label(class="form-check-label") }}
                        </div>
                        <small class="form-text text-muted">Published pages are visible to other users</small>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            {{ form.is_public(class="form-check-input") }}
                            {{ form.is_public.label(class="form-check-label") }}
                        </div>
                        <small class="form-text text-muted">Public pages can be viewed without logging in</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Attachments Card -->
        <div class="content-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-paperclip me-2"></i>File Attachments
                </h5>
            </div>
            <div class="card-body">
                <div class="file-upload-area" id="fileUploadArea">
                    <div class="upload-zone" id="uploadZone">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">Drop files here or click to browse</h6>
                        <p class="text-muted small">Supported formats: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, PNG, JPG, GIF</p>
                        <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.png,.jpg,.jpeg,.gif" style="display: none;">
                        <button type="button" class="btn-wiki small" id="browseFilesBtn">
                            <i class="fas fa-folder-open me-1"></i>Browse Files
                        </button>
                    </div>
                    <div id="fileList" class="file-list mt-3" style="display: none;">
                        <h6 class="mb-3">Attached Files:</h6>
                        <div class="list-group" id="fileListContainer"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="content-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button type="submit" class="btn-wiki primary" id="saveButton">
                            <i class="fas fa-save me-2"></i>Save Page
                        </button>
                        <button type="submit" name="save_draft" value="true" class="btn-wiki">
                            <i class="fas fa-save me-2"></i>Save Draft
                        </button>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="{{ url_for('wiki.index') }}" class="btn-wiki secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block styles %}
<style>
.required:after {
    content: " *";
    color: var(--danger-color);
}

.editor-container {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.editor-toolbar {
    background: var(--sidebar-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 8px 12px;
}

.btn-group {
    display: flex;
    align-items: center;
    gap: 4px;
}

.btn-group .divider {
    width: 1px;
    height: 20px;
    background: var(--border-color);
    margin: 0 4px;
}

.editor-content {
    display: flex;
    height: 500px;
}

.editor-pane {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
}

.editor-input {
    width: 100%;
    height: 100%;
    border: none;
    outline: none;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
    resize: none;
    background: transparent;
}

.editor-preview {
    border-left: 1px solid var(--border-color);
    background: #fafafa;
}

.preview-content {
    padding: 16px;
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-primary);
}

/* File Upload Styles */
.upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background: var(--sidebar-bg);
}

.upload-zone:hover {
    border-color: var(--primary-color);
    background: #f8f9fa;
}

.upload-zone.dragover {
    border-color: var(--primary-color);
    background: #e3f2fd;
}

.upload-zone h6 {
    margin-bottom: 8px;
}

.file-list .list-group-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    margin-bottom: 8px;
    border-radius: 6px;
}

.file-info {
    display: flex;
    align-items: center;
    flex-grow: 1;
}

.file-icon {
    margin-right: 12px;
    font-size: 1.2em;
    color: var(--primary-color);
}

.file-details .file-name {
    font-weight: 500;
    margin-bottom: 2px;
}

.file-details .file-size {
    font-size: 0.875em;
    color: var(--text-secondary);
}

.file-actions {
    display: flex;
    gap: 8px;
}

.btn-remove-file {
    background: none;
    border: none;
    color: var(--danger-color);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.btn-remove-file:hover {
    background-color: #ffebee;
}

.upload-progress {
    width: 100%;
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 8px;
}

.upload-progress-bar {
    height: 100%;
    background: var(--primary-color);
    width: 0%;
    transition: width 0.3s ease;
}

.preview-content h1, .preview-content h2, .preview-content h3,
.preview-content h4, .preview-content h5, .preview-content h6 {
    margin-top: 0;
    margin-bottom: 16px;
    font-weight: 600;
}

.preview-content h1 { font-size: 2em; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
.preview-content h2 { font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 6px; }
.preview-content h3 { font-size: 1.25em; }
.preview-content h4 { font-size: 1em; }
.preview-content h5 { font-size: 0.875em; }
.preview-content h6 { font-size: 0.75em; }

.preview-content p {
    margin-bottom: 16px;
}

.preview-content ul, .preview-content ol {
    margin-bottom: 16px;
    padding-left: 24px;
}

.preview-content li {
    margin-bottom: 4px;
}

.preview-content blockquote {
    border-left: 4px solid var(--primary-color);
    padding-left: 16px;
    margin: 16px 0;
    color: var(--text-secondary);
    font-style: italic;
}

.preview-content pre {
    background: #f6f8fa;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 12px;
    overflow-x: auto;
    margin-bottom: 16px;
}

.preview-content code {
    background: #f6f8fa;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 2px 4px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
}

.preview-content pre code {
    background: transparent;
    border: none;
    padding: 0;
}

.preview-content table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 16px;
}

.preview-content th, .preview-content td {
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    text-align: left;
}

.preview-content th {
    background: var(--sidebar-bg);
    font-weight: 600;
}

.fullscreen .editor-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: flex;
    flex-direction: column;
}

.fullscreen .editor-content {
    flex: 1;
}

.fullscreen .editor-toolbar {
    border-bottom: 1px solid var(--border-color);
}

.editor-toolbar .btn-wiki.small {
    padding: 4px 8px;
    font-size: 12px;
    min-height: auto;
}

.editor-toolbar .btn-wiki.small i {
    font-size: 12px;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentInput = document.getElementById('contentInput');
    const previewContent = document.getElementById('previewContent');
    const previewPane = document.getElementById('previewPane');
    const form = document.getElementById('createPageForm');
    const saveButton = document.getElementById('saveButton');

    // Preview functionality
    function updatePreview() {
        const content = contentInput.value;
        if (content.trim()) {
            previewContent.innerHTML = marked.parse(content);
        } else {
            previewContent.innerHTML = '<p class="text-muted">Preview will appear here as you type...</p>';
        }
    }

    // Auto-preview as user types
    let previewTimeout;
    contentInput.addEventListener('input', function() {
        clearTimeout(previewTimeout);
        previewTimeout = setTimeout(updatePreview, 300);
    });

    // Initial preview
    updatePreview();

    // Toolbar functionality
    const toolbarButtons = document.querySelectorAll('.editor-toolbar .btn-wiki[data-command]');
    toolbarButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const command = this.dataset.command;
            handleCommand(command);
        });
    });

    function handleCommand(command) {
        switch(command) {
            case 'bold':
                insertText('**', '**', 'bold text');
                break;
            case 'italic':
                insertText('*', '*', 'italic text');
                break;
            case 'heading':
                insertText('## ', '', 'Heading');
                break;
            case 'link':
                insertText('[', '](url)', 'link text');
                break;
            case 'image':
                insertText('![', '](image-url)', 'alt text');
                break;
            case 'code':
                insertText('`', '`', 'code');
                break;
            case 'ul':
                insertText('- ', '', 'list item');
                break;
            case 'ol':
                insertText('1. ', '', 'numbered item');
                break;
            case 'quote':
                insertText('> ', '', 'quote');
                break;
            case 'preview':
                togglePreview();
                break;
            case 'fullscreen':
                toggleFullscreen();
                break;
        }
    }

    function insertText(before, after, placeholder) {
        const start = contentInput.selectionStart;
        const end = contentInput.selectionEnd;
        const selectedText = contentInput.value.substring(start, end);
        const text = selectedText || placeholder;
        const newText = before + text + after;

        contentInput.value = contentInput.value.substring(0, start) + newText + contentInput.value.substring(end);
        contentInput.selectionStart = start + before.length;
        contentInput.selectionEnd = start + before.length + text.length;
        contentInput.focus();

        updatePreview();
    }

    function togglePreview() {
        previewPane.style.display = previewPane.style.display === 'none' ? 'block' : 'none';
    }

    function toggleFullscreen() {
        document.body.classList.toggle('fullscreen');
        const fullscreenBtn = document.querySelector('[data-command="fullscreen"] i');
        if (document.body.classList.contains('fullscreen')) {
            fullscreenBtn.className = 'fas fa-compress';
        } else {
            fullscreenBtn.className = 'fas fa-expand';
        }
    }

    // Form validation
    form.addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const content = contentInput.value.trim();

        if (!title) {
            e.preventDefault();
            showToast('Please enter a page title', 'warning');
            document.getElementById('title').focus();
            return;
        }

        if (!content) {
            e.preventDefault();
            showToast('Please enter page content', 'warning');
            contentInput.focus();
            return;
        }

        // Add uploaded files data to form
        const filesToSubmit = uploadedFiles.map(file => ({
            id: file.id,
            filename: file.filename,
            original_filename: file.original_filename
        }));

        if (filesToSubmit.length > 0) {
            // Create hidden input for uploaded files
            let filesInput = document.createElement('input');
            filesInput.type = 'hidden';
            filesInput.name = 'uploaded_files';
            filesInput.value = JSON.stringify(filesToSubmit);
            form.appendChild(filesInput);
        }
    });

    // Keyboard shortcuts
    contentInput.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    form.submit();
                    break;
                case 'b':
                    e.preventDefault();
                    handleCommand('bold');
                    break;
                case 'i':
                    e.preventDefault();
                    handleCommand('italic');
                    break;
            }
        }
    });

    // File upload functionality
    const fileInput = document.getElementById('fileInput');
    const uploadZone = document.getElementById('uploadZone');
    const browseFilesBtn = document.getElementById('browseFilesBtn');
    const fileList = document.getElementById('fileList');
    const fileListContainer = document.getElementById('fileListContainer');
    let uploadedFiles = [];

    // Click to browse files
    browseFilesBtn.addEventListener('click', function(e) {
        e.preventDefault();
        fileInput.click();
    });

    uploadZone.addEventListener('click', function(e) {
        if (e.target !== browseFilesBtn) {
            fileInput.click();
        }
    });

    // Handle file selection
    fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });

    // Drag and drop functionality
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        Array.from(files).forEach(file => {
            if (validateFile(file)) {
                uploadFile(file);
            }
        });
    }

    function validateFile(file) {
        const allowedTypes = [
            'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
            'text/plain', 'image/png', 'image/jpeg', 'image/gif'
        ];

        const maxSize = 10 * 1024 * 1024; // 10MB

        if (!allowedTypes.includes(file.type)) {
            showToast('File type not supported: ' + file.name, 'error');
            return false;
        }

        if (file.size > maxSize) {
            showToast('File too large (max 10MB): ' + file.name, 'error');
            return false;
        }

        return true;
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        // Create file item in UI
        const fileId = 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const fileItem = createFileItem(fileId, file);
        fileListContainer.appendChild(fileItem);
        fileList.style.display = 'block';

        // Upload file
        fetch('/api/upload', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Update file item with server data
                uploadedFiles.push({
                    id: data.id,
                    filename: data.filename,
                    original_filename: data.original_filename,
                    url: data.url
                });
                updateFileItem(fileId, file, data);
                showToast('File uploaded successfully: ' + file.name, 'success');
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            removeFileItem(fileId);
            showToast('Failed to upload file: ' + file.name, 'error');
        });
    }

    function createFileItem(fileId, file) {
        const fileItem = document.createElement('div');
        fileItem.className = 'list-group-item';
        fileItem.id = fileId;

        const fileIcon = getFileIcon(file.type);
        const fileSize = formatFileSize(file.size);

        fileItem.innerHTML = `
            <div class="file-info">
                <i class="file-icon ${fileIcon}"></i>
                <div class="file-details">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
            </div>
            <div class="file-actions">
                <div class="upload-progress">
                    <div class="upload-progress-bar"></div>
                </div>
                <button type="button" class="btn-remove-file" onclick="removeFileItem('${fileId}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        return fileItem;
    }

    function updateFileItem(fileId, file, data) {
        const fileItem = document.getElementById(fileId);
        if (fileItem) {
            const progressBar = fileItem.querySelector('.upload-progress-bar');
            if (progressBar) {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.parentElement.style.display = 'none';
                }, 500);
            }
        }
    }

    function removeFileItem(fileId) {
        const fileItem = document.getElementById(fileId);
        if (fileItem) {
            // Remove from uploaded files array
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId.replace('file_', ''));
            fileItem.remove();

            // Hide file list if empty
            if (fileListContainer.children.length === 0) {
                fileList.style.display = 'none';
            }
        }
    }

    function getFileIcon(fileType) {
        if (fileType.includes('pdf')) return 'fas fa-file-pdf';
        if (fileType.includes('word') || fileType.includes('document')) return 'fas fa-file-word';
        if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel';
        if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'fas fa-file-powerpoint';
        if (fileType.includes('text')) return 'fas fa-file-alt';
        if (fileType.includes('image')) return 'fas fa-file-image';
        return 'fas fa-file';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Toast notification function (reuse from base template)
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
});
</script>

<!-- Enhanced Editor Component -->
{% include 'components/enhanced_editor.html' %}
{% endblock %}