{% extends "base.html" %}

{% block title %}{{ page.title }} - Enterprise Wiki{% endblock %}

{% block content %}
<div class="wiki-layout">
    <!-- Header with simple title -->
    <header class="page-header">
        <div class="header-content">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="page-title" id="page-title">{{ page.title }}</h1>
                    {% if page.category %}
                    <div class="page-category">
                        <i class="fas fa-folder me-1"></i>
                        <a href="{{ url_for('wiki.category_view', category_id=page.category.id) }}">{{ page.category.name }}</a>
                    </div>
                    {% endif %}
                </div>
                <div class="page-actions">
                    {% if current_user.is_authenticated and page.can_edit(current_user) %}
                    <button class="btn btn-primary" id="edit-button" onclick="enableEditMode()">
                        <i class="fas fa-edit me-2"></i>编辑
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <div class="page-body">
        <!-- Left Sidebar - Categories -->
        <aside class="categories-sidebar">
            <div class="sidebar-header">
                <h5 class="mb-0">
                    <i class="fas fa-folder-tree me-2"></i>文档目录
                </h5>
            </div>
            <div class="sidebar-content">
                <div id="categories-tree">
                    <!-- Categories tree will be generated by JavaScript -->
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- View Mode -->
            <div id="view-mode" class="content-view">
                <!-- Page Meta -->
                <div class="page-meta mb-3">
                    <small class="text-muted">
                        <i class="fas fa-user me-1"></i>
                        {{ page.author.username if page.author else 'Unknown' }}
                        • {{ page.created_at.strftime('%Y-%m-%d %H:%M') }}
                        {% if page.updated_at != page.created_at %}
                        • 最后更新 {{ page.updated_at.strftime('%Y-%m-%d %H:%M') }}
                        {% endif %}
                    </small>
                </div>

                <!-- Page Content -->
                <div class="content-body">
                    {% if page.content_html %}
                    {{ page.content_html | safe }}
                    {% else %}
                    <div class="empty-content">
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">此页面还没有内容</p>
                        {% if current_user.is_authenticated and page.can_edit(current_user) %}
                        <button class="btn btn-primary" onclick="enableEditMode()">
                            <i class="fas fa-plus me-2"></i>添加内容
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Page Tags -->
                <div class="page-tags mt-4">
                    {% if page.is_published %}
                    <span class="badge bg-success">已发布</span>
                    {% else %}
                    <span class="badge bg-secondary">草稿</span>
                    {% endif %}
                    {% if page.is_public %}
                    <span class="badge bg-info">公开</span>
                    {% else %}
                    <span class="badge bg-warning">私有</span>
                    {% endif %}
                </div>
            </div>

            <!-- Edit Mode -->
            <div id="edit-mode" class="content-edit" style="display: none;">
                <div class="editor-wrapper">
                    <form id="edit-form" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- Title Edit -->
                        <div class="form-group mb-3">
                            <input type="text" class="form-control form-control-lg" id="edit-title"
                                   name="title" value="{{ page.title }}" placeholder="页面标题">
                        </div>

                        <!-- Category Selection -->
                        <div class="form-group mb-3">
                            <select class="form-select" name="category_id" id="edit-category">
                                <option value="">选择分类</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if page.category and page.category.id == category.id %}selected{% endif %}>
                                    {{ category.get_path() }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Simple Markdown Editor -->
                        <div class="editor-container">
                            <div class="editor-toolbar">
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertText('**', '**')" title="粗体">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertText('*', '*')" title="斜体">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertText('# ', '')" title="标题">
                                        <i class="fas fa-heading"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertText('- ', '')" title="列表">
                                        <i class="fas fa-list-ul"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertText('[', '](url)')" title="链接">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertText('`', '`')" title="代码">
                                        <i class="fas fa-code"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="insertText('```\n', '\n```')" title="代码块">
                                        <i class="fas fa-file-code"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm ms-auto">
                                    <button type="button" class="btn btn-outline-info" onclick="togglePreview()" id="preview-btn">
                                        <i class="fas fa-eye me-1"></i>预览
                                    </button>
                                </div>
                            </div>
                            <textarea class="form-control editor-textarea" id="edit-content" name="content"
                                      rows="25" placeholder="使用 Markdown 语法编写内容...">{{ page.content or '' }}</textarea>
                            <div class="editor-preview" id="edit-preview" style="display: none;">
                                <div class="preview-content" id="preview-content-display"></div>
                            </div>
                        </div>

                        <!-- Editor Actions -->
                        <div class="editor-actions mt-3">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>保存
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="saveDraft()">
                                        <i class="fas fa-save me-2"></i>保存草稿
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" onclick="cancelEdit()">
                                        <i class="fas fa-times me-2"></i>取消
                                    </button>
                                </div>
                                <small class="text-muted">支持 Markdown 语法</small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let isEditMode = false;
let originalTitle = '{{ page.title }}';
let originalContent = `{{ page.content or '' }}`;

document.addEventListener('DOMContentLoaded', function() {
    loadCategoriesTree();
    setupMarkdownPreview();
    setupAutoSave();

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'e':
                    e.preventDefault();
                    if (!isEditMode && {{ 'true' if current_user.is_authenticated and page.can_edit(current_user) else 'false' }}) {
                        enableEditMode();
                    }
                    break;
                case 's':
                    e.preventDefault();
                    if (isEditMode) {
                        document.getElementById('edit-form').dispatchEvent(new Event('submit'));
                    }
                    break;
            }
        }

        if (e.key === 'Escape' && isEditMode) {
            cancelEdit();
        }
    });
});

function loadCategoriesTree() {
    fetch('/api/categories/tree')
        .then(response => response.json())
        .then(data => {
            document.getElementById('categories-tree').innerHTML = renderCategoriesTree(data.categories, {{ page.category.id if page.category else 'null' }});
        })
        .catch(error => {
            console.error('Error loading categories:', error);
        });
}

function renderCategoriesTree(categories, currentCategoryId, level = 0) {
    let html = '';

    categories.forEach(category => {
        const isActive = category.id === currentCategoryId;
        const hasChildren = category.children && category.children.length > 0;
        const indent = level * 20;

        html += `
            <div class="category-item" style="margin-left: ${indent}px;">
                <div class="category-link ${isActive ? 'active' : ''}">
                    <a href="/category/${category.id}" class="${isActive ? 'active-link' : ''}">
                        ${hasChildren ? '<i class="fas fa-chevron-right me-1"></i>' : '<i class="fas fa-folder me-1"></i>'}
                        ${category.name}
                    </a>
                    ${hasChildren ? `<button class="toggle-children btn btn-sm p-0 ms-1" onclick="toggleCategoryChildren(this, ${category.id})">
                        <i class="fas fa-chevron-down"></i>
                    </button>` : ''}
                </div>
                ${hasChildren ? `<div class="category-children" id="category-children-${category.id}">${renderCategoriesTree(category.children, currentCategoryId, level + 1)}</div>` : ''}
            </div>
        `;
    });

    return html;
}

function toggleCategoryChildren(button, categoryId) {
    const childrenDiv = document.getElementById(`category-children-${categoryId}`);
    const icon = button.querySelector('i');

    if (childrenDiv.style.display === 'none') {
        childrenDiv.style.display = 'block';
        icon.className = 'fas fa-chevron-down';
    } else {
        childrenDiv.style.display = 'none';
        icon.className = 'fas fa-chevron-right';
    }
}

function enableEditMode() {
    if (isEditMode) return;

    isEditMode = true;
    document.getElementById('view-mode').style.display = 'none';
    document.getElementById('edit-mode').style.display = 'block';
    document.getElementById('edit-button').style.display = 'none';

    // Focus on title field
    document.getElementById('edit-title').focus();
}

function cancelEdit() {
    if (!isEditMode) return;

    // Restore original content
    document.getElementById('edit-title').value = originalTitle;
    document.getElementById('edit-content').value = originalContent;

    // Switch back to view mode
    isEditMode = false;
    document.getElementById('view-mode').style.display = 'block';
    document.getElementById('edit-mode').style.display = 'none';
    document.getElementById('edit-button').style.display = 'inline-flex';
}

function setupMarkdownPreview() {
    const contentTextarea = document.getElementById('edit-content');
    const previewContent = document.getElementById('preview-content-display');

    if (!contentTextarea || !previewContent) return;

    contentTextarea.addEventListener('input', function() {
        updatePreview();
    });
}

function updatePreview() {
    const content = document.getElementById('edit-content').value;
    const previewContent = document.getElementById('preview-content-display');

    fetch('/wiki/preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: 'content=' + encodeURIComponent(content)
    })
    .then(response => response.text())
    .then(html => {
        previewContent.innerHTML = html;
    })
    .catch(error => {
        console.error('Error previewing markdown:', error);
        previewContent.innerHTML = '<p class="text-danger">预览错误</p>';
    });
}

function togglePreview() {
    const textarea = document.getElementById('edit-content');
    const preview = document.getElementById('edit-preview');
    const previewBtn = document.getElementById('preview-btn');

    if (preview.style.display === 'none') {
        preview.style.display = 'block';
        textarea.style.display = 'none';
        previewBtn.innerHTML = '<i class="fas fa-edit me-1"></i>编辑';
        updatePreview();
    } else {
        preview.style.display = 'none';
        textarea.style.display = 'block';
        previewBtn.innerHTML = '<i class="fas fa-eye me-1"></i>预览';
    }
}

function insertText(before, after) {
    const textarea = document.getElementById('edit-content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end);

    const newText = text.substring(0, start) + before + selectedText + after + text.substring(end);
    textarea.value = newText;

    // Set cursor position
    const newCursorPos = start + before.length + selectedText.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
}

function setupAutoSave() {
    let saveTimeout;

    document.getElementById('edit-content').addEventListener('input', function() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveDraft(true);
        }, 30000); // Auto-save every 30 seconds
    });
}

function saveDraft(isAuto = false) {
    const formData = new FormData(document.getElementById('edit-form'));
    formData.append('save_draft', 'true');

    fetch('/wiki/edit/{{ page.id }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (!isAuto) {
                showNotification('草稿已保存', 'success');
            }
        } else {
            showNotification('保存草稿失败: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving draft:', error);
        if (!isAuto) {
            showNotification('保存草稿失败', 'error');
        }
    });
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} notification-toast`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
    `;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
    `;

    document.body.appendChild(notification);

    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Form submission
document.getElementById('edit-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('/wiki/edit/{{ page.id }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('保存成功', 'success');
            // Reload the page to show updated content
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('保存失败: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving page:', error);
        showNotification('保存失败', 'error');
    });
});
</script>

<style>
/* Layout Styles */
.wiki-layout {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.page-header {
    background: #fff;
    border-bottom: 1px solid #e9ecef;
    padding: 1.5rem 0;
}

.header-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    color: #2c3e50;
}

.page-category {
    margin-top: 0.5rem;
}

.page-category a {
    color: #6c757d;
    text-decoration: none;
}

.page-category a:hover {
    color: #007bff;
}

.page-body {
    display: flex;
    flex: 1;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
}

/* Sidebar Styles */
.categories-sidebar {
    width: 280px;
    background: #f8f9fa;
    border-right: 1px solid #e9ecef;
    flex-shrink: 0;
}

.sidebar-header {
    padding: 1rem;
    background: #fff;
    border-bottom: 1px solid #e9ecef;
    font-weight: 600;
}

.sidebar-content {
    padding: 0.5rem 0;
}

.category-item {
    position: relative;
}

.category-link {
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    text-decoration: none;
    color: #495057;
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
}

.category-link:hover {
    background: #e9ecef;
    color: #007bff;
}

.category-link.active {
    background: #e3f2fd;
    border-left-color: #2196f3;
    color: #1976d2;
}

.category-link a {
    color: inherit;
    text-decoration: none;
    flex: 1;
}

.category-link.active-link {
    font-weight: 600;
}

.toggle-children {
    opacity: 0.5;
    transition: opacity 0.2s ease;
}

.toggle-children:hover {
    opacity: 1;
}

.category-children {
    background: #fff;
}

/* Main Content Styles */
.main-content {
    flex: 1;
    padding: 2rem;
    background: #fff;
}

.content-view, .content-edit {
    max-width: 800px;
    margin: 0 auto;
}

.page-meta {
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 1rem;
}

.content-body {
    font-size: 1.1rem;
    line-height: 1.7;
    color: #2c3e50;
    margin: 2rem 0;
}

/* Markdown Content Styling */
.content-body h1, .content-body h2, .content-body h3,
.content-body h4, .content-body h5, .content-body h6 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 600;
    line-height: 1.3;
}

.content-body h1 {
    font-size: 2rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

.content-body h2 {
    font-size: 1.5rem;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 0.3rem;
}

.content-body h3 {
    font-size: 1.25rem;
}

.content-body p {
    margin-bottom: 1.5rem;
}

.content-body code {
    background: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.9rem;
    color: #e83e8c;
}

.content-body pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 5px;
    padding: 1rem;
    overflow-x: auto;
    margin: 1.5rem 0;
}

.content-body blockquote {
    border-left: 4px solid #007bff;
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: #6c757d;
    font-style: italic;
}

.content-body ul, .content-body ol {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
}

.content-body li {
    margin-bottom: 0.5rem;
}

.content-body table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
}

.content-body th, .content-body td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
    text-align: left;
}

.content-body th {
    background: #f8f9fa;
    font-weight: 600;
}

.empty-content {
    text-align: center;
    padding: 4rem 2rem;
    color: #6c757d;
}

.page-tags {
    border-top: 1px solid #e9ecef;
    padding-top: 1rem;
    margin-top: 2rem;
}

/* Editor Styles */
.editor-wrapper {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.editor-toolbar {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    padding: 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.editor-textarea {
    border: 1px solid #dee2e6;
    border-radius: 0;
    resize: vertical;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
}

.editor-textarea:focus {
    box-shadow: none;
    border: 1px solid #dee2e6;
}

.editor-preview {
    border: 1px solid #dee2e6;
    border-top: none;
    background: #fff;
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
}

.preview-content {
    padding: 1rem;
    line-height: 1.6;
}

.editor-actions {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-top: none;
    padding: 1rem;
    border-radius: 0 0 8px 8px;
}

/* Notification Styles */
.notification-toast {
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: none;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .page-body {
        flex-direction: column;
    }

    .categories-sidebar {
        width: 100%;
        order: 2;
        border-right: none;
        border-top: 1px solid #e9ecef;
    }

    .main-content {
        order: 1;
        padding: 1rem;
    }

    .page-title {
        font-size: 1.75rem;
    }

    .content-view, .content-edit {
        padding: 0;
    }
}

/* Print Styles */
@media print {
    .categories-sidebar, .page-actions, .page-tags,
    .editor-actions, .notification-toast {
        display: none !important;
    }

    .wiki-layout {
        height: auto;
    }

    .main-content {
        overflow: visible;
        padding: 0;
    }

    .content-body {
        font-size: 12pt;
        line-height: 1.4;
    }
}
</style>
{% endblock %}