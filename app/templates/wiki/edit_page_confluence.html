{% extends "base_confluence.html" %}

{% block title %}{{ page.title }} - 编辑 - Enterprise Wiki{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="page-breadcrumb mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('wiki.index') }}" class="breadcrumb-link">
                    <i class="fas fa-home me-1"></i>
                    <span>空间</span>
                </a>
            </li>
            {% if page.category %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('wiki.category_view', category_id=page.category.id) }}" class="breadcrumb-link">
                    <i class="fas fa-folder me-1"></i>
                    <span>{{ page.category.name }}</span>
                </a>
            </li>
            {% endif %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('wiki.view_page', slug=page.slug) }}" class="breadcrumb-link">
                    {{ page.title }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <span class="breadcrumb-current">编辑</span>
            </li>
        </ol>
    </nav>
</div>

<!-- Page Header -->
<div class="page-header">
    <div class="page-header-top">
        <div class="page-title-section">
            <h1 class="page-title" id="pageTitle">{{ page.title }}</h1>
            <div class="page-status-badges">
                {% if page.is_published %}
                <span class="status-badge published">已发布</span>
                {% else %}
                <span class="status-badge draft">草稿</span>
                {% endif %}
                {% if page.is_public %}
                <span class="status-badge public">公开</span>
                {% else %}
                <span class="status-badge private">私有</span>
                {% endif %}
                {% if page.category %}
                <span class="status-badge category">
                    <i class="fas fa-folder me-1"></i>{{ page.category.name }}
                </span>
                {% endif %}
            </div>
        </div>

        <div class="page-actions">
            <a href="{{ url_for('wiki.view_page', slug=page.slug) }}" class="btn-wiki">
                <i class="fas fa-arrow-left me-2"></i>返回
            </a>

            {% if current_user.is_authenticated %}
            <button class="btn-wiki watch-btn"
                    data-target-type="page"
                    data-target-id="{{ page.id }}"
                    title="关注此页面">
                <i class="fas fa-eye me-2"></i>关注
            </button>
            {% endif %}

            <button class="btn-wiki" onclick="window.location.href='{{ url_for('wiki.page_history', page_id=page.id) }}'" title="查看历史">
                <i class="fas fa-history me-2"></i>历史
            </button>

            <button class="btn-wiki" onclick="copyToClipboard(window.location.href)" title="复制链接">
                <i class="fas fa-link me-2"></i>复制链接
            </button>

            <button class="btn-wiki" onclick="exportPage()" title="导出页面">
                <i class="fas fa-download me-2"></i>导出
            </button>

            <button class="btn-wiki" onclick="printPage()" title="打印页面">
                <i class="fas fa-print me-2"></i>打印
            </button>

            <button type="submit" form="editPageForm" class="btn-wiki primary">
                <i class="fas fa-save me-2"></i>保存
            </button>

            {% if current_user.is_authenticated and current_user.is_administrator() %}
            <button class="btn-wiki danger" onclick="deletePage({{ page.id }})" title="删除页面">
                <i class="fas fa-trash me-2"></i>删除
            </button>
            {% endif %}
        </div>
    </div>

    <div class="page-meta">
        <div class="meta-item">
            <i class="fas fa-user me-1"></i>
            <span>创建者 <strong>{{ page.author.username if page.author else '未知' }}</strong></span>
            <span class="meta-date">{{ page.created_at.strftime('%B %d, %Y') if page.created_at else '' }}</span>
        </div>
        {% if page.last_editor and page.last_editor.id != page.author.id %}
        <div class="meta-item">
            <i class="fas fa-edit me-1"></i>
            <span>最后编辑者 <strong>{{ page.last_editor.username }}</strong></span>
            <span class="meta-date">{{ page.updated_at.strftime('%B %d, %Y at %I:%M %p') if page.updated_at else '' }}</span>
        </div>
        {% elif page.updated_at != page.created_at %}
        <div class="meta-item">
            <i class="fas fa-edit me-1"></i>
            <span>最后编辑</span>
            <span class="meta-date">{{ page.updated_at.strftime('%B %d, %Y at %I:%M %p') if page.updated_at else '' }}</span>
        </div>
        {% endif %}
        <div class="meta-item">
            <i class="fas fa-eye me-1"></i>
            <span>{{ page.view_count }} 次查看</span>
        </div>
    </div>
</div>

<div class="page-content">
    <form method="POST" name="page_form" id="editPageForm">
        {{ form.hidden_tag() }}

        <!-- Page Content Card -->
        <div class="content-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>页面内容
                    </h5>
                    <div class="editor-toolbar">
                        <button type="button" class="btn-wiki small" id="togglePreview">
                            <i class="fas fa-eye me-1"></i>预览
                        </button>
                        <button type="button" class="btn-wiki small" id="toggleFullscreen">
                            <i class="fas fa-expand me-1"></i>全屏
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Title Input -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="form-group">
                            {{ form.title.label(class="form-label required") }}
                            {{ form.title(class="form-control form-control-lg" + (" is-invalid" if form.title.errors else ""), placeholder="请输入页面标题...") }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form.category_id.label(class="form-label") }}
                            {{ form.category_id(class="form-select" + (" is-invalid" if form.category_id.errors else "")) }}
                            {% if form.category_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category_id.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Summary Input -->
                <div class="form-group mb-4">
                    {{ form.summary.label(class="form-label") }}
                    {{ form.summary(class="form-control" + (" is-invalid" if form.summary.errors else ""), placeholder="页面简要描述（可选）...") }}
                    {% if form.summary.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.summary.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">页面简要描述（可选，最多500个字符）</small>
                </div>

                <!-- Change Summary Input -->
                <div class="form-group mb-4">
                    {{ form.change_summary.label(class="form-label") }}
                    {{ form.change_summary(class="form-control" + (" is-invalid" if form.change_summary.errors else ""), placeholder="描述您在此编辑中更改的内容...") }}
                    {% if form.change_summary.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.change_summary.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text text-muted">描述您在此编辑中更改的内容（可选，最多255个字符）</small>
                </div>

                <!-- Markdown Editor -->
                <div class="form-group">
                    {{ form.content.label(class="form-label required") }}
                    <div class="editor-container" id="markdownEditor">
                        <div class="editor-toolbar">
                            <div class="btn-group">
                                <button type="button" class="btn-wiki small" data-command="bold" title="粗体 (Ctrl+B)">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="italic" title="斜体 (Ctrl+I)">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="heading" title="标题">
                                    <i class="fas fa-heading"></i>
                                </button>
                                <div class="divider"></div>
                                <button type="button" class="btn-wiki small" data-command="link" title="链接">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="image" title="图片">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="code" title="代码">
                                    <i class="fas fa-code"></i>
                                </button>
                                <div class="divider"></div>
                                <button type="button" class="btn-wiki small" data-command="ul" title="无序列表">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="ol" title="有序列表">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="quote" title="引用">
                                    <i class="fas fa-quote-left"></i>
                                </button>
                                <div class="divider"></div>
                                <button type="button" class="btn-wiki small" data-command="preview" title="切换预览">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn-wiki small" data-command="fullscreen" title="全屏">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <div class="editor-pane">
                                {{ form.content(class="editor-input", id="contentInput", rows=20, placeholder="开始使用Markdown编写您的页面内容...") }}
                            </div>
                            <div class="editor-pane editor-preview" id="previewPane">
                                <div class="preview-content" id="previewContent">
                                    <p class="text-muted">预览将在您输入时显示在这里...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if form.content.errors %}
                        <div class="text-danger mt-1">
                            {% for error in form.content.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

            </div>
        </div>

        <!-- Publishing Options Card -->
        <div class="content-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>发布选项
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            {{ form.is_published(class="form-check-input") }}
                            {{ form.is_published.label(class="form-check-label") }}
                        </div>
                        <small class="form-text text-muted">已发布的页面对其他用户可见</small>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            {{ form.is_public(class="form-check-input") }}
                            {{ form.is_public.label(class="form-check-label") }}
                        </div>
                        <small class="form-text text-muted">公开页面无需登录即可查看</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Information Card -->
        <div class="content-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>页面信息
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <strong>创建时间：</strong><br>
                            <small class="text-muted">{{ page.created_at.strftime('%Y-%m-%d %H:%M') }} 创建者：{{ page.author.username if page.author else '未知' }}</small>
                        </div>
                        <div class="mb-3">
                            <strong>最后修改：</strong><br>
                            <small class="text-muted">{{ page.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <strong>查看次数：</strong><br>
                            <small class="text-muted">{{ page.view_count }} 次查看</small>
                        </div>
                        <div class="mb-3">
                            <strong>版本历史：</strong><br>
                            <small class="text-muted">{{ page.versions.count() }} 个版本</small>
                            <a href="{{ url_for('wiki.page_history', page_id=page.id) }}" class="btn-wiki small ms-2">
                                <i class="fas fa-history me-1"></i>查看历史
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Attachments Card -->
        <div class="content-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-paperclip me-2"></i>文件附件
                </h5>
            </div>
            <div class="card-body">
                <div class="file-upload-area" id="fileUploadArea">
                    <div class="upload-zone" id="uploadZone">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">拖放文件到此处或点击浏览</h6>
                        <p class="text-muted small">支持的格式：PDF、DOC、DOCX、XLS、XLSX、PPT、PPTX、TXT、PNG、JPG、GIF</p>
                        <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.png,.jpg,.jpeg,.gif" style="display: none;">
                        <button type="button" class="btn-wiki small" id="browseFilesBtn">
                            <i class="fas fa-folder-open me-1"></i>浏览文件
                        </button>
                    </div>
                    <div id="fileList" class="file-list mt-3" style="display: none;">
                        <h6 class="mb-3">已附加文件：</h6>
                        <div class="list-group" id="fileListContainer"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="content-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button type="submit" class="btn-wiki primary" id="saveButton">
                            <i class="fas fa-save me-2"></i>保存更改
                        </button>
                        <button type="submit" name="save_draft" value="true" class="btn-wiki">
                            <i class="fas fa-save me-2"></i>保存草稿
                        </button>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="{{ url_for('wiki.view_page', slug=page.slug) }}" class="btn-wiki secondary">
                            <i class="fas fa-times me-2"></i>取消
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block styles %}
<style>
.required:after {
    content: " *";
    color: var(--danger-color);
}

.editor-container {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.editor-toolbar {
    background: var(--sidebar-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 8px 12px;
}

.btn-group {
    display: flex;
    align-items: center;
    gap: 4px;
}

.btn-group .divider {
    width: 1px;
    height: 20px;
    background: var(--border-color);
    margin: 0 4px;
}

.editor-content {
    display: flex;
    height: 500px;
}

.editor-pane {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
}

.editor-input {
    width: 100%;
    height: 100%;
    border: none;
    outline: none;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
    resize: none;
    background: transparent;
}

.editor-preview {
    border-left: 1px solid var(--border-color);
    background: #fafafa;
}

.preview-content {
    padding: 16px;
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-primary);
}

/* File Upload Styles */
.upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background: var(--sidebar-bg);
}

.upload-zone:hover {
    border-color: var(--primary-color);
    background: #f8f9fa;
}

.upload-zone.dragover {
    border-color: var(--primary-color);
    background: #e3f2fd;
}

.upload-zone h6 {
    margin-bottom: 8px;
}

.file-list .list-group-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    margin-bottom: 8px;
    border-radius: 6px;
}

.file-info {
    display: flex;
    align-items: center;
    flex-grow: 1;
}

.file-icon {
    margin-right: 12px;
    font-size: 1.2em;
    color: var(--primary-color);
}

.file-details .file-name {
    font-weight: 500;
    margin-bottom: 2px;
}

.file-details .file-size {
    font-size: 0.875em;
    color: var(--text-secondary);
}

.file-actions {
    display: flex;
    gap: 8px;
}

.btn-remove-file {
    background: none;
    border: none;
    color: var(--danger-color);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.btn-remove-file:hover {
    background-color: #ffebee;
}

.upload-progress {
    width: 100%;
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 8px;
}

.upload-progress-bar {
    height: 100%;
    background: var(--primary-color);
    width: 0%;
    transition: width 0.3s ease;
}

.preview-content h1, .preview-content h2, .preview-content h3,
.preview-content h4, .preview-content h5, .preview-content h6 {
    margin-top: 0;
    margin-bottom: 16px;
    font-weight: 600;
}

.preview-content h1 { font-size: 2em; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
.preview-content h2 { font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 6px; }
.preview-content h3 { font-size: 1.25em; }
.preview-content h4 { font-size: 1em; }
.preview-content h5 { font-size: 0.875em; }
.preview-content h6 { font-size: 0.75em; }

.preview-content p {
    margin-bottom: 16px;
}

.preview-content ul, .preview-content ol {
    margin-bottom: 16px;
    padding-left: 24px;
}

.preview-content li {
    margin-bottom: 4px;
}

.preview-content blockquote {
    border-left: 4px solid var(--primary-color);
    padding-left: 16px;
    margin: 16px 0;
    color: var(--text-secondary);
    font-style: italic;
}

.preview-content pre {
    background: #f6f8fa;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 12px;
    overflow-x: auto;
    margin-bottom: 16px;
}

.preview-content code {
    background: #f6f8fa;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 2px 4px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
}

.preview-content pre code {
    background: transparent;
    border: none;
    padding: 0;
}

.preview-content table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 16px;
}

.preview-content th, .preview-content td {
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    text-align: left;
}

.preview-content th {
    background: var(--sidebar-bg);
    font-weight: 600;
}

.fullscreen .editor-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: flex;
    flex-direction: column;
}

.fullscreen .editor-content {
    flex: 1;
}

.fullscreen .editor-toolbar {
    border-bottom: 1px solid var(--border-color);
}

.editor-toolbar .btn-wiki.small {
    padding: 4px 8px;
    font-size: 12px;
    min-height: auto;
}

.editor-toolbar .btn-wiki.small i {
    font-size: 12px;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentInput = document.getElementById('contentInput');
    const previewContent = document.getElementById('previewContent');
    const previewPane = document.getElementById('previewPane');
    const form = document.getElementById('editPageForm');
    const saveButton = document.getElementById('saveButton');

    // Preview functionality
    function updatePreview() {
        const content = contentInput.value;
        if (content.trim()) {
            previewContent.innerHTML = marked.parse(content);
        } else {
            previewContent.innerHTML = '<p class="text-muted">预览将在您输入时显示在这里...</p>';
        }
    }

    // Auto-preview as user types
    let previewTimeout;
    contentInput.addEventListener('input', function() {
        clearTimeout(previewTimeout);
        previewTimeout = setTimeout(updatePreview, 300);
    });

    // Initial preview
    updatePreview();

    // Toolbar functionality
    const toolbarButtons = document.querySelectorAll('.editor-toolbar .btn-wiki[data-command]');
    toolbarButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const command = this.dataset.command;
            handleCommand(command);
        });
    });

    function handleCommand(command) {
        switch(command) {
            case 'bold':
                insertText('**', '**', '粗体文本');
                break;
            case 'italic':
                insertText('*', '*', '斜体文本');
                break;
            case 'heading':
                insertText('## ', '', '标题');
                break;
            case 'link':
                insertText('[', '](url)', '链接文本');
                break;
            case 'image':
                insertText('![', '](image-url)', '替代文本');
                break;
            case 'code':
                insertText('`', '`', '代码');
                break;
            case 'ul':
                insertText('- ', '', '列表项');
                break;
            case 'ol':
                insertText('1. ', '', '编号项');
                break;
            case 'quote':
                insertText('> ', '', '引用');
                break;
            case 'preview':
                togglePreview();
                break;
            case 'fullscreen':
                toggleFullscreen();
                break;
        }
    }

    function insertText(before, after, placeholder) {
        const start = contentInput.selectionStart;
        const end = contentInput.selectionEnd;
        const selectedText = contentInput.value.substring(start, end);
        const text = selectedText || placeholder;
        const newText = before + text + after;

        contentInput.value = contentInput.value.substring(0, start) + newText + contentInput.value.substring(end);
        contentInput.selectionStart = start + before.length;
        contentInput.selectionEnd = start + before.length + text.length;
        contentInput.focus();

        updatePreview();
    }

    function togglePreview() {
        previewPane.style.display = previewPane.style.display === 'none' ? 'block' : 'none';
    }

    function toggleFullscreen() {
        document.body.classList.toggle('fullscreen');
        const fullscreenBtn = document.querySelector('[data-command="fullscreen"] i');
        if (document.body.classList.contains('fullscreen')) {
            fullscreenBtn.className = 'fas fa-compress';
        } else {
            fullscreenBtn.className = 'fas fa-expand';
        }
    }

    // Form validation
    form.addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const content = contentInput.value.trim();

        if (!title) {
            e.preventDefault();
            showToast('请输入页面标题', 'warning');
            document.getElementById('title').focus();
            return;
        }

        if (!content) {
            e.preventDefault();
            showToast('请输入页面内容', 'warning');
            contentInput.focus();
            return;
        }
    });

    // Keyboard shortcuts
    contentInput.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    form.submit();
                    break;
                case 'b':
                    e.preventDefault();
                    handleCommand('bold');
                    break;
                case 'i':
                    e.preventDefault();
                    handleCommand('italic');
                    break;
            }
        }
    });

    // File upload functionality
    const fileInput = document.getElementById('fileInput');
    const uploadZone = document.getElementById('uploadZone');
    const browseFilesBtn = document.getElementById('browseFilesBtn');
    const fileList = document.getElementById('fileList');
    const fileListContainer = document.getElementById('fileListContainer');
    let uploadedFiles = [];

    // Click to browse files
    browseFilesBtn.addEventListener('click', function(e) {
        e.preventDefault();
        fileInput.click();
    });

    uploadZone.addEventListener('click', function(e) {
        if (e.target !== browseFilesBtn) {
            fileInput.click();
        }
    });

    // Handle file selection
    fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });

    // Drag and drop functionality
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        Array.from(files).forEach(file => {
            if (validateFile(file)) {
                uploadFile(file);
            }
        });
    }

    function validateFile(file) {
        const allowedTypes = [
            'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
            'text/plain', 'image/png', 'image/jpeg', 'image/gif'
        ];

        const maxSize = 10 * 1024 * 1024; // 10MB

        if (!allowedTypes.includes(file.type)) {
            showToast('不支持的文件类型：' + file.name, 'error');
            return false;
        }

        if (file.size > maxSize) {
            showToast('文件过大（最大10MB）：' + file.name, 'error');
            return false;
        }

        return true;
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('page_id', '{{ page.id }}'); // Associate with current page

        // Create file item in UI
        const fileId = 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const fileItem = createFileItem(fileId, file);
        fileListContainer.appendChild(fileItem);
        fileList.style.display = 'block';

        // Upload file
        fetch('/api/upload', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Update file item with server data
                uploadedFiles.push({
                    id: data.id,
                    filename: data.filename,
                    original_filename: data.original_filename,
                    url: data.url
                });
                updateFileItem(fileId, file, data);
                showToast('文件上传成功：' + file.name, 'success');
            } else {
                throw new Error(data.error || '上传失败');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            removeFileItem(fileId);
            showToast('文件上传失败：' + file.name, 'error');
        });
    }

    function createFileItem(fileId, file) {
        const fileItem = document.createElement('div');
        fileItem.className = 'list-group-item';
        fileItem.id = fileId;

        const fileIcon = getFileIcon(file.type);
        const fileSize = formatFileSize(file.size);

        fileItem.innerHTML = `
            <div class="file-info">
                <i class="file-icon ${fileIcon}"></i>
                <div class="file-details">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
            </div>
            <div class="file-actions">
                <div class="upload-progress">
                    <div class="upload-progress-bar"></div>
                </div>
                <button type="button" class="btn-remove-file" onclick="removeFileItem('${fileId}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        return fileItem;
    }

    function updateFileItem(fileId, file, data) {
        const fileItem = document.getElementById(fileId);
        if (fileItem) {
            const progressBar = fileItem.querySelector('.upload-progress-bar');
            if (progressBar) {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.parentElement.style.display = 'none';
                }, 500);
            }
        }
    }

    function removeFileItem(fileId) {
        const fileItem = document.getElementById(fileId);
        if (fileItem) {
            // Remove from uploaded files array
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId.replace('file_', ''));
            fileItem.remove();

            // Hide file list if empty
            if (fileListContainer.children.length === 0) {
                fileList.style.display = 'none';
            }
        }
    }

    function getFileIcon(fileType) {
        if (fileType.includes('pdf')) return 'fas fa-file-pdf';
        if (fileType.includes('word') || fileType.includes('document')) return 'fas fa-file-word';
        if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel';
        if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'fas fa-file-powerpoint';
        if (fileType.includes('text')) return 'fas fa-file-alt';
        if (fileType.includes('image')) return 'fas fa-file-image';
        return 'fas fa-file';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Toast notification function (reuse from base template)
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
});
</script>

<style>
/* Page Header Styles - Consistent with page_confluence.html */
.page-status-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-badge.published {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-badge.draft {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.status-badge.public {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.status-badge.private {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.status-badge.category {
    background-color: #e2e3e5;
    color: #383d41;
    border: 1px solid #d6d8db;
}

.status-badge.editing {
    background-color: #cce5ff;
    color: #004085;
    border: 1px solid #b3d7ff;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
    }
}

.page-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-color, #e9ecef);
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary, #6b778c);
}

.meta-item i {
    color: var(--text-muted, #8992a4);
}

.meta-item strong {
    color: var(--text-primary, #172b4d);
    font-weight: 600;
}

.meta-date {
    color: var(--text-muted, #8992a4);
    font-size: 13px;
}
</style>

<!-- Enhanced Editor Component -->
{% include 'components/enhanced_editor.html' %}

<!-- Page Functions -->
<script>
// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('链接已复制到剪贴板', 'success');
    }).catch(err => {
        console.error('复制失败:', err);
        showToast('复制失败', 'error');
    });
}

// Export page function
function exportPage() {
    showToast('导出功能暂不可用', 'info');
}

// Print page function
function printPage() {
    window.print();
}

// Delete page function
function deletePage(pageId) {
    if (confirm('确定要删除此页面吗？此操作不可恢复。')) {
        showToast('删除功能暂不可用', 'info');
    }
}

// Toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}