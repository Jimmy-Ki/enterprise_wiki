{% extends "base_confluence.html" %}

{% block title %}{{ page.title }} - Enterprise Wiki{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="page-breadcrumb mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('wiki.index') }}" class="breadcrumb-link">
                    <i class="fas fa-home me-1"></i>
                    <span>Spaces</span>
                </a>
            </li>
            {% if page.category %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('wiki.category_view', category_id=page.category.id) }}" class="breadcrumb-link">
                    <i class="fas fa-folder me-1"></i>
                    <span>{{ page.category.name }}</span>
                </a>
            </li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">
                <span class="breadcrumb-current">{{ page.title }}</span>
            </li>
        </ol>
    </nav>
</div>

<!-- Page Header -->
<div class="page-header">
    <div class="page-header-top">
        <div class="page-title-section">
            <h1 class="page-title" id="pageTitle">{{ page.title }}</h1>
            <div class="page-status-badges">
                {% if page.is_published %}
                <span class="status-badge published">Published</span>
                {% else %}
                <span class="status-badge draft">Draft</span>
                {% endif %}
                {% if page.is_public %}
                <span class="status-badge public">Public</span>
                {% else %}
                <span class="status-badge private">Private</span>
                {% endif %}
                {% if page.category %}
                <span class="status-badge category">
                    <i class="fas fa-folder me-1"></i>{{ page.category.name }}
                </span>
                {% endif %}
            </div>
        </div>

        <div class="page-actions">
            <button class="btn-wiki" onclick="enableEditMode()" id="editBtn">
                <i class="fas fa-edit me-2"></i>Edit
            </button>

            {% if current_user.is_authenticated %}
            <button class="btn-wiki watch-btn"
                    data-target-type="page"
                    data-target-id="{{ page.id }}"
                    title="关注此页面">
                <i class="fas fa-eye me-2"></i>Watch
            </button>
            {% endif %}

            <button class="btn-wiki" onclick="window.location.href='{{ url_for('wiki.page_history', page_id=page.id) }}'" title="View History">
                <i class="fas fa-history me-2"></i>History
            </button>

            <button class="btn-wiki" onclick="copyToClipboard(window.location.href)" title="Copy Link">
                <i class="fas fa-link me-2"></i>Copy Link
            </button>

            <button class="btn-wiki" onclick="exportPage()" title="Export Page">
                <i class="fas fa-download me-2"></i>Export
            </button>

            <button class="btn-wiki" onclick="printPage()" title="Print Page">
                <i class="fas fa-print me-2"></i>Print
            </button>

            {% if current_user.is_authenticated and current_user.is_administrator() %}
            <button class="btn-wiki danger" onclick="deletePage({{ page.id }})" title="Delete Page">
                <i class="fas fa-trash me-2"></i>Delete
            </button>
            {% endif %}
        </div>
    </div>

    <div class="page-meta">
        <div class="meta-item">
            <i class="fas fa-user me-1"></i>
            <span>Created by <strong>{{ page.author.username if page.author else 'Unknown' }}</strong></span>
            <span class="meta-date">{{ page.created_at.strftime('%B %d, %Y') }}</span>
        </div>
        {% if page.last_editor and page.last_editor.id != page.author.id %}
        <div class="meta-item">
            <i class="fas fa-edit me-1"></i>
            <span>Last edited by <strong>{{ page.last_editor.username }}</strong></span>
            <span class="meta-date">{{ page.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
        </div>
        {% elif page.updated_at != page.created_at %}
        <div class="meta-item">
            <i class="fas fa-edit me-1"></i>
            <span>Last edited</span>
            <span class="meta-date">{{ page.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
        </div>
        {% endif %}
        <div class="meta-item">
            <i class="fas fa-eye me-1"></i>
            <span>{{ page.view_count }} views</span>
        </div>
    </div>
</div>

<!-- Page Content Display -->
<div id="contentDisplay" class="content-display">
    {% if page.content_html %}
    {{ page.content_html | safe }}
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No content yet</h5>
        <p class="text-muted">
            This page doesn't have any content yet.
            {% if current_user.is_authenticated and page.can_edit(current_user) %}
            <button class="btn-wiki primary" onclick="enableEditMode()">
                <i class="fas fa-plus me-2"></i>Add content
            </button>
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>

<!-- Content Editor (Hidden by default) -->
<div id="contentEditor" class="content-editor" style="display: none;">
    <div class="editor-toolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="formatText('bold')" title="Bold (Ctrl+B)">
                <i class="fas fa-bold"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('italic')" title="Italic (Ctrl+I)">
                <i class="fas fa-italic"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('heading')" title="Heading">
                <i class="fas fa-heading"></i>
            </button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="formatText('link')" title="Link (Ctrl+K)">
                <i class="fas fa-link"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('image')" title="Image">
                <i class="fas fa-image"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('code')" title="Code">
                <i class="fas fa-code"></i>
            </button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="formatText('ul')" title="Bullet List">
                <i class="fas fa-list-ul"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('ol')" title="Numbered List">
                <i class="fas fa-list-ol"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('quote')" title="Quote">
                <i class="fas fa-quote-left"></i>
            </button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" id="previewToggle" onclick="togglePreview()" title="Toggle Preview">
                <i class="fas fa-eye"></i>
            </button>
            <button class="toolbar-btn" onclick="insertFullscreen()" title="Fullscreen">
                <i class="fas fa-expand"></i>
            </button>
        </div>
    </div>

    <div class="editor-content">
        <div class="editor-pane">
            <textarea id="markdownInput" class="editor-input" placeholder="Start writing in Markdown...">{{ page.content or '' }}</textarea>
        </div>
        <div class="editor-preview" id="previewPane" style="display: none;">
            <div id="previewContent"></div>
        </div>
    </div>
</div>

<!-- Editor Actions -->
<div id="editorActions" class="page-actions" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <input type="text" id="changeSummary" class="form-control" placeholder="Describe what you changed..." style="width: 300px;">
        </div>
        <div class="d-flex gap-2">
            <button class="btn-wiki" onclick="cancelEdit()">
                <i class="fas fa-times me-2"></i>Cancel
            </button>
            <button class="btn-wiki" onclick="saveDraft()">
                <i class="fas fa-save me-2"></i>Save Draft
            </button>
            <button class="btn-wiki primary" onclick="savePage()">
                <i class="fas fa-check me-2"></i>Save
            </button>
        </div>
    </div>
</div>

<!-- File Upload Section (shown during editing) -->
<div id="fileUploadSection" class="card mt-4" style="display: none; border: 1px solid var(--border-color);">
    <div class="card-header" style="background: var(--sidebar-bg); border-bottom: 1px solid var(--border-color);">
        <h6 class="mb-0">
            <i class="fas fa-paperclip me-2"></i>Upload Files
        </h6>
    </div>
    <div class="card-body">
        <div class="file-upload-area" id="inlineFileUploadArea">
            <div class="upload-zone" id="inlineUploadZone">
                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                <h6 class="text-muted">Drop files here or click to browse</h6>
                <p class="text-muted small">Supported formats: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, PNG, JPG, GIF</p>
                <input type="file" id="inlineFileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.png,.jpg,.jpeg,.gif" style="display: none;">
                <button type="button" class="btn-wiki small" id="inlineBrowseFilesBtn">
                    <i class="fas fa-folder-open me-1"></i>Browse Files
                </button>
            </div>
            <div id="inlineFileList" class="file-list mt-3" style="display: none;">
                <h6 class="mb-3">Uploaded Files:</h6>
                <div class="list-group" id="inlineFileListContainer"></div>
            </div>
        </div>
    </div>
</div>

<!-- Attachments Section -->
{% if attachments %}
<div class="card mt-4" style="border: 1px solid var(--border-color);">
    <div class="card-header" style="background: var(--sidebar-bg); border-bottom: 1px solid var(--border-color);">
        <h6 class="mb-0">
            <i class="fas fa-paperclip me-2"></i>Attachments ({{ attachments|length }})
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            {% for attachment in attachments %}
            <div class="col-md-6 mb-3">
                <div class="card h-100" style="border: 1px solid var(--border-color);">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                {% if attachment.is_image() %}
                                <img src="{{ url_for('api.download_attachment', attachment_id=attachment.id) }}"
                                     alt="{{ attachment.original_filename }}"
                                     class="img-thumbnail" style="max-width: 60px; max-height: 60px;">
                                {% else %}
                                <i class="fas fa-file fa-2x text-muted"></i>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ attachment.original_filename }}</h6>
                                <small class="text-muted">
                                    {{ attachment.get_size_display() }}
                                    • {{ attachment.uploaded_at.strftime('%Y-%m-%d') }}
                                </small>
                            </div>
                            <div>
                                <a href="{{ url_for('api.download_attachment', attachment_id=attachment.id, download=1) }}"
                                   class="btn-wiki" title="Download {{ attachment.original_filename }}">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                        {% if attachment.description %}
                        <p class="mt-2 mb-0 small text-muted">{{ attachment.description }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Page Summary -->
{% if page.summary %}
<div class="alert alert-light mt-4" style="background: var(--sidebar-bg); border: 1px solid var(--border-color);">
    <h6><i class="fas fa-info-circle me-2"></i>Summary</h6>
    <p class="mb-0">{{ page.summary }}</p>
</div>
{% endif %}

<!-- Comments Section -->
{% include 'components/comments.html' with context %}
{% endblock %}

{% block scripts %}
<script>
let editor = null;
let isPreviewMode = false;
let uploadedInlineFiles = [];

document.addEventListener('DOMContentLoaded', function() {
    // Set current page ID for editing functionality
    window.wikiState.currentPageId = {{ page.id }};

    // Enable click-to-edit functionality
    enableClickToEdit();

    // Initialize inline file upload functionality
    initializeInlineFileUpload();

    // Initialize CodeMirror if we have the markdown input
    const markdownInput = document.getElementById('markdownInput');
    if (markdownInput) {
        editor = CodeMirror.fromTextArea(markdownInput, {
            mode: 'markdown',
            theme: 'default',
            lineNumbers: true,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false
        });

        // Auto-save functionality
        let autoSaveTimer;
        editor.on('change', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(autoSave, 2000);

            if (isPreviewMode) {
                updatePreview();
            }
        });

        // Keyboard shortcuts
        editor.setOption('extraKeys', {
            'Ctrl-B': function() { formatText('bold'); },
            'Cmd-B': function() { formatText('bold'); },
            'Ctrl-I': function() { formatText('italic'); },
            'Cmd-I': function() { formatText('italic'); },
            'Ctrl-K': function() { formatText('link'); },
            'Cmd-K': function() { formatText('link'); },
            'Ctrl-S': function() { savePage(); },
            'Cmd-S': function() { savePage(); },
            'Escape': function() { cancelEdit(); }
        });
    }
});

function enableEditMode() {
    if (window.wikiState.isEditing) return;

    window.wikiState.isEditing = true;
    window.wikiState.originalContent = editor ? editor.getValue() : document.getElementById('markdownInput').value;

    // Hide display, show editor
    document.getElementById('contentDisplay').style.display = 'none';
    document.getElementById('contentEditor').style.display = 'block';
    document.getElementById('editorActions').style.display = 'block';
    document.getElementById('fileUploadSection').style.display = 'block';

    // Update button
    const editBtn = document.getElementById('editBtn');
    editBtn.innerHTML = '<i class="fas fa-times me-2"></i>Cancel';
    editBtn.onclick = cancelEdit;

    // Focus editor
    if (editor) {
        editor.refresh();
        editor.focus();
    }

    // Add editing class to body
    document.body.classList.add('editing-mode');
}

function cancelEdit() {
    if (!window.wikiState.isEditing) return;

    // Check for unsaved changes
    const currentContent = editor ? editor.getValue() : document.getElementById('markdownInput').value;
    if (currentContent !== window.wikiState.originalContent) {
        if (!confirm('You have unsaved changes. Are you sure you want to cancel?')) {
            return;
        }
    }

    window.wikiState.isEditing = false;

    // Show display, hide editor
    document.getElementById('contentDisplay').style.display = 'block';
    document.getElementById('contentEditor').style.display = 'none';
    document.getElementById('editorActions').style.display = 'none';
    document.getElementById('fileUploadSection').style.display = 'none';

    // Update button
    const editBtn = document.getElementById('editBtn');
    editBtn.innerHTML = '<i class="fas fa-edit me-2"></i>Edit';
    editBtn.onclick = enableEditMode;

    // Remove editing class
    document.body.classList.remove('editing-mode');
}

function savePage() {
    const content = editor ? editor.getValue() : document.getElementById('markdownInput').value;
    const changeSummary = document.getElementById('changeSummary').value;

    // Prepare uploaded files data
    const uploadedFiles = uploadedInlineFiles.map(file => ({
        id: file.id,
        filename: file.filename,
        original_filename: file.original_filename
    }));

    fetch(`/api/pages/{{ page.id }}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({
            content: content,
            change_summary: changeSummary,
            save_draft: false,
            uploaded_files: uploadedFiles
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.wikiState.isEditing = false;
            window.wikiState.currentContent = content;

            // Update the display
            document.getElementById('contentDisplay').innerHTML = data.rendered_content;

            // Hide editor, show display
            document.getElementById('contentDisplay').style.display = 'block';
            document.getElementById('contentEditor').style.display = 'none';
            document.getElementById('editorActions').style.display = 'none';
            document.getElementById('fileUploadSection').style.display = 'none';

            // Update button
            const editBtn = document.getElementById('editBtn');
            editBtn.innerHTML = '<i class="fas fa-edit me-2"></i>Edit';
            editBtn.onclick = enableEditMode;

            showToast('Page saved successfully!', 'success');

            // Re-enable click-to-edit
            enableClickToEdit();
        } else {
            showToast(data.error || 'Error saving page', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving page:', error);
        showToast('Error saving page', 'error');
    });
}

function saveDraft() {
    const content = editor ? editor.getValue() : document.getElementById('markdownInput').value;

    // Prepare uploaded files data
    const uploadedFiles = uploadedInlineFiles.map(file => ({
        id: file.id,
        filename: file.filename,
        original_filename: file.original_filename
    }));

    fetch(`/api/pages/{{ page.id }}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({
            content: content,
            save_draft: true,
            uploaded_files: uploadedFiles
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Draft saved', 'success');
        } else {
            showToast('Error saving draft', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving draft:', error);
        showToast('Error saving draft', 'error');
    });
}

function formatText(format) {
    if (!editor) return;

    const cursor = editor.getCursor();
    let text = '';
    let replaceText = '';

    switch(format) {
        case 'bold':
            text = editor.getSelection() || 'bold text';
            replaceText = `**${text}**`;
            break;
        case 'italic':
            text = editor.getSelection() || 'italic text';
            replaceText = `*${text}*`;
            break;
        case 'heading':
            text = editor.getSelection() || 'Heading';
            replaceText = `## ${text}`;
            break;
        case 'link':
            const url = prompt('Enter URL:');
            if (url) {
                text = editor.getSelection() || 'link text';
                replaceText = `[${text}](${url})`;
            }
            break;
        case 'image':
            const imageUrl = prompt('Enter image URL:');
            if (imageUrl) {
                const alt = prompt('Enter alt text:', 'image');
                replaceText = `![${alt}](${imageUrl})`;
            }
            break;
        case 'code':
            text = editor.getSelection() || 'code';
            replaceText = `\`${text}\``;
            break;
        case 'ul':
            replaceText = '- List item';
            break;
        case 'ol':
            replaceText = '1. List item';
            break;
        case 'quote':
            text = editor.getSelection() || 'Quote';
            replaceText = `> ${text}`;
            break;
    }

    if (replaceText) {
        editor.replaceSelection(replaceText);
        editor.focus();
    }
}

function togglePreview() {
    isPreviewMode = !isPreviewMode;
    const previewPane = document.getElementById('previewPane');
    const previewToggle = document.getElementById('previewToggle');

    if (isPreviewMode) {
        previewPane.style.display = 'block';
        previewToggle.classList.add('active');
        updatePreview();
    } else {
        previewPane.style.display = 'none';
        previewToggle.classList.remove('active');
    }
}

function updatePreview() {
    const content = editor ? editor.getValue() : document.getElementById('markdownInput').value;
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = marked.parse(content);
}

function insertFullscreen() {
    const editorContainer = document.querySelector('.content-editor');
    if (editorContainer) {
        editorContainer.classList.toggle('fullscreen');
    }
}

function autoSave() {
    const content = editor ? editor.getValue() : document.getElementById('markdownInput').value;
    localStorage.setItem('page_draft_{{ page.id }}', JSON.stringify({
        content: content,
        timestamp: new Date().toISOString()
    }));

    // Show save indicator
    showToast('Draft auto-saved', 'info');
}

function initializeInlineFileUpload() {
    const fileInput = document.getElementById('inlineFileInput');
    const uploadZone = document.getElementById('inlineUploadZone');
    const browseFilesBtn = document.getElementById('inlineBrowseFilesBtn');
    const fileList = document.getElementById('inlineFileList');
    const fileListContainer = document.getElementById('inlineFileListContainer');

    if (!fileInput || !uploadZone) return;

    // Click to browse files
    browseFilesBtn.addEventListener('click', function(e) {
        e.preventDefault();
        fileInput.click();
    });

    uploadZone.addEventListener('click', function(e) {
        if (e.target !== browseFilesBtn) {
            fileInput.click();
        }
    });

    // Handle file selection
    fileInput.addEventListener('change', function(e) {
        handleInlineFiles(e.target.files);
    });

    // Drag and drop functionality
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        handleInlineFiles(e.dataTransfer.files);
    });
}

function handleInlineFiles(files) {
    Array.from(files).forEach(file => {
        if (validateInlineFile(file)) {
            uploadInlineFile(file);
        }
    });
}

function validateInlineFile(file) {
    const allowedTypes = [
        'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'text/plain', 'image/png', 'image/jpeg', 'image/gif'
    ];

    const maxSize = 10 * 1024 * 1024; // 10MB

    if (!allowedTypes.includes(file.type)) {
        showToast('File type not supported: ' + file.name, 'error');
        return false;
    }

    if (file.size > maxSize) {
        showToast('File too large (max 10MB): ' + file.name, 'error');
        return false;
    }

    return true;
}

function uploadInlineFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('page_id', '{{ page.id }}');

    // Create file item in UI
    const fileId = 'inline_file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const fileItem = createInlineFileItem(fileId, file);

    const fileListContainer = document.getElementById('inlineFileListContainer');
    fileListContainer.appendChild(fileItem);
    document.getElementById('inlineFileList').style.display = 'block';

    // Upload file
    fetch('/api/upload', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            // Update file item with server data
            uploadedInlineFiles.push({
                id: data.id,
                filename: data.filename,
                original_filename: data.original_filename,
                url: data.url,
                download_url: data.download_url
            });
            updateInlineFileItem(fileId, file, data);
            showToast('File uploaded successfully: ' + file.name, 'success');
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        removeInlineFileItem(fileId);
        showToast('Failed to upload file: ' + file.name, 'error');
    });
}

function createInlineFileItem(fileId, file) {
    const fileItem = document.createElement('div');
    fileItem.className = 'list-group-item';
    fileItem.id = fileId;

    const fileIcon = getInlineFileIcon(file.type);
    const fileSize = formatInlineFileSize(file.size);

    fileItem.innerHTML = `
        <div class="file-info">
            <i class="file-icon ${fileIcon}"></i>
            <div class="file-details">
                <div class="file-name">${file.name}</div>
                <div class="file-size">${fileSize}</div>
            </div>
        </div>
        <div class="file-actions">
            <div class="upload-progress">
                <div class="upload-progress-bar"></div>
            </div>
            <button type="button" class="btn-remove-file" onclick="removeInlineFileItem('${fileId}')">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    return fileItem;
}

function updateInlineFileItem(fileId, file, data) {
    const fileItem = document.getElementById(fileId);
    if (fileItem) {
        const progressBar = fileItem.querySelector('.upload-progress-bar');
        if (progressBar) {
            progressBar.style.width = '100%';
            setTimeout(() => {
                progressBar.parentElement.style.display = 'none';
            }, 500);
        }
    }
}

function removeInlineFileItem(fileId) {
    const fileItem = document.getElementById(fileId);
    if (fileItem) {
        // Remove from uploaded files array
        uploadedInlineFiles = uploadedInlineFiles.filter(f => f.id !== fileId.replace('inline_file_', ''));
        fileItem.remove();

        // Hide file list if empty
        const fileListContainer = document.getElementById('inlineFileListContainer');
        if (fileListContainer.children.length === 0) {
            document.getElementById('inlineFileList').style.display = 'none';
        }
    }
}

function getInlineFileIcon(fileType) {
    if (fileType.includes('pdf')) return 'fas fa-file-pdf';
    if (fileType.includes('word') || fileType.includes('document')) return 'fas fa-file-word';
    if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel';
    if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'fas fa-file-powerpoint';
    if (fileType.includes('text')) return 'fas fa-file-alt';
    if (fileType.includes('image')) return 'fas fa-file-image';
    return 'fas fa-file';
}

function formatInlineFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function deletePage(pageId) {
    if (confirm('Are you sure you want to delete this page? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete/${pageId}`;

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;

        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function exportPage() {
    const title = '{{ page.title }}';
    const content = editor ? editor.getValue() : document.querySelector('.content-display').innerText;
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(`# ${title}\n\n${content}`));
    element.setAttribute('download', `${title}.md`);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

function printPage() {
    window.print();
}

// Load auto-saved draft on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedDraft = localStorage.getItem('page_draft_{{ page.id }}');
    if (savedDraft) {
        try {
            const draft = JSON.parse(savedDraft);
            if (confirm(`Restore unsaved draft from ${new Date(draft.timestamp).toLocaleString()}?`)) {
                if (editor) {
                    editor.setValue(draft.content);
                } else {
                    document.getElementById('markdownInput').value = draft.content;
                }
            }
        } catch (e) {
            console.error('Error loading draft:', e);
        }
    }
});

// Clear draft on save
document.addEventListener('DOMContentLoaded', function() {
    // Override the save functions to clear draft
    const originalSavePage = savePage;
    savePage = function() {
        originalSavePage();
        localStorage.removeItem('page_draft_{{ page.id }}');
    };
});
</script>

<style>
/* Breadcrumb Styles */
.page-breadcrumb {
    background: #f7f8f9;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px 16px;
}

.breadcrumb {
    background: none;
    padding: 0;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: "/";
    color: #64748b;
    font-weight: 400;
    margin: 0 8px;
}

.breadcrumb-link {
    color: #64748b;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.breadcrumb-link:hover {
    color: var(--primary-color);
    background: #e3f2fd;
    text-decoration: none;
}

.breadcrumb-link i {
    font-size: 12px;
}

.breadcrumb-current {
    color: #172b4d;
    font-weight: 500;
    padding: 4px 8px;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
}

/* Page Header Styles */
.page-header {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.page-header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    gap: 24px;
}

.page-title-section {
    flex: 1;
}

.page-title {
    font-size: 32px;
    font-weight: 600;
    color: #172b4d;
    margin: 0 0 12px 0;
    line-height: 1.2;
}

.page-status-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.status-badge.published {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-badge.draft {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid #e9ecef;
}

.status-badge.public {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.status-badge.private {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.status-badge.category {
    background: #e3f2fd;
    color: #1565c0;
    border: 1px solid #bbdefb;
}

.page-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: flex-start;
}

.page-meta {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    padding-top: 16px;
    border-top: 1px solid #e2e8f0;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #64748b;
    font-size: 14px;
}

.meta-item i {
    color: #a0aec0;
    font-size: 12px;
}

.meta-date {
    color: #a0aec0;
    font-size: 13px;
}

/* Button Styles */
.btn-wiki.danger {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
}

.btn-wiki.danger:hover {
    background: #c82333;
    border-color: #c82333;
}

/* Responsive Design */
@media (max-width: 768px) {
    .page-header-top {
        flex-direction: column;
        gap: 16px;
    }

    .page-title {
        font-size: 24px;
    }

    .page-actions {
        justify-content: flex-start;
        width: 100%;
    }

    .page-meta {
        gap: 16px;
    }

    .breadcrumb {
        flex-wrap: wrap;
    }
}

/* Fullscreen editor */
.content-editor.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    border-radius: 0;
}

.content-editor.fullscreen .editor-content {
    height: calc(100vh - 120px);
}

/* Editing mode styles */
.editing-mode .page-title:hover {
    background-color: #fffbe6;
    cursor: text;
}

/* File Upload Styles for Inline Edit */
.upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 30px 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background: var(--sidebar-bg);
}

.upload-zone:hover {
    border-color: var(--primary-color);
    background: #f8f9fa;
}

.upload-zone.dragover {
    border-color: var(--primary-color);
    background: #e3f2fd;
}

.upload-zone h6 {
    margin-bottom: 8px;
    font-size: 0.9em;
}

.file-list .list-group-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    margin-bottom: 6px;
    border-radius: 6px;
    font-size: 0.9em;
}

.file-info {
    display: flex;
    align-items: center;
    flex-grow: 1;
}

.file-icon {
    margin-right: 10px;
    font-size: 1.1em;
    color: var(--primary-color);
}

.file-details .file-name {
    font-weight: 500;
    margin-bottom: 1px;
    font-size: 0.85em;
}

.file-details .file-size {
    font-size: 0.75em;
    color: var(--text-secondary);
}

.file-actions {
    display: flex;
    gap: 6px;
}

.btn-remove-file {
    background: none;
    border: none;
    color: var(--danger-color);
    cursor: pointer;
    padding: 3px 6px;
    border-radius: 3px;
    transition: background-color 0.2s;
    font-size: 0.8em;
}

.btn-remove-file:hover {
    background-color: #ffebee;
}

.upload-progress {
    width: 100%;
    height: 3px;
    background: var(--border-color);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 6px;
}

.upload-progress-bar {
    height: 100%;
    background: var(--primary-color);
    width: 0%;
    transition: width 0.3s ease;
}

/* Print styles */
@media print {
    .wiki-header, .wiki-sidebar, .page-actions, .btn-wiki, .alert {
        display: none !important;
    }

    .wiki-main {
        margin-left: 0 !important;
        padding: 0 !important;
        max-width: 100% !important;
    }

    .content-display, .content-editor {
        border: none !important;
        box-shadow: none !important;
    }

    .page-content {
        font-size: 12pt;
        line-height: 1.4;
    }
}
</style>
{% endblock %}