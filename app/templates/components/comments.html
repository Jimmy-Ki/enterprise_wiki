<!-- è¯„è®ºç³»ç»Ÿç»„ä»¶ -->
<div class="comments-section" id="comments-section">
    <div class="comments-header">
        <h3 class="comments-title">
            <i class="fas fa-comments me-2"></i>è¯„è®º
        </h3>
        <span class="comments-count" id="comments-count">0</span>
    </div>

    <!-- è¯„è®ºè¡¨å• -->
    {% if current_user.is_authenticated %}
    <div class="comment-form">
        <form id="main-comment-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="d-flex align-items-start mb-3">
                <img src="{{ current_user.gravatar(size=40) or '/static/img/default-avatar.png' }}"
                     alt="{{ current_user.name or current_user.username }}"
                     class="comment-avatar me-3">
                <div class="flex-grow-1">
                    <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å·¥å…·æ  -->
                    <div class="comment-editor-toolbar">
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="bold" title="ç²—ä½“ (Ctrl+B)">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="italic" title="æ–œä½“ (Ctrl+I)">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="underline" title="ä¸‹åˆ’çº¿">
                                <i class="fas fa-underline"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="strikeThrough" title="åˆ é™¤çº¿">
                                <i class="fas fa-strikethrough"></i>
                            </button>
                        </div>

                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="insertUnorderedList" title="æ— åºåˆ—è¡¨">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="insertOrderedList" title="æœ‰åºåˆ—è¡¨">
                                <i class="fas fa-list-ol"></i>
                            </button>
                        </div>

                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="createLink" title="æ’å…¥é“¾æ¥">
                                <i class="fas fa-link"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="insertImage" title="æ’å…¥å›¾ç‰‡">
                                <i class="fas fa-image"></i>
                            </button>
                        </div>

                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="blockquote" title="å¼•ç”¨">
                                <i class="fas fa-quote-left"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="code" title="ä»£ç ">
                                <i class="fas fa-code"></i>
                            </button>
                        </div>

                        <!-- è¡¨æƒ…ç¬¦å·æŒ‰é’® -->
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn emoji-picker-btn" title="æ’å…¥è¡¨æƒ…">
                                <i class="fas fa-smile"></i>
                            </button>
                        </div>

                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="undo" title="æ’¤é”€">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="redo" title="é‡åš">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>

                    <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
                    <div class="comment-editor enhanced-editor" id="main-comment-editor" contenteditable="true"
                         data-placeholder="åˆ†äº«æ‚¨çš„æƒ³æ³•...ä½¿ç”¨@usernameæåŠç”¨æˆ·">
                    </div>

                    <!-- éšè—çš„textareaç”¨äºè¡¨å•æäº¤ -->
                    <textarea class="form-control comment-textarea"
                              id="main-comment-textarea"
                              style="display: none;"
                              required></textarea>

                    <div class="comment-meta">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <code>@username</code> æåŠç”¨æˆ· â€¢ æ”¯æŒMarkdown
                        </small>
                    </div>
                </div>
            </div>
            <div class="comment-actions">
                <button type="button" class="btn btn-outline-secondary btn-sm comment-preview-toggle">
                    <i class="fas fa-eye me-1"></i>é¢„è§ˆ
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm comment-markdown-toggle">
                    <i class="fas fa-code me-1"></i>Markdown
                </button>
                <button type="submit" class="btn btn-primary" id="main-comment-submit">
                    <i class="fas fa-paper-plane me-2"></i>å‘è¡¨è¯„è®º
                </button>
            </div>
        </form>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="comment-preview" id="main-comment-preview" style="display: none;">
            <h6>é¢„è§ˆï¼š</h6>
            <div id="main-comment-preview-content"></div>
        </div>

        <!-- è¡¨æƒ…ç¬¦å·é€‰æ‹©å™¨ -->
        <div class="emoji-picker" id="emoji-picker" style="display: none;">
            <div class="emoji-picker-header">
                <span class="emoji-picker-title">é€‰æ‹©è¡¨æƒ…</span>
                <button type="button" class="btn-close emoji-picker-close">&times;</button>
            </div>
            <div class="emoji-picker-tabs">
                <button class="emoji-tab active" data-category="smileys">ğŸ˜€</button>
                <button class="emoji-tab" data-category="people">ğŸ‘¥</button>
                <button class="emoji-tab" data-category="animals">ğŸ¶</button>
                <button class="emoji-tab" data-category="food">ğŸ”</button>
                <button class="emoji-tab" data-category="activities">âš½</button>
                <button class="emoji-tab" data-category="travel">ğŸš—</button>
                <button class="emoji-tab" data-category="objects">ğŸ’¡</button>
                <button class="emoji-tab" data-category="symbols">âš¡</button>
                <button class="emoji-tab" data-category="flags">ğŸš©</button>
            </div>
            <div class="emoji-picker-content">
                <!-- è¡¨æƒ…ç¬¦å·å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        è¯·<a href="{{ url_for('auth.login') }}">ç™»å½•</a>å‚ä¸è®¨è®ºã€‚
    </div>
    {% endif %}

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <div class="comments-list" id="comments-list">
        <div class="comments-loading">
            <div class="comments-spinner"></div>
            <div>åŠ è½½è¯„è®ºä¸­...</div>
        </div>
    </div>

    <!-- åˆ†é¡µ -->
    <div class="comments-pagination" id="comments-pagination">
        <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µ -->
    </div>
</div>

<!-- åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿçš„JavaScript -->
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ
    if (typeof window.initCommentSystem === 'function') {
        window.commentSystem = window.initCommentSystem({
            targetType: '{{ target_type }}',
            targetId: {{ target_id }},
            currentUser: {% if current_user.is_authenticated %}{
                id: {{ current_user.id }},
                username: '{{ current_user.username }}',
                name: '{{ current_user.name or current_user.username }}',
                avatar: '{{ current_user.gravatar(size=40) or '/static/img/default-avatar.png' }}'
            }{% else %}null{% endif %},
            apiBaseUrl: '',
            enableMentions: true,
            enablePreview: true,
            autoRefresh: true
        });

        // åŠ è½½è‰ç¨¿
        {% if current_user.is_authenticated %}
        const mainTextarea = document.getElementById('main-comment-textarea');
        if (mainTextarea && window.commentSystem) {
            window.commentSystem.loadDraft(mainTextarea);
        }
        {% endif %}
    }

    // æ·»åŠ CSS
    const commentCSS = document.createElement('link');
    commentCSS.rel = 'stylesheet';
    commentCSS.href = '/static/css/comment.css';
    document.head.appendChild(commentCSS);
});

// å…¨å±€å‡½æ•°ï¼šåˆ·æ–°è¯„è®º
window.refreshComments = function() {
    if (window.commentSystem) {
        window.commentSystem.loadComments(1);
    }
};


// å…¨å±€å‡½æ•°ï¼šæ»šåŠ¨åˆ°æŒ‡å®šè¯„è®º
window.scrollToComment = function(commentId) {
    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    if (commentElement) {
        commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        commentElement.classList.add('highlighted');
        setTimeout(() => {
            commentElement.classList.remove('highlighted');
        }, 3000);
    }
};

// æ·»åŠ é«˜äº®æ ·å¼
const style = document.createElement('style');
style.textContent = `
    .comment-item.highlighted {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding-left: 1rem;
        margin-left: -1rem;
        animation: highlightPulse 2s ease-in-out;
    }

    @keyframes highlightPulse {
        0% { background-color: #ffc107; }
        100% { background-color: #fff3cd; }
    }
`;
document.head.appendChild(style);
</script>

<!-- Enhanced Editor Component for Comments -->
{% include 'components/enhanced_editor.html' %}

<script>
// ä¸ºè¯„è®ºç¼–è¾‘å™¨æ·»åŠ ç‰¹æ®Šçš„å›¾ç‰‡ä¸Šä¼ å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
    const commentEditor = document.getElementById('main-comment-editor');
    if (commentEditor) {
        // æ·»åŠ å›¾ç‰‡ç²˜è´´åŠŸèƒ½åˆ°è¯„è®ºç¼–è¾‘å™¨
        commentEditor.addEventListener('paste', function(e) {
            const clipboardData = e.clipboardData || e.originalEvent.clipboardData;
            if (!clipboardData) return;

            const items = clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    EnhancedEditor.uploadImage(file);
                    return;
                }
            }
        });

        // æ·»åŠ æ‹–æ‹½åŠŸèƒ½åˆ°è¯„è®ºç¼–è¾‘å™¨
        commentEditor.addEventListener('dragover', function(e) {
            e.preventDefault();
            commentEditor.classList.add('drag-over');
        });

        commentEditor.addEventListener('dragleave', function(e) {
            e.preventDefault();
            commentEditor.classList.remove('drag-over');
        });

        commentEditor.addEventListener('drop', function(e) {
            e.preventDefault();
            commentEditor.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            Array.from(files).forEach(file => {
                if (EnhancedEditor.uploadConfig.allowedTypes.includes(file.type)) {
                    EnhancedEditor.uploadImage(file);
                }
            });
        });
    }
});
</script>