<!-- 评论系统组件 -->
<div class="comments-section" id="comments-section">
    <div class="comments-header">
        <h3 class="comments-title">
            <i class="fas fa-comments me-2"></i>评论
        </h3>
        <span class="comments-count" id="comments-count">0</span>
    </div>

    <!-- 评论表单 -->
    {% if current_user.is_authenticated %}
    <div class="comment-form">
        <form id="main-comment-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="d-flex align-items-start mb-3">
                <img src="{{ current_user.gravatar(size=40) or '/static/img/default-avatar.png' }}"
                     alt="{{ current_user.name or current_user.username }}"
                     class="comment-avatar me-3">
                <div class="flex-grow-1">
                    <!-- 富文本编辑器工具栏 -->
                    <div class="comment-editor-toolbar">
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="bold" title="粗体 (Ctrl+B)">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="italic" title="斜体 (Ctrl+I)">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="underline" title="下划线">
                                <i class="fas fa-underline"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="strikeThrough" title="删除线">
                                <i class="fas fa-strikethrough"></i>
                            </button>
                        </div>

                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="insertUnorderedList" title="无序列表">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="insertOrderedList" title="有序列表">
                                <i class="fas fa-list-ol"></i>
                            </button>
                        </div>

                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="createLink" title="插入链接">
                                <i class="fas fa-link"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="insertImage" title="插入图片">
                                <i class="fas fa-image"></i>
                            </button>
                        </div>

                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="blockquote" title="引用">
                                <i class="fas fa-quote-left"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="code" title="代码">
                                <i class="fas fa-code"></i>
                            </button>
                        </div>

                        <!-- 表情符号按钮 -->
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn emoji-picker-btn" title="插入表情">
                                <i class="fas fa-smile"></i>
                            </button>
                        </div>

                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="undo" title="撤销">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="redo" title="重做">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 富文本编辑器 -->
                    <div class="comment-editor" id="main-comment-editor" contenteditable="true"
                         data-placeholder="分享您的想法...使用@username提及用户">
                    </div>

                    <!-- 隐藏的textarea用于表单提交 -->
                    <textarea class="form-control comment-textarea"
                              id="main-comment-textarea"
                              style="display: none;"
                              required></textarea>

                    <div class="comment-meta">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <code>@username</code> 提及用户 • 支持Markdown
                        </small>
                    </div>
                </div>
            </div>
            <div class="comment-actions">
                <button type="button" class="btn btn-outline-secondary btn-sm comment-preview-toggle">
                    <i class="fas fa-eye me-1"></i>预览
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm comment-markdown-toggle">
                    <i class="fas fa-code me-1"></i>Markdown
                </button>
                <button type="submit" class="btn btn-primary" id="main-comment-submit">
                    <i class="fas fa-paper-plane me-2"></i>发表评论
                </button>
            </div>
        </form>

        <!-- 预览区域 -->
        <div class="comment-preview" id="main-comment-preview" style="display: none;">
            <h6>预览：</h6>
            <div id="main-comment-preview-content"></div>
        </div>

        <!-- 表情符号选择器 -->
        <div class="emoji-picker" id="emoji-picker" style="display: none;">
            <div class="emoji-picker-header">
                <span class="emoji-picker-title">选择表情</span>
                <button type="button" class="btn-close emoji-picker-close">&times;</button>
            </div>
            <div class="emoji-picker-tabs">
                <button class="emoji-tab active" data-category="smileys">😀</button>
                <button class="emoji-tab" data-category="people">👥</button>
                <button class="emoji-tab" data-category="animals">🐶</button>
                <button class="emoji-tab" data-category="food">🍔</button>
                <button class="emoji-tab" data-category="activities">⚽</button>
                <button class="emoji-tab" data-category="travel">🚗</button>
                <button class="emoji-tab" data-category="objects">💡</button>
                <button class="emoji-tab" data-category="symbols">⚡</button>
                <button class="emoji-tab" data-category="flags">🚩</button>
            </div>
            <div class="emoji-picker-content">
                <!-- 表情符号将动态加载 -->
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        请<a href="{{ url_for('auth.login') }}">登录</a>参与讨论。
    </div>
    {% endif %}

    <!-- 评论列表 -->
    <div class="comments-list" id="comments-list">
        <div class="comments-loading">
            <div class="comments-spinner"></div>
            <div>加载评论中...</div>
        </div>
    </div>

    <!-- 分页 -->
    <div class="comments-pagination" id="comments-pagination">
        <!-- 动态生成分页 -->
    </div>
</div>

<!-- 初始化评论系统的JavaScript -->
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // 初始化评论系统
    if (typeof window.initCommentSystem === 'function') {
        window.commentSystem = window.initCommentSystem({
            targetType: '{{ target_type }}',
            targetId: {{ target_id }},
            currentUser: {% if current_user.is_authenticated %}{
                id: {{ current_user.id }},
                username: '{{ current_user.username }}',
                name: '{{ current_user.name or current_user.username }}',
                avatar: '{{ current_user.gravatar(size=40) or '/static/img/default-avatar.png' }}'
            }{% else %}null{% endif %},
            apiBaseUrl: '',
            enableMentions: true,
            enablePreview: true,
            autoRefresh: true
        });

        // 加载草稿
        {% if current_user.is_authenticated %}
        const mainTextarea = document.getElementById('main-comment-textarea');
        if (mainTextarea && window.commentSystem) {
            window.commentSystem.loadDraft(mainTextarea);
        }
        {% endif %}
    }

    // 添加CSS
    const commentCSS = document.createElement('link');
    commentCSS.rel = 'stylesheet';
    commentCSS.href = '/static/css/comment.css';
    document.head.appendChild(commentCSS);
});

// 全局函数：刷新评论
window.refreshComments = function() {
    if (window.commentSystem) {
        window.commentSystem.loadComments(1);
    }
};


// 全局函数：滚动到指定评论
window.scrollToComment = function(commentId) {
    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    if (commentElement) {
        commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        commentElement.classList.add('highlighted');
        setTimeout(() => {
            commentElement.classList.remove('highlighted');
        }, 3000);
    }
};

// 添加高亮样式
const style = document.createElement('style');
style.textContent = `
    .comment-item.highlighted {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding-left: 1rem;
        margin-left: -1rem;
        animation: highlightPulse 2s ease-in-out;
    }

    @keyframes highlightPulse {
        0% { background-color: #ffc107; }
        100% { background-color: #fff3cd; }
    }
`;
document.head.appendChild(style);
</script>