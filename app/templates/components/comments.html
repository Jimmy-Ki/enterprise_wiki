<!-- ËØÑËÆ∫Á≥ªÁªüÁªÑ‰ª∂ -->
<div class="comments-section" id="comments-section">
    <div class="comments-header">
        <h3 class="comments-title">
            <i class="fas fa-comments me-2"></i>Comments
        </h3>
        <span class="comments-count" id="comments-count">0</span>
    </div>

    <!-- ËØÑËÆ∫Ë°®Âçï -->
    {% if current_user.is_authenticated %}
    <div class="comment-form">
        <form id="main-comment-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="d-flex align-items-start mb-3">
                <img src="{{ current_user.gravatar(size=40) or '/static/img/default-avatar.png' }}"
                     alt="{{ current_user.name or current_user.username }}"
                     class="comment-avatar me-3">
                <div class="flex-grow-1">
                    <!-- ÂØåÊñáÊú¨ÁºñËæëÂô®Â∑•ÂÖ∑Ê†è -->
                    <div class="comment-editor-toolbar">
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="bold" title="Bold (Ctrl+B)">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="italic" title="Italic (Ctrl+I)">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="underline" title="Underline">
                                <i class="fas fa-underline"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="strikeThrough" title="Strikethrough">
                                <i class="fas fa-strikethrough"></i>
                            </button>
                        </div>

                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="insertUnorderedList" title="Bullet List">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="insertOrderedList" title="Numbered List">
                                <i class="fas fa-list-ol"></i>
                            </button>
                        </div>

                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="createLink" title="Insert Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="insertImage" title="Insert Image">
                                <i class="fas fa-image"></i>
                            </button>
                        </div>

                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="blockquote" title="Blockquote">
                                <i class="fas fa-quote-left"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="code" title="Code">
                                <i class="fas fa-code"></i>
                            </button>
                        </div>

                        <!-- Ë°®ÊÉÖÁ¨¶Âè∑ÊåâÈíÆ -->
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn emoji-picker-btn" title="Insert Emoji">
                                <i class="fas fa-smile"></i>
                            </button>
                        </div>

                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="undo" title="Undo">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm toolbar-btn" data-command="redo" title="Redo">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ÂØåÊñáÊú¨ÁºñËæëÂô® -->
                    <div class="comment-editor" id="main-comment-editor" contenteditable="true"
                         data-placeholder="Share your thoughts... Use @username to mention users">
                    </div>

                    <!-- ÈöêËóèÁöÑtextareaÁî®‰∫éË°®ÂçïÊèê‰∫§ -->
                    <textarea class="form-control comment-textarea"
                              id="main-comment-textarea"
                              style="display: none;"
                              required></textarea>

                    <div class="comment-meta">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <code>@username</code> to mention users ‚Ä¢ Supports Markdown
                        </small>
                    </div>
                </div>
            </div>
            <div class="comment-actions">
                <button type="button" class="btn btn-outline-secondary btn-sm comment-preview-toggle">
                    <i class="fas fa-eye me-1"></i>Preview
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm comment-markdown-toggle">
                    <i class="fas fa-code me-1"></i>Markdown
                </button>
                <button type="submit" class="btn btn-primary" id="main-comment-submit">
                    <i class="fas fa-paper-plane me-2"></i>Post Comment
                </button>
            </div>
        </form>

        <!-- È¢ÑËßàÂå∫Âüü -->
        <div class="comment-preview" id="main-comment-preview" style="display: none;">
            <h6>Preview:</h6>
            <div id="main-comment-preview-content"></div>
        </div>

        <!-- Ë°®ÊÉÖÁ¨¶Âè∑ÈÄâÊã©Âô® -->
        <div class="emoji-picker" id="emoji-picker" style="display: none;">
            <div class="emoji-picker-header">
                <span class="emoji-picker-title">Select Emoji</span>
                <button type="button" class="btn-close emoji-picker-close">&times;</button>
            </div>
            <div class="emoji-picker-tabs">
                <button class="emoji-tab active" data-category="smileys">üòÄ</button>
                <button class="emoji-tab" data-category="people">üë•</button>
                <button class="emoji-tab" data-category="animals">üê∂</button>
                <button class="emoji-tab" data-category="food">üçî</button>
                <button class="emoji-tab" data-category="activities">‚öΩ</button>
                <button class="emoji-tab" data-category="travel">üöó</button>
                <button class="emoji-tab" data-category="objects">üí°</button>
                <button class="emoji-tab" data-category="symbols">‚ö°</button>
                <button class="emoji-tab" data-category="flags">üö©</button>
            </div>
            <div class="emoji-picker-content">
                <!-- Ë°®ÊÉÖÁ¨¶Âè∑Â∞ÜÂä®ÊÄÅÂä†ËΩΩ -->
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Please <a href="{{ url_for('auth.login') }}">sign in</a> to participate in the discussion.
    </div>
    {% endif %}

    <!-- ËØÑËÆ∫ÂàóË°® -->
    <div class="comments-list" id="comments-list">
        <div class="comments-loading">
            <div class="comments-spinner"></div>
            <div>Loading comments...</div>
        </div>
    </div>

    <!-- ÂàÜÈ°µ -->
    <div class="comments-pagination" id="comments-pagination">
        <!-- Âä®ÊÄÅÁîüÊàêÂàÜÈ°µ -->
    </div>
</div>

<!-- ÂàùÂßãÂåñËØÑËÆ∫Á≥ªÁªüÁöÑJavaScript -->
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // ÂàùÂßãÂåñËØÑËÆ∫Á≥ªÁªü
    if (typeof window.initCommentSystem === 'function') {
        window.commentSystem = window.initCommentSystem({
            targetType: '{{ target_type }}',
            targetId: {{ target_id }},
            currentUser: {% if current_user.is_authenticated %}{
                id: {{ current_user.id }},
                username: '{{ current_user.username }}',
                name: '{{ current_user.name or current_user.username }}',
                avatar: '{{ current_user.gravatar(size=40) or '/static/img/default-avatar.png' }}'
            }{% else %}null{% endif %},
            apiBaseUrl: '',
            enableMentions: true,
            enablePreview: true,
            autoRefresh: true
        });

        // Âä†ËΩΩËçâÁ®ø
        {% if current_user.is_authenticated %}
        const mainTextarea = document.getElementById('main-comment-textarea');
        if (mainTextarea && window.commentSystem) {
            window.commentSystem.loadDraft(mainTextarea);
        }
        {% endif %}
    }

    // Ê∑ªÂä†CSS
    const commentCSS = document.createElement('link');
    commentCSS.rel = 'stylesheet';
    commentCSS.href = '/static/css/comment.css';
    document.head.appendChild(commentCSS);
});

// ÂÖ®Â±ÄÂáΩÊï∞ÔºöÂà∑Êñ∞ËØÑËÆ∫
window.refreshComments = function() {
    if (window.commentSystem) {
        window.commentSystem.loadComments(1);
    }
};


// ÂÖ®Â±ÄÂáΩÊï∞ÔºöÊªöÂä®Âà∞ÊåáÂÆöËØÑËÆ∫
window.scrollToComment = function(commentId) {
    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    if (commentElement) {
        commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        commentElement.classList.add('highlighted');
        setTimeout(() => {
            commentElement.classList.remove('highlighted');
        }, 3000);
    }
};

// Ê∑ªÂä†È´ò‰∫ÆÊ†∑Âºè
const style = document.createElement('style');
style.textContent = `
    .comment-item.highlighted {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding-left: 1rem;
        margin-left: -1rem;
        animation: highlightPulse 2s ease-in-out;
    }

    @keyframes highlightPulse {
        0% { background-color: #ffc107; }
        100% { background-color: #fff3cd; }
    }
`;
document.head.appendChild(style);
</script>