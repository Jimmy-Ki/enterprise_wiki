{% extends "base_confluence.html" %}

{% block styles %}
<style>
    /* 头像编辑按钮样式 */
    .current-avatar-container {
        position: relative;
        display: inline-block;
    }

    .user-avatar-large.editable {
        cursor: pointer;
        transition: transform 0.2s ease;
        border: 3px solid transparent;
    }

    .user-avatar-large.editable:hover {
        transform: scale(1.05);
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .avatar-edit-btn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid white;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        cursor: pointer;
    }

    .current-avatar-container:hover .avatar-edit-btn {
        opacity: 1;
    }

    /* 头像编辑模态框 */
    .avatar-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .avatar-modal-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .modal-body {
        text-align: center;
    }

    .avatar-edit-section {
        margin: 20px 0;
        padding: 20px;
        text-align: center;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .avatar-edit-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #e9ecef;
    }

    .avatar-edit-tab {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
        flex: 1;
    }

    .avatar-edit-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    .avatar-edit-tab:hover {
        color: var(--primary-color);
        border-bottom-color: #e9ecef;
    }

    .avatar-edit-content {
        display: none;
        margin-top: 20px;
    }

    .avatar-actions {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 12px;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .avatar-modal-content {
            padding: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-lg-8">
        <!-- 用户信息卡片 -->
        <div class="user-info-card">
            <div class="avatar-section">
                <div class="current-avatar-container">
                    <img id="currentAvatar" src="{{ user.get_avatar() or '/static/img/default-avatar.png' }}"
                         alt="{{ user.username }}"
                         class="user-avatar-large {{ 'editable' if current_user and current_user.username == user.username else '' }}"
                         title="{{ '点击修改头像' if current_user and current_user.username == user.username else '' }}">
                </div>

                {% if current_user and current_user.username == user.username %}
                <button id="editAvatarBtn" class="avatar-edit-btn" title="修改头像">
                    <i class="fas fa-edit"></i>
                </button>
                {% endif %}
            </div>

            <div class="user-info">
                <div class="user-name">{{ user.name or user.username }}</div>
                <div class="user-email">{{ user.email }}</div>
                <div class="user-role">{{ user.role.name if user.role else '用户' }}</div>
            </div>
        </div>

        <!-- 头像编辑模态框 -->
        <div id="avatarEditModal" class="avatar-modal">
            <div class="avatar-modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改头像</h5>
                    <button type="button" class="btn-close" onclick="closeAvatarModal()" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">请选择修改方式：</p>

                    <div class="avatar-edit-tabs">
                        <button class="avatar-edit-tab active" onclick="showEditSection('upload')">
                            <i class="fas fa-upload me-1"></i>
                            上传图片
                        </button>
                        <button class="avatar-edit-tab" onclick="showEditSection('url')">
                            <i class="fas fa-link me-1"></i>
                            使用链接
                        </button>
                    </div>

                    <!-- 上传区域 -->
                    <div id="uploadEditSection" class="avatar-edit-content">
                        <div class="avatar-edit-upload-zone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>拖放图片到此处或点击选择</h5>
                            <input type="file" id="avatarFileInput" accept=".jpg,.jpeg,.png,.gif" style="display: none;">
                        </div>

                        <div class="avatar-actions">
                            <button class="btn btn-success" onclick="confirmEdit()">
                                <i class="fas fa-check me-1"></i>
                                桮认上传
                            </button>
                            <button class="btn btn-secondary" onclick="cancelEdit()">
                                <i class="fas fa-times me-1"></i>
                                取消
                            </button>
                        </div>
                    </div>

                    <!-- URL输入区域 -->
                    <div id="urlEditSection" class="avatar-edit-content" style="display: none;">
                        <div class="mb-3">
                            <label for="avatarUrlInput" class="form-label">头像链接</label>
                            <input type="url" id="avatarUrlInput" class="form-control"
                                   placeholder="请输入头像URL地址..."
                                   value="{{ user.avatar or '' }}">
                            <small class="form-text text-muted">支持图片链接地址（如：https://example.com/avatar.jpg）</small>
                        </div>

                        <div class="avatar-actions">
                            <button class="btn btn-success" onclick="confirmEdit()">
                                <i class="fas fa-check me-1"></i>
                                保存
                            </button>
                            <button class="btn btn-secondary" onclick="cancelEdit()">
                                <i class="fas fa-times me-1"></i>
                                取消
                            </button>
                            {% if user.avatar %}
                            <button class="btn btn-outline-danger" onclick="removeAvatar()">
                                <i class="fas fa-trash me-1"></i>
                                删除当前
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 简单的头像编辑功能
let currentEditSection = null;

function showEditSection(section) {
    // 更新标签状态
    document.querySelectorAll('.avatar-edit-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent.trim().includes(section));
    });

    // 显示对应的编辑区域
    document.getElementById('uploadEditSection').style.display = section === 'upload' ? 'block' : 'none';
    document.getElementById('urlEditSection').style.display = section === 'url' ? 'block' : 'none';

    currentEditSection = section;
}

function closeAvatarModal() {
    const modal = document.getElementById('avatarEditModal');
    modal.style.display = 'none';
}

function confirmEdit() {
    if (currentEditSection === 'upload') {
        uploadNewAvatar();
    } else if (currentEditSection === 'url') {
        updateAvatarUrl();
    }
}

function cancelEdit() {
    // 重置编辑区域
    showEditSection(currentEditSection);
}

function uploadNewAvatar() {
    const fileInput = document.getElementById('avatarFileInput');
    if (!fileInput || !fileInput.files || !fileInput.files[0]) {
        showToast('请先选择图片文件', 'error');
        return;
    }

    const file = fileInput.files[0];

    // 验证文件
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    if (!validTypes.includes(file.type)) {
        showToast('请选择有效的图片文件（JPG、PNG、GIF）', 'error');
        return;
    }

    // 验证文件大小（最大2MB）
    const maxSize = 2 * 1024 * 1024;
    if (file.size > maxSize) {
        showToast('图片文件过大，最大支持2MB', 'error');
        return;
    }

    // 显示进度
    window.uploadManager.show();

    const formData = new FormData();
    formData.append('avatar_url', '');
    formData.append('avatar_file', file);

    fetch('/api/user/{{ user.username }}/upload-avatar', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        window.uploadManager.hide();

        if (data.success) {
            showToast('头像上传成功！', 'success');
            document.getElementById('currentAvatar').src = data.avatar_url;
            closeAvatarModal();
        } else {
            showToast(data.error || '头像上传失败', 'error');
        }
    })
    .catch(error => {
        window.uploadManager.hide();
        showToast('上传失败，请稍后重试', 'error');
    });
}

function updateAvatarUrl() {
    const urlInput = document.getElementById('avatarUrlInput');
    const url = urlInput ? urlInput.value.trim() : '';

    if (!url) {
        showToast('请输入有效的头像URL', 'error');
        return;
    }

    fetch('/api/user/{{ user.username }}/update-avatar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({
            avatar_url: url
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('头像更新成功！', 'success');
            document.getElementById('currentAvatar').src = data.avatar_url;
            closeAvatarModal();
        } else {
            showToast(data.error || '头像更新失败', 'error');
        }
    })
    .catch(error => {
        showToast('更新失败，请稍后重试', 'error');
    });
}

function removeAvatar() {
    if (!confirm('确定要删除头像吗？')) return;

    fetch('/api/user/{{ user.username }}/remove-avatar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('头像删除成功', 'success');
            document.getElementById('currentAvatar').src = '/static/img/default-avatar.png';
            closeAvatarModal();
        } else {
            showToast(data.error || '头像删除失败', 'error');
        }
    })
    .catch(error => {
        showToast('删除失败，请稍后重试', 'error');
    });
}
</script>
{% endblock %}